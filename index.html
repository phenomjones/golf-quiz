
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ball Flight Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="app"></div>
    <script>
        // Simple state management
        let state = {
            user: null,
            showAuth: true,
            showLevelSelect: false,
            username: '',
            scenarioNumber: 1,
            currentCard: 1,
            selectedAnswer: null,
            showExplanation: false,
            isCorrect: null,
            difficulty: 1,
            showDifficultySelector: false,
            gambleAmount: 10,
            gambleMultiplier: 1,
            showGamble: false,
            currentScenarioData: null,
            aiQuestion: '',
            aiResponse: '',
            isAskingAI: false
        };

        const difficultyLevels = [
            { level: 1, name: "Beginner", description: "Basic club data only", baseReward: 10, cards: 1 },
            { level: 2, name: "Casual Golfer", description: "Basic club data with variation", baseReward: 15, cards: 1 },
            { level: 3, name: "Club Player", description: "Heel/toe impact added", baseReward: 25, cards: 2 },
            { level: 4, name: "Scratch Golfer", description: "More extreme heel/toe mishits", baseReward: 40, cards: 2 },
            { level: 5, name: "Advanced Amateur", description: "High/low face impact added", baseReward: 60, cards: 3 },
            { level: 6, name: "Mini-Tour Pro", description: "More severe high/low mishits", baseReward: 85, cards: 3 },
            { level: 7, name: "PGA Tour Player", description: "Wind conditions added", baseReward: 115, cards: 3 },
            { level: 8, name: "Tour Champion", description: "More complex wind patterns", baseReward: 150, cards: 3 },
            { level: 9, name: "Major Winner", description: "Lie conditions added", baseReward: 200, cards: 3 },
            { level: 10, name: "PGA Pro Master", description: "All conditions, extreme scenarios", baseReward: 300, cards: 3 }
        ];

        function generateScenario(diffLevel) {
            const baseClubSpeed = { driver: 105, wood: 95, iron: 85, wedge: 75 };
            const baseCarryDistance = { driver: 250, wood: 220, iron: 165, wedge: 120 };
            const clubs = diffLevel <= 2 ? ["7 Iron"] : 
                         diffLevel <= 5 ? ["Driver", "5 Wood", "7 Iron"] :
                         ["Driver", "3 Wood", "5 Iron", "7 Iron", "PW"];
            const club = clubs[Math.floor(Math.random() * clubs.length)];
            
            const clubType = club.includes("Driver") ? "driver" : 
                             club.includes("Wood") ? "wood" : 
                             club.includes("PW") ? "wedge" : "iron";
            
            const speedVariance = diffLevel % 2 === 0 ? 15 : 10;
            const angleVariance = diffLevel % 2 === 0 ? 6 : 4;
            
            let speed = baseClubSpeed[clubType] + (Math.random() * speedVariance - speedVariance/2);
            let carry = baseCarryDistance[clubType] + (Math.random() * (speedVariance * 2) - speedVariance);
            
            const minAngle = diffLevel <= 4 ? 1.5 : diffLevel <= 7 ? 0.8 : 0;
            
            let face = (Math.random() * angleVariance - angleVariance/2);
            if (Math.abs(face) < minAngle) face = face >= 0 ? minAngle : -minAngle;
            face = parseFloat(face.toFixed(1));
            
            let path = (Math.random() * (angleVariance + 2) - (angleVariance + 2)/2);
            if (Math.abs(path) < minAngle) path = path >= 0 ? minAngle : -minAngle;
            path = parseFloat(path.toFixed(1));
            
            let gearEffect = 0; // Will be set if impact location exists
            let windEffect = 0; // Will be set if wind exists
            let windDir = "";
            let impactLocationText = "";
            
            let faceDisplay = face + "Â°";
            let pathDisplay = path + "Â°";
            
            if (diffLevel <= 3) {
                faceDisplay += face > 0 ? " (right)" : face < 0 ? " (left)" : "";
                pathDisplay += path > 0 ? " (right)" : path < 0 ? " (left)" : "";
            } else if (diffLevel <= 5) {
                faceDisplay += face > 0 ? " (open)" : face < 0 ? " (closed)" : "";
                pathDisplay += path > 0 ? " (in-to-out)" : path < 0 ? " (out-to-in)" : "";
            }
            
            let data = {
                "Club / Speed / Carry": "ðŸŒï¸ " + club + " â€¢ " + speed.toFixed(1) + " mph â€¢ " + Math.round(carry) + " yards",
                "Club Face": "ðŸŽ¯ " + faceDisplay,
                "Club Path": "âž¡ï¸ " + pathDisplay
            };
            
            if (diffLevel >= 3) {
                const maxImpact = diffLevel === 3 ? 6 : 12;
                const impact = Math.random() * maxImpact - maxImpact/2;
                const impactSide = impact > 0 ? "toe" : "heel";
                data["Impact Location"] = "ðŸ“ " + Math.abs(impact).toFixed(1) + "mm " + impactSide;
                
                // Gear effect: heel creates draw spin (negative impact = negative gear effect = draw)
                // toe creates fade spin (positive impact = positive gear effect = fade)
                gearEffect = clubType === "driver" ? impact * 0.3 : impact * 0.15;
                impactLocationText = Math.abs(impact).toFixed(1) + "mm " + impactSide;
            }
            
            if (diffLevel >= 5) {
                data["Spin Loft"] = "ðŸ”„ " + (Math.random() * 8 + 10).toFixed(1) + "Â°";
            }
            
            if (diffLevel >= 7) {
                const windSpeed = Math.floor(Math.random() * (diffLevel === 7 ? 15 : 25) + 5);
                const windDirs = ["Headwind", "Tailwind", "Left-to-Right", "Right-to-Left"];
                windDir = windDirs[Math.floor(Math.random() * windDirs.length)];
                data["Wind"] = "ðŸ’¨ " + windSpeed + " mph " + windDir;
                
                // Wind effect on offline distance
                if (windDir === "Left-to-Right") windEffect = windSpeed * 0.3; // Push ball right
                else if (windDir === "Right-to-Left") windEffect = windSpeed * -0.3; // Push ball left
                // Headwind/tailwind affect distance but not lateral position as much
            }
            
            if (diffLevel >= 9) {
                const lies = ["Flat", "Uphill 3Â°", "Downhill 3Â°", "Ball above feet", "Ball below feet"];
                data["Lie"] = "â›°ï¸ " + lies[Math.floor(Math.random() * lies.length)];
            }

            const faceToPath = face - path + gearEffect; // Include gear effect!
            const startDir = face > 0 ? "right" : face < 0 ? "left" : "straight";
            
            // Determine shape
            const absFTP = Math.abs(faceToPath);
            const curveType = absFTP <= 1 ? "straight" : absFTP <= 3 ? "slight" : absFTP <= 6 ? "moderate" : absFTP <= 10 ? "heavy" : "extreme";
            const startType = Math.abs(face) <= 1 ? "straight" : face > 1 ? "push" : "pull";
            const isDrawCurve = faceToPath < 0;
            
            let shape = "Straight";
            let shapeDesc = "on target, no curve";
            
            if (curveType !== "straight") {
                const curveNames = {
                    slight: isDrawCurve ? ["Baby draw", "starts straight, slight curve left"] : ["Baby fade", "starts straight, slight curve right"],
                    moderate: isDrawCurve ? ["Draw", "starts straight, curves left"] : ["Fade", "starts straight, curves right"],
                    heavy: isDrawCurve ? ["Big draw", "starts straight, heavy curve left"] : ["Big fade", "starts straight, heavy curve right"],
                    extreme: isDrawCurve ? ["Hook", "starts straight, severe curve left"] : ["Slice", "starts straight, severe curve right"]
                };
                
                if (startType === "straight") {
                    [shape, shapeDesc] = curveNames[curveType];
                } else if (startType === "push") {
                    if (curveType === "slight") [shape, shapeDesc] = isDrawCurve ? ["Push-draw", "starts right, curves back left"] : ["Push-fade", "starts right, curves further right"];
                    else if (curveType === "moderate") [shape, shapeDesc] = isDrawCurve ? ["Push-draw", "starts right, curves back left"] : ["Push-fade", "starts right, curves further right"];
                    else if (curveType === "heavy") [shape, shapeDesc] = isDrawCurve ? ["Push-draw", "starts right, curves strongly back left"] : ["Push-slice", "starts right, curves severely right"];
                    else [shape, shapeDesc] = isDrawCurve ? ["Push-hook", "starts right, severe curve back left"] : ["Push-slice", "starts right, extreme curve right"];
                } else {
                    if (curveType === "slight" || curveType === "moderate") [shape, shapeDesc] = isDrawCurve ? ["Pull-hook", "starts left, curves further left"] : ["Pull-fade", "starts left, curves back right"];
                    else [shape, shapeDesc] = isDrawCurve ? ["Pull-hook", "starts left, curves severely left"] : ["Pull-slice", "starts left, curves strongly back right"];
                }
            } else {
                if (startType === "push") [shape, shapeDesc] = ["Push", "starts right, flies straight"];
                else if (startType === "pull") [shape, shapeDesc] = ["Pull", "starts left, flies straight"];
            }

            const cards = [];
            const allShapes = ["Straight", "Push", "Pull", "Baby draw", "Baby fade", "Draw", "Fade", "Big draw", "Big fade", "Hook", "Slice", "Push-draw", "Push-fade", "Push-hook", "Push-slice", "Pull-hook", "Pull-fade", "Pull-slice"];
            const wrongShapes = allShapes.filter(s => s !== shape).sort(() => Math.random() - 0.5).slice(0, 3);
            const options = [shape, ...wrongShapes].sort(() => Math.random() - 0.5);
            
            // Always show descriptions for all levels
            const optionsWithDescriptions = options.map(o => o + " (" + getShapeDesc(o) + ")");
            
            // Build explanation for Card 1 (shot shape)
            let card1Explanation = `Face: ${face}Â°, Path: ${path}Â°, Face-to-path: ${(face - path).toFixed(1)}Â°.`;
            if (gearEffect !== 0) {
                const gearDir = gearEffect > 0 ? "fade" : "draw";
                card1Explanation += ` ${impactLocationText} impact adds ${Math.abs(gearEffect).toFixed(1)}Â° of ${gearDir} spin (gear effect). Total face-to-path with gear effect: ${faceToPath.toFixed(1)}Â°.`;
            }
            card1Explanation += ` Result: ${shape}.`;
            
            cards.push({
                question: "What will be the shot shape?",
                options: optionsWithDescriptions,
                correct: shape + " (" + shapeDesc + ")",
                correctBase: shape,
                explanation: card1Explanation
            });
            
            if (diffLevel >= 3) {
                cards.push({
                    question: "Will the ball start left or right of the target?",
                    options: ["Left of target", "Right of target", "Straight at target"],
                    correct: face < -0.5 ? "Left of target" : face > 0.5 ? "Right of target" : "Straight at target",
                    explanation: `With face angle ${face}Â°, the ball starts ${startDir} (75-85% influence from face angle).`
                });
            }
            
            if (diffLevel >= 5) {
                // Calculate components
                const faceContribution = Math.abs(face * 3);
                const pathContribution = Math.abs(faceToPath * 5);
                const totalBeforeWind = faceContribution + pathContribution;
                const offlineYards = totalBeforeWind + windEffect;
                const offlineDir = (face + (faceToPath * 0.3) + windEffect * 0.1) > 0 ? "right" : "left";
                
                let opts, corr;
                
                if (diffLevel <= 6) {
                    opts = [
                        `0-9 yards ${offlineDir}`,
                        `10-19 yards ${offlineDir}`,
                        `20-34 yards ${offlineDir}`,
                        `35+ yards ${offlineDir}`
                    ];
                    corr = offlineYards < 10 ? opts[0] : offlineYards < 20 ? opts[1] : offlineYards < 35 ? opts[2] : opts[3];
                } else if (diffLevel <= 8) {
                    opts = [
                        `0-7 yards ${offlineDir}`,
                        `8-14 yards ${offlineDir}`,
                        `15-24 yards ${offlineDir}`,
                        `25+ yards ${offlineDir}`
                    ];
                    corr = offlineYards < 8 ? opts[0] : offlineYards < 15 ? opts[1] : offlineYards < 25 ? opts[2] : opts[3];
                } else {
                    const ry = Math.round(offlineYards);
                    opts = [
                        `${Math.max(0, ry - 3)}-${ry + 1} yards ${offlineDir}`,
                        `${ry + 2}-${ry + 6} yards ${offlineDir}`,
                        `${Math.max(0, ry - 8)}-${Math.max(0, ry - 4)} yards ${offlineDir}`,
                        `${ry + 7}+ yards ${offlineDir}`
                    ];
                    corr = opts[0];
                }
                
                // Build detailed calculation explanation
                let calcParts = [];
                calcParts.push(`Face angle ${face}Â° contributes ~${faceContribution.toFixed(0)} yards ${face > 0 ? 'right' : 'left'}`);
                calcParts.push(`Face-to-path ${faceToPath.toFixed(1)}Â° (${faceToPath < 0 ? 'draw' : 'fade'}) adds ~${pathContribution.toFixed(0)} yards of curve`);
                
                if (gearEffect !== 0) {
                    const gearYards = Math.abs(gearEffect * 3);
                    const gearDir = gearEffect > 0 ? "fade (right)" : "draw (left)";
                    calcParts.push(`${impactLocationText} creates ${Math.abs(gearEffect).toFixed(1)}Â° gear effect = ~${gearYards.toFixed(0)} yards ${gearDir}`);
                }
                
                if (windEffect !== 0) {
                    calcParts.push(`${windDir} wind pushes ~${Math.abs(windEffect).toFixed(0)} yards ${windEffect > 0 ? 'right' : 'left'}`);
                }
                
                calcParts.push(`Total: ~${Math.floor(offlineYards)} yards ${offlineDir}`);
                
                cards.push({
                    question: "How far offline will the ball finish from the target?",
                    options: opts,
                    correct: corr,
                    explanation: calcParts.join('. ') + '.'
                });
            }
            
            return { data, cards };
        }

        function getShapeDesc(name) {
            const descs = {
                "Straight": "on target, no curve", "Push": "starts right, flies straight", "Pull": "starts left, flies straight",
                "Baby draw": "slight curve left", "Baby fade": "slight curve right",
                "Draw": "curves left", "Fade": "curves right",
                "Big draw": "heavy curve left", "Big fade": "heavy curve right",
                "Hook": "severe curve left", "Slice": "severe curve right",
                "Push-draw": "starts right, curves left", "Push-fade": "starts right, curves right",
                "Push-hook": "starts right, severe curve left", "Push-slice": "starts right, extreme curve right",
                "Pull-hook": "starts left, curves left", "Pull-fade": "starts left, curves right",
                "Pull-slice": "starts left, severe curve right"
            };
            return descs[name] || name;
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.showAuth) {
                app.innerHTML = `
                    <div class="min-h-screen bg-gradient-to-br from-green-900 via-blue-900 to-purple-900 p-6 flex items-center justify-center">
                        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full">
                            <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 rounded-t-lg">
                                <h1 class="text-3xl font-bold text-center">Ball Flight Master</h1>
                            </div>
                            <div class="p-8">
                                <div class="text-center mb-6">
                                    <div class="text-6xl mb-4">ðŸŽ¯</div>
                                    <p class="text-gray-600 mb-6">Master the physics of golf ball flight</p>
                                </div>
                                <input type="text" id="username" value="${state.username}" 
                                    placeholder="Enter your username" 
                                    class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-lg">
                                <button onclick="handleLogin()" 
                                    class="w-full py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg font-semibold text-lg hover:from-green-700 hover:to-blue-700">
                                    Start Playing
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            document.getElementById('username').addEventListener('input', e => {
                state.username = e.target.value;
            });
            return;
            }

            if (!state.currentScenarioData) return;

            const totalCards = difficultyLevels[state.difficulty - 1].cards;
            const card = state.currentScenarioData.cards[state.currentCard - 1];
            const accuracy = state.user.questionsAnswered > 0 ? Math.round((state.user.correctAnswers / state.user.questionsAnswered) * 100) : 0;

            let dataHTML = '';
            for (let [key, value] of Object.entries(state.currentScenarioData.data)) {
                dataHTML += `
                    <div class="bg-white p-3 rounded-lg shadow-sm">
                        <div class="font-semibold text-gray-700 mb-1">${key}</div>
                        <p class="text-gray-900">${value}</p>
                    </div>
                `;
            }

            let optionsHTML = '';
            card.options.forEach((opt, idx) => {
                let btnClass = "w-full text-left p-4 rounded-lg border-2 transition-all font-medium";
                if (!state.showExplanation) {
                    btnClass += state.selectedAnswer === opt ? " border-blue-600 bg-blue-50" : " border-gray-300 bg-white hover:border-blue-300";
                } else {
                    const isCorrect = card.correctBase ? opt.split(' (')[0] === card.correctBase : opt === card.correct;
                    if (isCorrect) btnClass += " border-green-600 bg-green-50";
                    else if (opt === state.selectedAnswer) btnClass += " border-red-600 bg-red-50";
                    else btnClass += " border-gray-300 bg-gray-100 opacity-60";
                }
                
                optionsHTML += `
                    <button onclick="handleAnswer('${opt.replace(/'/g, "\\'")}')" 
                        ${state.showExplanation ? 'disabled' : ''}
                        class="${btnClass}">
                        ${opt}
                        ${state.showExplanation && (card.correctBase ? opt.split(' (')[0] === card.correctBase : opt === card.correct) ? ' âœ“' : ''}
                        ${state.showExplanation && opt === state.selectedAnswer && !(card.correctBase ? opt.split(' (')[0] === card.correctBase : opt === card.correct) ? ' âœ—' : ''}
                    </button>
                `;
            });

            app.innerHTML = `
                <div class="min-h-screen bg-gradient-to-br from-green-900 via-blue-900 to-purple-900 p-6">
                    <div class="max-w-5xl mx-auto">
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="bg-gradient-to-br from-yellow-400 to-orange-500 text-white shadow-lg rounded-lg p-4 text-center">
                                <p class="text-sm opacity-90">Tokens</p>
                                <p class="text-2xl font-bold">${state.user.tokens}</p>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white shadow-lg rounded-lg p-4 text-center">
                                <p class="text-sm opacity-90">Accuracy</p>
                                <p class="text-2xl font-bold">${accuracy}%</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-teal-500 text-white shadow-lg rounded-lg p-4 text-center">
                                <p class="text-sm opacity-90">Correct</p>
                                <p class="text-2xl font-bold">${state.user.correctAnswers}</p>
                            </div>
                            <div class="bg-gradient-to-br from-blue-500 to-indigo-500 text-white shadow-lg rounded-lg p-4 text-center">
                                <p class="text-sm opacity-90">Streak</p>
                                <p class="text-2xl font-bold">${state.user.currentStreak} ðŸ”¥</p>
                            </div>
                        </div>

                        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg">Level ${state.difficulty} - ${difficultyLevels[state.difficulty - 1].name}</h3>
                                    <p class="text-sm text-gray-600">${difficultyLevels[state.difficulty - 1].description}</p>
                                </div>
                                <button onclick="toggleDifficulty()" class="px-4 py-2 bg-blue-600 text-white rounded-lg">
                                    Change Level
                                </button>
                            </div>
                            ${state.showDifficultySelector ? `
                                <div class="mt-4">
                                    <input type="range" min="1" max="10" value="${state.difficulty}" 
                                        oninput="changeDifficulty(this.value)" class="w-full">
                                    <div class="flex justify-between text-xs text-gray-600 mt-2">
                                        ${difficultyLevels.map(d => `<span class="${d.level === state.difficulty ? 'font-bold text-blue-600' : ''}">${d.level}</span>`).join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="bg-white rounded-lg shadow-2xl">
                            <div class="bg-gradient-to-r from-green-600 to-blue-600 text-white p-6 rounded-t-lg">
                                <h2 class="text-2xl font-bold">Level ${state.difficulty} â€¢ Scenario #${state.scenarioNumber} â€¢ Card ${state.currentCard} of ${totalCards}</h2>
                                <p class="text-green-100">Base Reward: ${difficultyLevels[state.difficulty - 1].baseReward} tokens</p>
                            </div>
                            <div class="p-6">
                                <div class="bg-gradient-to-br from-gray-50 to-gray-100 p-6 rounded-lg mb-6 border-2 border-gray-300">
                                    <h3 class="font-bold text-xl mb-4">TrackMan Data:</h3>
                                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3">
                                        ${dataHTML}
                                    </div>
                                </div>

                                <h3 class="font-bold text-2xl mb-4">${card.question}</h3>

                                <div class="space-y-3 mb-6">
                                    ${optionsHTML}
                                </div>

                                ${state.showExplanation ? `
                                    <div class="p-4 rounded-lg mb-4 ${state.isCorrect ? 'bg-green-50 border-2 border-green-500' : 'bg-red-50 border-2 border-red-500'}">
                                        <p class="font-bold text-lg">
                                            ${state.isCorrect ? 'âœ“ Correct! +' + (difficultyLevels[state.difficulty - 1].baseReward * (state.showGamble ? state.gambleAmount / 10 : 1)) + ' tokens' : 'âœ— Wrong!'}
                                        </p>
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-300 mb-4">
                                        <h4 class="font-bold text-blue-900 mb-2">Explanation:</h4>
                                        <p>${card.explanation}</p>
                                    </div>
                                    
                                    <div class="mb-4 p-4 bg-purple-50 border-2 border-purple-300 rounded-lg">
                                        <h4 class="font-bold text-purple-900 mb-3 flex items-center gap-2">
                                            ðŸ’¬ Ask AI About This Scenario
                                        </h4>
                                        <div class="flex gap-2 mb-3">
                                            <input type="text" id="aiQuestion" value="${state.aiQuestion}" 
                                                placeholder="Ask about the physics or data..." 
                                                class="flex-1 p-3 border-2 border-purple-200 rounded-lg"
                                                ${state.isAskingAI ? 'disabled' : ''}>
                                            <button onclick="handleAskAI()" 
                                                ${state.isAskingAI || !state.aiQuestion || state.aiQuestion.trim() === '' ? 'disabled' : ''}
                                                class="px-6 py-3 bg-purple-600 text-white rounded-lg font-semibold hover:bg-purple-700 disabled:bg-gray-400">
                                                ${state.isAskingAI ? 'Asking...' : 'Ask'}
                                            </button>
                                        </div>
                                        ${state.aiResponse ? `
                                            <div class="bg-white p-4 rounded-lg border-2 border-purple-200">
                                                <p class="text-gray-700 whitespace-pre-wrap">${state.aiResponse}</p>
                                            </div>
                                        ` : ''}
                                    </div>
                                    
                                    <button onclick="handleNext()" 
                                        class="w-full py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg font-semibold text-lg">
                                        ${state.currentCard < totalCards ? `Next Card (${state.currentCard + 1} of ${totalCards})` : 'Next Scenario'}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Add event listener for AI question input
            if (state.showExplanation) {
                const aiInput = document.getElementById('aiQuestion');
                if (aiInput) {
                    aiInput.addEventListener('input', e => {
                        state.aiQuestion = e.target.value;
                    });
                }
            }
        }

        function handleLogin() {
            if (state.username.trim()) {
                state.user = {
                    name: state.username,
                    tokens: 100,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    currentStreak: 0
                };
                state.showAuth = false;
                state.currentScenarioData = generateScenario(state.difficulty);
                render();
            }
        }

        function handleAnswer(answer) {
            state.selectedAnswer = answer;
            const card = state.currentScenarioData.cards[state.currentCard - 1];
            state.isCorrect = card.correctBase ? answer.split(' (')[0] === card.correctBase : answer === card.correct;
            state.showExplanation = true;
            render();
        }

        function handleNext() {
            const totalCards = difficultyLevels[state.difficulty - 1].cards;
            const baseReward = difficultyLevels[state.difficulty - 1].baseReward;
            const reward = state.isCorrect ? baseReward : 0;
            
            state.user.tokens = Math.max(0, state.user.tokens + reward);
            state.user.questionsAnswered++;
            state.user.correctAnswers += state.isCorrect ? 1 : 0;
            state.user.currentStreak = state.isCorrect ? state.user.currentStreak + 1 : 0;
            
            if (state.currentCard < totalCards) {
                state.currentCard++;
            } else {
                state.scenarioNumber++;
                state.currentCard = 1;
                state.currentScenarioData = generateScenario(state.difficulty);
            }
            
            state.selectedAnswer = null;
            state.showExplanation = false;
            state.isCorrect = null;
            state.aiQuestion = '';
            state.aiResponse = '';
            render();
        }

        async function handleAskAI() {
            if (!state.aiQuestion || !state.aiQuestion.trim() || !state.currentScenarioData) return;
            
            state.isAskingAI = true;
            render();
            
            try {
                const card = state.currentScenarioData.cards[state.currentCard - 1];
                const dataStr = Object.entries(state.currentScenarioData.data)
                    .map(([key, value]) => key + ": " + value)
                    .join('\n');
                
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `You are a golf physics expert helping a student understand ball flight. Here is the current scenario data:\n\n${dataStr}\n\nCurrent Question: ${card.question}\n\nStudent's Question: ${state.aiQuestion}\n\nProvide a helpful, educational response that explains the physics concepts without directly giving away the answer. Help them understand how to think about the problem.`
                        }],
                    })
                });

                const data = await response.json();
                const aiText = data.content?.find(item => item.type === "text")?.text || "I couldn't generate a response. Please try again.";
                state.aiResponse = aiText;
            } catch (error) {
                state.aiResponse = "Sorry, I encountered an error. The AI feature requires an API key to work when self-hosted.";
            } finally {
                state.isAskingAI = false;
                render();
            }
        }

        function toggleDifficulty() {
            state.showDifficultySelector = !state.showDifficultySelector;
            render();
        }

        function changeDifficulty(level) {
            state.difficulty = parseInt(level);
            state.currentScenarioData = generateScenario(state.difficulty);
            state.currentCard = 1;
            state.scenarioNumber = 1;
            state.selectedAnswer = null;
            state.showExplanation = false;
            render();
        }

        // Initial render
        render();
    </script>
</body>
</html>
