
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ball Flight Master</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        :root {
            --augusta-green: #006747;
            --augusta-dark: #004d35;
            --masters-gold: #D4AF37;
        }
        
        body { 
            margin: 0; 
            font-family: system-ui, -apple-system, sans-serif;
        }
        
        .hint-fade { 
            color: #9ca3af; 
            font-size: 0.875rem; 
            opacity: 0.7;
            font-style: italic;
        }
        
        .golf-bg {
            background: var(--bg-image);
            background-size: cover;
            background-position: center;
            background-attachment: fixed;
            position: relative;
            min-height: 100vh;
        }
        
        .golf-bg::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.4);
            z-index: 0;
        }
        
        .golf-bg > * {
            position: relative;
            z-index: 1;
        }
        
        .shot-description {
            font-size: 0.875rem;
            color: #6b7280;
            font-style: italic;
            margin-top: 0.25rem;
        }
        
        .data-card {
            position: relative;
            cursor: help;
        }
        
        .data-card .tooltip {
            visibility: hidden;
            position: absolute;
            z-index: 100;
            bottom: 125%;
            left: 50%;
            transform: translateX(-50%);
            background-color: #1f2937;
            color: white;
            padding: 8px 12px;
            border-radius: 6px;
            font-size: 0.875rem;
            white-space: normal;
            width: 250px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.3);
        }
        
        .data-card:hover .tooltip {
            visibility: visible;
        }
        
        .tutorial-modal {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0,0,0,0.8);
            z-index: 1000;
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }
        
        .tutorial-content {
            background: white;
            border-radius: 12px;
            max-width: 800px;
            max-height: 90vh;
            overflow-y: auto;
            padding: 30px;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        @keyframes bounceIn {
            0% { 
                transform: scale(0.3);
                opacity: 0;
            }
            50% { 
                transform: scale(1.05);
            }
            70% { 
                transform: scale(0.9);
            }
            100% { 
                transform: scale(1);
                opacity: 1;
            }
        }
        
        /* üèÄ‚ú® NEON BASKETBALL: Momentum celebration animations */
        @keyframes momentumCelebrate {
            0% { 
                transform: scale(1);
            }
            25% { 
                transform: scale(1.2) rotate(-5deg);
            }
            50% { 
                transform: scale(1.3) rotate(5deg);
            }
            75% { 
                transform: scale(1.2) rotate(-5deg);
            }
            100% { 
                transform: scale(1);
            }
        }
        
        @keyframes sparkle {
            0%, 100% { 
                opacity: 0;
                transform: scale(0) rotate(0deg);
            }
            50% { 
                opacity: 1;
                transform: scale(1) rotate(180deg);
            }
        }
        
        @keyframes glow {
            0%, 100% {
                box-shadow: 0 0 5px rgba(255, 215, 0, 0.5);
            }
            50% {
                box-shadow: 0 0 20px rgba(255, 215, 0, 1), 0 0 30px rgba(255, 215, 0, 0.8);
            }
        }
        
        .momentum-celebrate {
            animation: momentumCelebrate 0.6s ease-in-out, glow 1s ease-in-out 3;
        }
        
        .momentum-sparkle {
            animation: sparkle 0.8s ease-out;
        }
        
        .animate-fade-in {
            animation: fadeIn 0.3s ease-out;
        }
        
        .animate-bounce-in {
            animation: bounceIn 0.6s cubic-bezier(0.68, -0.55, 0.265, 1.55);
        }
    </style>
    <script>
        // Augusta 12th hole background for all screens
        // Green gradient fallback if image fails to load
        const augustaBackground = '/mnt/user-data/uploads/ChatGPT_Image_Jan_24__2026__07_18_56_PM.png';
        document.documentElement.style.setProperty('--bg-image', 
            `linear-gradient(135deg, #2d7a4f 0%, #1a5c3f 25%, #0f4229 50%, #1a5c3f 75%, #2d7a4f 100%), url('${augustaBackground}')`
        );
    </script>
</head>
<body>
    <div id="app"></div>
    <script>
        // VERSION INFO
        const APP_VERSION = "v3.22.3 - February 2, 2026 - 6:18 PM EST - SYNTAX FIX (Really fixed duplicate brace this time!)";
        
        // Simple state management
        let state = {
            user: null,
            showAuth: true,
            showLevelSelect: false,
            username: '',
            scenarioNumber: 1,
            currentCard: 1,
            selectedAnswer: null,
            showExplanation: false,
            isCorrect: null,
            difficulty: 1,
            showDifficultySelector: false,
            currentScenarioData: null,
            showConfidenceBoost: false,
            confidenceMultiplier: 1,
            hasUsedBoost: false,
            boostCountdown: 20,
            boostTimer: null,
            boostCardResults: [], // Track card results for multi-card scenarios
            boostLost: false,
            showLevelModal: false,
            showTutorial: false,
            tutorialLevel: null, // Which level's tutorial to show
            tutorialsShown: [], // Track which level tutorials have been shown
            tutorialStep: 0, // üåàüé∏ RAINBOW GUITAR: Current step in multi-step tutorial
            tutorialSliderValues: {}, // üåàüé∏ RAINBOW GUITAR: Values for interactive sliders
            levelPerformance: {}, // Track stats per level: { 1: { scenarios: 15, correct: 42, total: 45, recent: [3,2,3,3,2] }, ... }
            showLevelUpPromotion: false,
            promotionTargetLevel: null,
            perfectScenariosLevel5: 0, // Track perfect scenarios on Level 5 for secret unlock
            totalPerfectScenarios: 0, // ü•ú PEANUT BUTTER: Track all perfect scenarios across all levels for sharing
            secretLevelUnlocked: false, // Has Grand Slam Winner been unlocked?
            showSecretUnlock: false, // Show unlock animation
            showShareModal: false, // Show share to Twitter modal
            showLevel6CompleteModal: false, // ü•ú PEANUT BUTTER: Show Level 6 completion share modal
            showOnboarding: false, // Show first-time user onboarding
            isFirstTime: true, // First time playing
            effectiveFaceShown: false, // Has effective face been shown in this scenario
            
            // MOMENTUM PROGRESSION SYSTEM
            levelProgress: {
                progressPercent: 0, // 0-100, only goes UP
                momentum: 1, // 1-5 flames (current streak multiplier)
                currentStreak: 0, // Current correct answer streak
                longestStreak: 0, // Best streak this level
                questionsAnswered: 0, // Total on this level
                questionsCorrect: 0, // Total correct on this level
                questionTypeMastery: {}, // {questionType: timesCorrect}
                questionTypesBonused: [], // One-time 10% bonuses claimed
                readyForNextLevel: false,
                hasBeenAskedToAdvance: false,
                timesDeclined: 0,
                scenariosSinceLastAsk: 0
            }
        };

        const difficultyLevels = [
            { level: 1, name: "Range Rookie", description: "Master face-to-path basics", baseReward: 25, cards: 3, details: "Learn the fundamentals. NEW DATA: Face angle, Club path. Questions: Curve direction, Face-to-path angle. Full hints provided.", unlockRequirement: "Start here" },
            { level: 2, name: "Tour Player", description: "Add gear effect", baseReward: 60, cards: 3, details: "Off-center hits matter! NEW DATA: Horizontal impact location (heel/toe only). Toe hits create draw spin, heel hits create fade spin. Questions: Start direction added.", unlockRequirement: "Complete Level 1" },
            { level: 3, name: "Major Contender", description: "Vertical impact & distance", baseReward: 115, cards: 3, details: "Master all gear effects. NEW DATA: Vertical impact location (high/low on face). High amplifies curve, low dampens. Questions: Offline distance (wider ranges).", unlockRequirement: "Complete Level 2" },
            { level: 4, name: "Championship Level", description: "Lie angle effects", baseReward: 200, cards: 3, details: "Environmental factors! NEW DATA: Lie angle. Upright closes face, flat opens. Questions: Gear help/hurt, Lie effect direction, Net face-to-path, Offline distance, Hypotheticals. No hints!", unlockRequirement: "Complete Level 3" },
            { level: 5, name: "Masters Champion", description: "Wind & ultimate challenge", baseReward: 350, cards: 3, details: "NEW DATA: Wind conditions. Headwind amplifies curve, tailwind dampens. Questions: Opposing forces, Best variable to change, Rank by impact, Advanced hypotheticals. Perfect scenarios may unlock something special... Wrong answers cost 100% of base reward!", unlockRequirement: "Complete Level 4" },
            { level: 6, name: "Grand Slam Winner", description: "üèÜ SECRET BOSS LEVEL üèÜ", baseReward: 1500, cards: 4, details: "LEGENDARY: Extreme conditions (25mph winds, 20mm impacts, 5¬∞ lie angles). 50% trick scenarios. 4 cards per scenario. Triple rewards. 2-yard answer tolerances. Only the true masters survive.", unlockRequirement: "Complete 4 PERFECT scenarios on Level 5", isSecret: true, isUnlocked: false }
        ];

        const shotShapeDescriptions = {
            "Straight": "starts on target, flies straight",
            "Push": "starts right, flies straight",
            "Pull": "starts left, flies straight",
            "Draw": "starts on target, curves left",
            "Fade": "starts on target, curves right",
            "Hook": "starts on target, curves severely left",
            "Slice": "starts on target, curves severely right",
            "Push-draw": "starts right, curves left",
            "Push-fade": "starts right, curves right",
            "Push-hook": "starts right, curves severely left",
            "Push-slice": "starts right, curves severely right",
            "Pull-draw": "starts left, curves left",
            "Pull-fade": "starts left, curves right",
            "Pull-hook": "starts left, curves severely left",
            "Pull-slice": "starts left, curves severely right"
        };
        
        function getDataTooltips(diffLevel) {
            const isHighLevel = diffLevel >= 7;
            
            if (isHighLevel) {
                // Simplified tooltips for advanced players (Level 7+)
                return {
                    "Club / Club Speed / Carry": "The club, clubhead speed, and carry distance",
                    "Club / Club Speed / Carry (after wind)": "Carry distance adjusted for wind",
                    "Club Face": "Direction the clubface points at impact",
                    "Club Path": "Direction the club is swinging",
                    "Impact Location": "Where ball strikes the face",
                    "Lie Angle": "Club's lie angle at impact",
                    "Wind": "Wind conditions affecting the shot"
                };
            } else {
                // Detailed tooltips for beginners (Level 1-6)
                return {
                    "Club / Club Speed / Carry": "The club used, clubhead speed at impact, and estimated carry distance (affected by wind at level 8+)",
                    "Club / Club Speed / Carry (after wind)": "Carry distance has been adjusted for wind effects. Headwind reduces distance, tailwind increases it.",
                    "Club Face": "Direction the clubface points at impact. Negative = left, positive = right. Controls ~75-85% of start direction.",
                    "Club Path": "Direction the club is swinging. Negative = left, positive = right. Face-to-path difference creates curve.",
                    "Impact Location": "Where ball strikes the face. Toe creates draw spin, heel creates fade spin. High on face increases sidespin, low decreases it.",
                    "Lie Angle": "Club's lie at impact. Upright closes the face, flat opens it. Effect varies by club type.",
                    "Wind": "Wind conditions affect both distance and spin. Headwind amplifies curve, tailwind reduces it. Crosswind pushes the ball laterally."
                };
            }
        }


        function generateScenario(diffLevel) {
            let isTrickScenario = false; // Track if this is a trick scenario
            
            const baseClubSpeed = { driver: 105, wood: 95, long_iron: 90, mid_iron: 85, wedge: 75 };
            const baseCarryDistance = { driver: 250, wood: 220, long_iron: 185, mid_iron: 165, wedge: 120 };
            
            // Club selection by level
            const clubs = diffLevel <= 1 ? ["Driver", "7 Iron"] :                      // Level 1: Basic
                         diffLevel <= 2 ? ["Driver", "5 Wood", "7 Iron"] :              // Level 2: Add wood
                         diffLevel <= 4 ? ["Driver", "3 Wood", "5 Iron", "7 Iron"] :    // Level 3-4: Add 5i
                         ["Driver", "3 Wood", "5 Iron", "7 Iron", "PW"];                // Level 5-6: All clubs
            const club = clubs[Math.floor(Math.random() * clubs.length)];
            
            // Granular club type mapping for realistic physics
            const clubType = club.includes("Driver") ? "driver" : 
                             club.includes("Wood") ? "wood" : 
                             club.includes("5 Iron") ? "long_iron" :
                             club.includes("7 Iron") ? "mid_iron" :
                             club.includes("PW") ? "wedge" : "mid_iron";
            
            // Club-specific physics - REAL WORLD VALUES
            const clubPhysics = {
                driver: { startFaceInfluence: 0.85, curveMultiplier: 3.3, loft: 10, gearMultiplier: 0.15 },
                wood: { startFaceInfluence: 0.82, curveMultiplier: 2.8, loft: 18, gearMultiplier: 0.12 },
                long_iron: { startFaceInfluence: 0.78, curveMultiplier: 2.2, loft: 24, gearMultiplier: 0.09 },  // 5-6 Iron
                mid_iron: { startFaceInfluence: 0.75, curveMultiplier: 2.0, loft: 34, gearMultiplier: 0.07 },     // 7-8 Iron
                wedge: { startFaceInfluence: 0.70, curveMultiplier: 1.2, loft: 50, gearMultiplier: 0.05 }      // PW
            };
            // SOURCE: TrackMan PGA Tour data
            // Driver (275yd): 5¬∞ face-to-path = 44 yards ‚Üí 3.2x multiplier
            // 6-Iron (183yd): 2¬∞ face-to-path = 8 yards ‚Üí 2.2x multiplier
            const physics = clubPhysics[clubType];
            
            // Safety checks
            if (!physics) {
                console.error('CRITICAL ERROR: Invalid clubType:', clubType, 'for club:', club);
                throw new Error(`Invalid clubType: ${clubType} for club: ${club}`);
            }
            if (!baseClubSpeed[clubType]) {
                console.error('CRITICAL ERROR: No speed for clubType:', clubType);
                throw new Error(`No speed for clubType: ${clubType}`);
            }
            if (!baseCarryDistance[clubType]) {
                console.error('CRITICAL ERROR: No carry for clubType:', clubType);
                throw new Error(`No carry for clubType: ${clubType}`);
            }
            
            const speedVariance = diffLevel % 2 === 0 ? 15 : 10;
            
            let speed = baseClubSpeed[clubType] + (Math.random() * speedVariance - speedVariance/2);
            let carry = baseCarryDistance[clubType] + (Math.random() * (speedVariance * 2) - speedVariance);
            
            // Bell curve distribution for angles using Box-Muller transform
            // This creates a normal distribution centered at 0
            function bellCurve(min, max, stdDev) {
                // Box-Muller transform for normal distribution
                let u1 = Math.random();
                let u2 = Math.random();
                let z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                // Scale to desired std deviation and clamp to range
                let value = z * stdDev;
                return Math.max(min, Math.min(max, value));
            }
            
            // Face: bell curve with std dev of 3¬∞ (most shots within ¬±3¬∞)
            let face = bellCurve(-11, 11, 3);
            face = parseFloat(face.toFixed(1));
            
            // Path: bell curve with std dev of 3.5¬∞ (slightly wider than face)
            let path = bellCurve(-11, 11, 3.5);
            path = parseFloat(path.toFixed(1));
            
            let gearEffect = 0; // Will be set if impact location exists
            let impact = 0; // Horizontal impact location (toe/heel)
            let impactSide = ""; // Will be set if impact exists
            let windEffect = 0; // Will be set if wind exists
            let windDir = "";
            let impactLocationText = "";
            
            let faceDisplay, pathDisplay;
            
            // Progressive hint removal: levels 1-3 full hints, 4+ no hints
            if (diffLevel <= 3) {
                faceDisplay = face + "¬∞" + (face > 0 ? " (right)" : face < 0 ? " (left)" : "");
                pathDisplay = path + "¬∞" + (path > 0 ? " (right)" : path < 0 ? " (left)" : "");
            } else {
                // Levels 4+: no hints at all
                faceDisplay = face + "¬∞";
                pathDisplay = path + "¬∞";
            }
            
            // Initialize carry label (will be updated if wind exists)
            let carryLabel = "Club / Club Speed / Carry";
            
            let data = {
                [carryLabel]: {
                    icon: "üèåÔ∏è",
                    label: carryLabel,
                    value: club + " ‚Ä¢ " + speed.toFixed(1) + " mph ‚Ä¢ " + Math.round(carry) + " yards"
                },
                "Club Face": {
                    icon: "üéØ",
                    label: "Club Face",
                    value: faceDisplay
                },
                "Club Path": {
                    icon: "‚Ü™Ô∏è",
                    label: "Club Path",
                    value: pathDisplay
                }
            };
            
            if (diffLevel >= 2) {
                // Trick scenarios: at high levels, occasionally create strong opposing forces
                const shouldBeTrick = diffLevel >= 4 && Math.random() < (diffLevel === 6 ? 0.50 : 0.15); // 15% at L4-5, 50% at L6
                
                // Club-specific maximum impact distances (full clubface width)
                const maxImpactByClub = {
                    driver: 30,   // ¬±30mm from center
                    wood: 27.5,   // ¬±27.5mm from center
                    long_iron: 26, // ¬±26mm from center
                    mid_iron: 25,     // ¬±25mm from center
                    wedge: 22.5   // ¬±22.5mm from center
                };
                
                // Level 6: Extreme impacts (15-25mm), Level 1: Easy (¬±6mm), Others: Full range
                let maxImpact;
                if (diffLevel === 6) {
                    maxImpact = 25; // Force large impacts
                    impact = (Math.random() * 10 + 15) * (Math.random() < 0.5 ? 1 : -1); // 15-25mm toe or heel
                } else if (diffLevel === 1) {
                    maxImpact = 6; // Beginner-friendly
                    impact = Math.random() * maxImpact * 2 - maxImpact;
                } else {
                    maxImpact = maxImpactByClub[clubType];
                }
                
                if (shouldBeTrick && diffLevel !== 6) {
                    isTrickScenario = true; // Mark this as a trick scenario
                    // Force a trick scenario: strong gear effect opposing face-to-path
                    maxImpact = maxImpactByClub[clubType];
                    const faceToPath = face - path;
                    // If face-to-path is positive (fade), create strong toe hit (draw gear)
                    // If face-to-path is negative (draw), create strong heel hit (fade gear)
                    if (faceToPath > 0) {
                        impact = Math.random() * (maxImpact * 0.5) + (maxImpact * 0.5); // Strong toe hit (50-100% of max)
                    } else if (faceToPath < 0) {
                        impact = -(Math.random() * (maxImpact * 0.5) + (maxImpact * 0.5)); // Strong heel hit
                    } else {
                        impact = Math.random() * maxImpact * 2 - maxImpact; // Random if straight
                    }
                } else if (diffLevel !== 6 && diffLevel !== 1) {
                    impact = Math.random() * maxImpact * 2 - maxImpact;
                }
                // Level 6 and Level 1 already set impact above
                
                if (shouldBeTrick && diffLevel === 6) {
                    isTrickScenario = true; // Level 6 trick scenarios
                }
                
                impactSide = impact > 0 ? "toe" : impact < 0 ? "heel" : "center";
                
                data["Impact Location"] = {
                    icon: "üìç",
                    label: "Impact Location",
                    value: Math.abs(impact).toFixed(1) + "mm " + impactSide,
                    visual: null // Will be set after vertical impact is calculated
                };
                
                // Gear effect: heel creates FADE spin (negative impact = positive gear effect = fade)
                // toe creates DRAW spin (positive impact = negative gear effect = draw)
                gearEffect = impact * -physics.gearMultiplier;
                impactLocationText = Math.abs(impact).toFixed(1) + "mm " + impactSide;
            }
            
            // Vertical impact (high/low on face) added at level 3
            let verticalImpact = 0;
            let verticalGearMultiplier = 1.0;
            
            if (diffLevel >= 3) {
                // Level 6: Extreme vertical (10-15mm), Others: Normal (¬±12mm)
                if (diffLevel === 6) {
                    verticalImpact = (Math.random() * 5 + 10) * (Math.random() < 0.5 ? 1 : -1); // 10-15mm high or low
                } else {
                    verticalImpact = (Math.random() * 24) - 12; // -12 to +12mm
                }
                const verticalSide = verticalImpact > 0 ? "high" : "low";
                
                // Update impact location display to include vertical (Level 3+)
                if (diffLevel >= 3) {
                    const horizontalText = Math.abs(impact).toFixed(1) + "mm " + impactSide;
                    // ü•àüêô SILVER OCTOPUS: Add context to vertical display
                    const verticalContext = Math.abs(verticalImpact) < 2 ? "" : 
                                          verticalImpact > 0 ? " (AMPLIFIES)" : " (DAMPENS)";
                    const verticalText = Math.abs(verticalImpact).toFixed(1) + "mm " + verticalSide + verticalContext;
                    data["Impact Location"].value = horizontalText + ", " + verticalText;
                    impactLocationText = horizontalText + ", " + verticalText;
                }
                // Level 2: Only horizontal
                else if (diffLevel === 2) {
                    impactLocationText = Math.abs(impact).toFixed(1) + "mm " + impactSide;
                }
                
                // Calculate vertical gear effect (club-specific)
                const verticalMultipliers = {
                    driver: { high: 1.20, low: 0.80 },
                    wood: { high: 1.15, low: 0.85 },
                    long_iron: { high: 1.12, low: 0.88 },
                    mid_iron: { high: 1.10, low: 0.90 },
                    wedge: { high: 1.05, low: 0.95 }
                };
                
                const multipliers = verticalMultipliers[clubType];
                
                // Safety check
                if (!multipliers) {
                    console.error('Invalid clubType:', clubType, 'for club:', club);
                    verticalGearMultiplier = 1.0; // Default to no effect
                } else {
                    const absVertical = Math.abs(verticalImpact);
                    
                    if (verticalImpact > 0) {
                        // High on face: more sidespin effectiveness
                        verticalGearMultiplier = 1.0 + ((multipliers.high - 1.0) * (absVertical / 12));
                    } else {
                        // Low on face: less sidespin effectiveness
                        verticalGearMultiplier = 1.0 - ((1.0 - multipliers.low) * (absVertical / 12));
                    }
                }
            } else if (diffLevel >= 3) {
                // Level 3-4: Vertical impact but no visual needed
            }
            
            // Lie Angle added at level 4
            let lieAngleAdjustment = 0;
            let originalFace = face; // Store original before lie adjustment
            let lieAngle = 0;
            
            if (diffLevel >= 4) {
                // Level 6: Extreme lie (3-5¬∞), Others: Normal (¬±3¬∞)
                if (diffLevel === 6) {
                    lieAngle = (Math.random() * 2 + 3) * (Math.random() < 0.5 ? 1 : -1); // 3-5¬∞ upright or flat
                } else {
                    lieAngle = (Math.random() * 6) - 3; // -3 to +3¬∞
                }
                const lieType = lieAngle > 0.5 ? "upright" : lieAngle < -0.5 ? "flat" : "standard";
                
                // Display lie angle
                if (Math.abs(lieAngle) > 0.5) {
                    const lieValue = lieType === "standard" ? "Standard" : Math.abs(lieAngle).toFixed(1) + "¬∞ " + lieType;
                    data["Lie Angle"] = {
                        icon: "üìê",
                        label: "Lie Angle",
                        value: lieValue
                    };
                    
                    // Lie angle affects face angle: upright closes face (left), flat opens face (right)
                    // Club-specific multipliers (realistic physics)
                    const lieMultipliers = {
                        driver: 0.3,  // Long clubs less affected
                        wood: 0.4,
                        long_iron: 0.45,  // 5 iron
                        mid_iron: 0.5,    // 7 iron
                        wedge: 0.7        // Short clubs more affected
                    };
                    const lieMultiplier = lieMultipliers[clubType];
                    
                    // CRITICAL: Upright (positive) = closes face (negative adjustment)
                    // Flat (negative) = opens face (positive adjustment)
                    lieAngleAdjustment = lieAngle * -lieMultiplier;
                    face = face + lieAngleAdjustment;
                    
                    // Face card stays clean - no "After lie" display normally
                    // But we need to store this info for later card updates
                    // This will be handled in the render function based on state.effectiveFaceShown
                }
            }
            
            let windSpeedMPH = 0;
            let windMultiplier = 1.0; // How wind affects spin/curve
            let carryAdjustment = 0; // How wind affects distance
            
            if (diffLevel >= 5) { // WIND ONLY AT LEVEL 5+
                // Bell curve distribution: mean ~7 MPH, std dev ~5, capped at 25
                const bellCurve = () => {
                    const u1 = Math.random();
                    const u2 = Math.random();
                    const z = Math.sqrt(-2 * Math.log(u1)) * Math.cos(2 * Math.PI * u2);
                    // Level 6: Extreme winds (15-25 mph), Others: Normal (std dev 5, mean 7)
                    return diffLevel === 6 ? z * 4 + 20 : z * 5 + 7;
                };
                windSpeedMPH = Math.max(0, Math.min(25, Math.round(bellCurve())));
                
                const windDirs = ["Headwind", "Tailwind", "Left-to-Right", "Right-to-Left"];
                windDir = windDirs[Math.floor(Math.random() * windDirs.length)];
                
                // Only show wind card if there's actual wind
                if (windSpeedMPH > 0) {
                    data["Wind"] = {
                        icon: "üí®",
                        label: "Wind",
                        value: windSpeedMPH + " mph " + windDir
                    };
                }
                
                // Wind physics
                if (windSpeedMPH > 0) {
                    if (windDir === "Headwind") {
                        // üöÄü•™ ROCKET SANDWICH: TrackMan-validated 1% per mph
                        // Source: TrackMan University, Golf Digest/Foresight, Andrew Rice Golf
                        carryAdjustment = -carry * windSpeedMPH * 0.01; // 10mph = 10% loss
                        windMultiplier = 1.0 + (windSpeedMPH / 100); // Amplifies curve (ball in air longer)
                    } else if (windDir === "Tailwind") {
                        // üöÄü•™ ROCKET SANDWICH: TrackMan-validated 0.6% per mph
                        // Source: TrackMan University, Golf Digest/Foresight
                        // Tailwind helps HALF as much as headwind hurts (asymmetric!)
                        carryAdjustment = carry * windSpeedMPH * 0.006; // 10mph = 6% gain
                        windMultiplier = 1.0 - (windSpeedMPH / 150); // Dampens curve (ball falls faster)
                    } else {
                        // Crosswind: lateral push based on speed tier (VALIDATED - already correct!)
                        // Source: Philippe Bonfanti Golf/TrackMan, Andrew Rice Golf
                        const carryInTens = carry / 10;
                        let yardsPerTen;
                        if (windSpeedMPH <= 10) yardsPerTen = 0.5; // Light: 0.5 yards per 10 yards carry
                        else if (windSpeedMPH <= 15) yardsPerTen = 0.75; // Moderate
                        else yardsPerTen = 1.0; // Strong: 20mph crosswind = ~27 yards on 150yd shot
                        
                        windEffect = (windDir === "Left-to-Right" ? 1 : -1) * yardsPerTen * carryInTens;
                        carryAdjustment = -windSpeedMPH * 0.1; // Slight drag from crosswind
                    }
                }
            }
            
            // Apply carry adjustment
            carry = Math.round(carry + carryAdjustment);
            
            // Update carry label if wind affected distance
            if (windSpeedMPH > 0 && carryAdjustment !== 0) {
                carryLabel = "Club / Club Speed / Carry (after wind)";
            }
            
            const faceToPath = face - path + gearEffect;
            const startDir = face > 0 ? "right" : face < 0 ? "left" : "straight";
            
            // Determine shape based on tighter thresholds
            const absFTP = Math.abs(faceToPath);
            const curveType = absFTP <= 0.5 ? "straight" : absFTP <= 3.0 ? "moderate" : absFTP <= 6.0 ? "heavy" : "extreme";
            const startType = Math.abs(face) <= 1 ? "straight" : face > 1 ? "push" : "pull";
            const isDrawCurve = faceToPath < 0;
            
            let shape = "Straight";
            let shapeDesc = "on target, no curve";
            
            if (curveType !== "straight") {
                const curveNames = {
                    moderate: isDrawCurve ? ["Draw", "curves moderately left, consistent predictable shape"] : ["Fade", "curves moderately right, consistent predictable shape"],
                    heavy: isDrawCurve ? ["Draw", "curves moderately left, consistent predictable shape"] : ["Fade", "curves moderately right, consistent predictable shape"],
                    extreme: isDrawCurve ? ["Hook", "curves severely left, hard to control"] : ["Slice", "curves severely right, hard to control"]
                };
                
                if (startType === "straight") {
                    [shape, shapeDesc] = curveNames[curveType];
                } else if (startType === "push") {
                    if (curveType === "moderate") [shape, shapeDesc] = isDrawCurve ? ["Push-draw", "starts right, curves back left toward target"] : ["Push-fade", "starts right, curves further right"];
                    else if (curveType === "heavy") [shape, shapeDesc] = isDrawCurve ? ["Push-draw", "starts right, curves back left toward target"] : ["Push-fade", "starts right, curves further right"];
                    else [shape, shapeDesc] = isDrawCurve ? ["Push-hook", "starts right, curves severely back left"] : ["Push-slice", "starts right, curves strongly further right"];
                } else {
                    if (curveType === "moderate" || curveType === "heavy") [shape, shapeDesc] = isDrawCurve ? ["Pull-draw", "starts left, curves further left"] : ["Pull-fade", "starts left, curves back right toward target"];
                    else [shape, shapeDesc] = isDrawCurve ? ["Pull-hook", "starts left, curves severely further left"] : ["Pull-slice", "starts left, curves strongly back right"];
                }
            } else {
                if (startType === "push") [shape, shapeDesc] = ["Push", "starts right of target, flies straight right"];
                else if (startType === "pull") [shape, shapeDesc] = ["Pull", "starts left of target, flies straight left"];
            }

            const cards = [];
            const baseFaceToPath = face - path;
            
            // LEVEL-BASED CARD GENERATION
            if (diffLevel <= 2) {
                // Level 1: Face-to-path + Curve direction + What-if
                // Level 2: Face-to-path + Curve direction + Start direction
                
                cards.push(generateFaceToPathQuestion(face, path, diffLevel, lieAngleAdjustment, originalFace));
                
                // Both levels: Curve direction question
                cards.push(generateCurveDirectionQuestion(baseFaceToPath, diffLevel, clubType));
                
                // Level 1: ALWAYS add what-if question (randomly path or face)
                if (diffLevel === 1) {
                    // üü°üî∫ MUSTARD PYRAMID: Add Start vs Curve question (20% frequency)
                    if (Math.random() < 0.20) {
                        cards.push(generateStartVsCurveQuestion(face, baseFaceToPath, diffLevel));
                    } else if (Math.random() < 0.5) {
                        cards.push(generateWhatIfPathQuestion(face, path, diffLevel, clubType));
                    } else {
                        cards.push(generateWhatIfFaceQuestion(face, path, diffLevel, clubType));
                    }
                }
                
                // Level 2: IMPACT LOCATION FOCUS - Always 3 cards
                if (diffLevel === 2) {
                    // Build pool of available impact questions
                    const impactQuestions = [];
                    
                    // Educational questions (high frequency early, then rare)
                    if (state.scenarioNumber <= 4 && Math.random() < 0.50) {
                        impactQuestions.push({type: 'gear_direction', fn: () => generateGearDirectionThisShotQuestion(impact, gearEffect, diffLevel)});
                    } else if (state.scenarioNumber > 4 && Math.random() < 0.10) {
                        impactQuestions.push({type: 'gear_direction', fn: () => generateGearDirectionThisShotQuestion(impact, gearEffect, diffLevel)});
                    }
                    
                    if (state.scenarioNumber <= 6 && Math.random() < 0.33) {
                        const q = generateGearPercentageQuestion(gearEffect, baseFaceToPath, diffLevel);
                        if (q) impactQuestions.push({type: 'gear_percentage', fn: () => q});
                    } else if (state.scenarioNumber > 6 && Math.random() < 0.10) {
                        const q = generateGearPercentageQuestion(gearEffect, baseFaceToPath, diffLevel);
                        if (q) impactQuestions.push({type: 'gear_percentage', fn: () => q});
                    }
                    
                    if (state.scenarioNumber <= 10 && Math.random() < 0.20) {
                        impactQuestions.push({type: 'club_sensitivity', fn: () => generateClubSensitivityQuestion(diffLevel)});
                    } else if (state.scenarioNumber > 10 && Math.random() < 0.07) {
                        impactQuestions.push({type: 'club_sensitivity', fn: () => generateClubSensitivityQuestion(diffLevel)});
                    }
                    
                    // Core questions pool (always available)
                    const corePool = [
                        {type: 'spin_type', weight: 25, fn: () => generateImpactSpinTypeQuestion(gearEffect, impact, impactLocationText, diffLevel)},
                        {type: 'gear_help', weight: 20, fn: () => generateGearHelpHurtQuestion(gearEffect, baseFaceToPath, impactLocationText, diffLevel)},
                        {type: 'magnitude', weight: 15, fn: () => generateImpactMagnitudeQuestion(gearEffect, impact, clubType, diffLevel)},
                        {type: 'opposing', weight: 15, fn: () => generateOpposingForcesLevel2Question(gearEffect, baseFaceToPath, diffLevel)},
                        {type: 'center_target', weight: 15, fn: () => generateCenterStrikeTargetQuestion(gearEffect, baseFaceToPath, diffLevel)},
                        {type: 'ranking', weight: 10, fn: () => generateImpactRankingTargetQuestion(impact, diffLevel)}
                    ];
                    
                    // Select questions: prioritize educational if triggered, otherwise use weighted core
                    let selectedTypes = [];
                    
                    // If no educational questions triggered, select 2 from core pool
                    while (impactQuestions.length < 2) {
                        const rand = Math.random() * 100;
                        let cumulative = 0;
                        for (const item of corePool) {
                            cumulative += item.weight;
                            if (rand < cumulative && !selectedTypes.includes(item.type)) {
                                impactQuestions.push(item);
                                selectedTypes.push(item.type);
                                break;
                            }
                        }
                    }
                    
                    // Ensure we have exactly 2 unique impact questions
                    const uniqueImpact = impactQuestions.filter((q, i, arr) => 
                        arr.findIndex(x => x.type === q.type) === i
                    ).slice(0, 2);
                    
                    // Add the questions
                    uniqueImpact.forEach(q => cards.push(q.fn()));
                }
                
            } else if (diffLevel <= 4) {
                // Level 3-4: Progressive questions with offline distance
                // Level 4: Add effective face, gear help/hurt, lie questions
                
                // Calculate offline distance for questions (use data available at this level)
                const startMultipliers = {
                    driver: 2.5, wood: 2.3, long_iron: 2.0, mid_iron: 1.8, wedge: 1.5
                };
                const startMultiplier = startMultipliers[clubType] || 2.5;
                const faceContribution = face * startMultiplier;
                
                // Curve calculation (only use gear effect at L3-4, no wind yet)
                const baseCurveContribution = baseFaceToPath * physics.curveMultiplier * verticalGearMultiplier;
                const gearContribution = gearEffect * physics.curveMultiplier * verticalGearMultiplier;
                const curveContribution = baseCurveContribution + gearContribution;
                
                // NO WIND at Level 3-4 (wind starts at Level 5)
                const netOffline = faceContribution + curveContribution;
                const offlineYards = Math.abs(netOffline);
                const roundedYards = Math.round(offlineYards);
                const offlineDir = netOffline > 0 ? "right" : "left";
                
                // Level 4: Effective face question if lie exists
                if (diffLevel === 4 && lieAngleAdjustment !== 0) {
                    cards.push(generateEffectiveFaceQuestion(originalFace, lieAngleAdjustment, face, diffLevel, lieAngle, clubType));
                }
                
                cards.push(generateFaceToPathQuestion(face, path, diffLevel, lieAngleAdjustment, originalFace));
                
                cards.push({
                    question: "Will the ball start left or right of the target?",
                    options: ["Left of target", "Right of target", "Straight at target"],
                    correct: face < -0.5 ? "Left of target" : face > 0.5 ? "Right of target" : "Straight at target",
                    explanation: lieAngleAdjustment !== 0 
                        ? `<div><strong>Original face:</strong> ${originalFace.toFixed(1)}¬∞</div><div><strong>Lie adjustment:</strong> ${lieAngleAdjustment.toFixed(1)}¬∞</div><div><strong>Effective face:</strong> ${face.toFixed(1)}¬∞</div><div><strong>Club:</strong> ${club} (${Math.round(physics.startFaceInfluence * 100)}% face influence)</div><div>The ball starts <strong>${startDir}</strong> because face angle controls ${Math.round(physics.startFaceInfluence * 100)}% of initial direction for this club.</div>`
                        : `<div><strong>Face angle:</strong> ${face.toFixed(1)}¬∞</div><div><strong>Club:</strong> ${club} (${Math.round(physics.startFaceInfluence * 100)}% face influence)</div><div>The ball starts <strong>${startDir}</strong> because face angle controls ${Math.round(physics.startFaceInfluence * 100)}% of initial direction for this club.</div>`
                });
                
                // Level 3-4: Offline distance question (wider ranges than L5)
                const rangeSize = roundedYards <= 15 ? 5 : roundedYards <= 30 ? 8 : 12; // Wider ranges
                const numRanges = 4; // Fewer options
                let offlineOptions = [];
                const correctRangeIndex = Math.floor(numRanges / 2);
                const startValue = Math.max(0, roundedYards - (correctRangeIndex * rangeSize));
                
                for (let i = 0; i < numRanges; i++) {
                    const min = startValue + (i * rangeSize);
                    const max = min + rangeSize - 1;
                    if (i === numRanges - 1) {
                        offlineOptions.push(`${min}+ yards ${offlineDir}`);
                    } else {
                        offlineOptions.push(`${min}-${max} yards ${offlineDir}`);
                    }
                }
                
                let correctOfflineRange = "";
                for (let i = 0; i < offlineOptions.length; i++) {
                    const match = offlineOptions[i].match(/^(\d+)-(\d+)/);
                    if (match) {
                        const min = parseInt(match[1]);
                        const max = parseInt(match[2]);
                        if (roundedYards >= min && roundedYards <= max) {
                            correctOfflineRange = offlineOptions[i];
                            break;
                        }
                    } else if (offlineOptions[i].includes('+')) {
                        const min = parseInt(offlineOptions[i].match(/^(\d+)/)[1]);
                        if (roundedYards >= min) {
                            correctOfflineRange = offlineOptions[i];
                        }
                    }
                }
                
                // Build detailed explanation with all calculations
                const startMultiplierUsed = startMultipliers[clubType] || 2.5;
                let offlineExplanation = `<div class="space-y-2">`;
                offlineExplanation += `<div><strong>START CALCULATION:</strong></div>`;
                offlineExplanation += `<div class="ml-3">Face: ${face.toFixed(1)}¬∞ √ó ${startMultiplierUsed} (${clubType}) = ${Math.abs(faceContribution).toFixed(1)} yards ${faceContribution > 0 ? 'right' : 'left'}</div>`;
                
                offlineExplanation += `<div class="mt-2"><strong>CURVE CALCULATION:</strong></div>`;
                offlineExplanation += `<div class="ml-3">Face-to-path: ${baseFaceToPath.toFixed(1)}¬∞ √ó ${physics.curveMultiplier} (curve mult)`;
                if (diffLevel >= 3 && Math.abs(verticalImpact) > 0.1) {
                    offlineExplanation += ` √ó ${verticalGearMultiplier.toFixed(2)} (vertical gear)`;
                }
                offlineExplanation += ` = ${baseCurveContribution.toFixed(1)} yards</div>`;
                
                if (Math.abs(gearEffect) > 0.1) {
                    offlineExplanation += `<div class="ml-3">Gear effect: ${gearEffect.toFixed(1)}¬∞ √ó ${physics.curveMultiplier}`;
                    if (diffLevel >= 3 && Math.abs(verticalImpact) > 0.1) {
                        offlineExplanation += ` √ó ${verticalGearMultiplier.toFixed(2)}`;
                    }
                    offlineExplanation += ` = ${gearContribution.toFixed(1)} yards</div>`;
                    offlineExplanation += `<div class="ml-3"><strong>Total curve:</strong> ${baseCurveContribution.toFixed(1)} + ${gearContribution.toFixed(1)} = ${curveContribution.toFixed(1)} yards</div>`;
                } else {
                    offlineExplanation += `<div class="ml-3"><strong>Total curve:</strong> ${curveContribution.toFixed(1)} yards</div>`;
                }
                
                offlineExplanation += `<div class="mt-2"><strong>FINAL:</strong> ${Math.abs(faceContribution).toFixed(1)} ${faceContribution > 0 ? '+' : '-'} ${Math.abs(curveContribution).toFixed(1)} = <strong>${offlineYards.toFixed(1)} yards ${offlineDir}</strong></div>`;
                offlineExplanation += `</div>`;
                
                cards.push({
                    question: "How far offline will the ball finish?",
                    options: offlineOptions,
                    correct: correctOfflineRange,
                    explanation: offlineExplanation
                });
                
                // Level 3: Add what-if vertical center question (30% chance)
                if (diffLevel === 3 && Math.abs(verticalImpact) > 2 && Math.random() < 0.3) {
                    cards.push(generateWhatIfVerticalCenterQuestion(verticalImpact, baseFaceToPath, verticalGearMultiplier, diffLevel));
                }
                
                // Level 3: Add vertical amplify/dampen question (25% chance) - üíöüé∑ EMERALD SAXOPHONE
                if (diffLevel === 3 && Math.abs(verticalImpact) > 2 && Math.random() < 0.25) {
                    cards.push(generateVerticalAmplifyDampenQuestion(verticalImpact, diffLevel));
                }
                
                // Level 4: Add gear help/hurt if gear exists
                if (diffLevel === 4 && gearEffect !== 0 && Math.abs(baseFaceToPath) > 1) {
                    cards.push(generateGearHelpHurtQuestion(gearEffect, baseFaceToPath, impactLocationText, diffLevel));
                }
                
                // Level 4: Add lie effect direction if lie exists
                if (diffLevel === 4 && Math.abs(lieAngle) > 0.5) {
                    cards.push(generateLieEffectDirectionQuestion(lieAngle, diffLevel));
                }
                
                // Level 4: Hypothetical question (only lie-based, no wind yet)
                if (diffLevel === 4 && Math.abs(lieAngle) > 0.5) {
                    cards.push(generateStandardLieHypotheticalQuestion(face, originalFace, lieAngleAdjustment, path, 0, diffLevel, physics.curveMultiplier, windMultiplier, verticalGearMultiplier, gearEffect));
                }
                
                // Shot shape
                const allShapes = ["Straight", "Push", "Pull", "Draw", "Fade", "Hook", "Slice", "Push-draw", "Push-fade", "Push-hook", "Push-slice", "Pull-hook", "Pull-fade", "Pull-slice"];
                const numWrongOptions = 3; // 4 total
                const wrongShapes = allShapes.filter(s => s !== shape).sort(() => Math.random() - 0.5).slice(0, numWrongOptions);
                const options = [shape, ...wrongShapes].sort(() => Math.random() - 0.5);
                
                let explanationParts = [];
                explanationParts.push(`<strong>Club:</strong> ${club} (${physics.loft}¬∞ loft)`);
                explanationParts.push(`<strong>Face:</strong> ${face.toFixed(1)}¬∞`);
                explanationParts.push(`<strong>Path:</strong> ${path.toFixed(1)}¬∞`);
                explanationParts.push(`<strong>Face-to-path:</strong> ${baseFaceToPath.toFixed(1)}¬∞`);
                if (gearEffect !== 0) {
                    const gearDir = gearEffect > 0 ? "fade" : "draw";
                    const gearRelation = (gearEffect > 0 && baseFaceToPath > 0) || (gearEffect < 0 && baseFaceToPath < 0) ? "additional" : "opposing";
                    const highlightClass = gearRelation === "opposing" ? ' style="color: #dc2626; font-weight: bold;"' : '';
                    const warningIcon = gearRelation === "opposing" ? "‚ö†Ô∏è " : "";
                    explanationParts.push(`<strong${highlightClass}>${warningIcon}Gear effect (${gearRelation}):</strong> ${impactLocationText} = ${Math.abs(gearEffect).toFixed(1)}¬∞ ${gearDir} spin`);
                    explanationParts.push(`<strong>Total face-to-path:</strong> ${faceToPath.toFixed(1)}¬∞ (with gear effect)`);
                }
                explanationParts.push(`<strong>Result:</strong> ${shape} - ${shapeDesc}`);
                
                cards.push({
                    question: "What will be the shot shape?",
                    options: options,
                    correct: shape,
                    correctBase: shape,
                    explanation: '<div class="space-y-1">' + explanationParts.map(p => '<div>' + p + '</div>').join('') + '</div>'
                });
                
            } else {
                // Level 5+: Mix of questions, progressively harder
                const questionPool = [];
                
                // Organize questions by priority to avoid spoilers
                let basicQuestions = []; // Safe questions that don't reveal answers
                const spoilerQuestions = []; // Questions that reveal calculation results
                const hypotheticalQuestions = []; // What-if questions (come after knowing original result)
                
                // Shot shape (always available - basic question)
                const allShapes = ["Straight", "Push", "Pull", "Draw", "Fade", "Hook", "Slice", "Push-draw", "Push-fade", "Push-hook", "Push-slice", "Pull-hook", "Pull-fade", "Pull-slice"];
                
                // Determine number of options: 1-3=3, 4-6=4, 7-9=5, 10=6
                let numWrongOptions;
                if (diffLevel <= 3) numWrongOptions = 2; // 3 total options
                else if (diffLevel <= 6) numWrongOptions = 3; // 4 total options
                else if (diffLevel <= 9) numWrongOptions = 4; // 5 total options
                else numWrongOptions = 5; // 6 total options (level 10)
                
                const wrongShapes = allShapes.filter(s => s !== shape).sort(() => Math.random() - 0.5).slice(0, numWrongOptions);
                const options = [shape, ...wrongShapes].sort(() => Math.random() - 0.5);
                
                let explanationParts = [];
                explanationParts.push(`<strong>Club:</strong> ${club} (${physics.loft}¬∞ loft)`);
                
                // Show lie angle calculation if applicable (Level 7+)
                if (lieAngleAdjustment !== 0) {
                    const lieMultipliers = { driver: 0.3, wood: 0.4, long_iron: 0.45, mid_iron: 0.5, wedge: 0.7 };
                    const lieMultiplier = lieMultipliers[clubType];
                    explanationParts.push(`<strong>Original face:</strong> ${originalFace.toFixed(1)}¬∞`);
                    explanationParts.push(`<strong>Lie adjustment:</strong> ${Math.abs(lieAngle).toFixed(1)}¬∞ ${lieAngle > 0 ? 'upright' : 'flat'} √ó ${lieMultiplier} = ${lieAngleAdjustment.toFixed(1)}¬∞`);
                    explanationParts.push(`<strong>Effective face:</strong> ${originalFace.toFixed(1)}¬∞ + (${lieAngleAdjustment.toFixed(1)}¬∞) = ${face.toFixed(1)}¬∞`);
                } else {
                    explanationParts.push(`<strong>Face:</strong> ${face.toFixed(1)}¬∞`);
                }
                
                explanationParts.push(`<strong>Path:</strong> ${path.toFixed(1)}¬∞`);
                explanationParts.push(`<strong>Face-to-path:</strong> ${baseFaceToPath.toFixed(1)}¬∞`);
                if (gearEffect !== 0) {
                    const gearDir = gearEffect > 0 ? "fade" : "draw";
                    const gearRelation = (gearEffect > 0 && baseFaceToPath > 0) || (gearEffect < 0 && baseFaceToPath < 0) ? "additional" : "opposing";
                    const highlightClass = gearRelation === "opposing" ? ' style="color: #dc2626; font-weight: bold;"' : '';
                    const warningIcon = gearRelation === "opposing" ? "‚ö†Ô∏è " : "";
                    explanationParts.push(`<strong${highlightClass}>${warningIcon}Gear effect (${gearRelation}):</strong> ${impactLocationText} = ${Math.abs(gearEffect).toFixed(1)}¬∞ ${gearDir} spin`);
                    explanationParts.push(`<strong>Total face-to-path:</strong> ${faceToPath.toFixed(1)}¬∞ (with gear effect)`);
                }
                explanationParts.push(`<strong>Result:</strong> ${shape} - ${shapeDesc}`);
                
                basicQuestions.push({
                    question: "What will be the shot shape?",
                    options: options,
                    correct: shape,
                    correctBase: shape,
                    explanation: '<div class="space-y-1">' + explanationParts.map(p => '<div>' + p + '</div>').join('') + '</div>'
                });
                
                // Start direction (basic - just left/right, no distance) - Level 5+
                basicQuestions.push({
                    question: "Will the ball start left or right of the target?",
                    options: ["Left of target", "Right of target", "Straight at target"],
                    correct: face < -0.5 ? "Left of target" : face > 0.5 ? "Right of target" : "Straight at target",
                    explanation: lieAngleAdjustment !== 0 
                        ? `<div><strong>Original face:</strong> ${originalFace.toFixed(1)}¬∞</div><div><strong>Lie adjustment:</strong> ${lieAngleAdjustment.toFixed(1)}¬∞</div><div><strong>Effective face:</strong> ${face.toFixed(1)}¬∞</div><div><strong>Club:</strong> ${club} (${Math.round(physics.startFaceInfluence * 100)}% face influence)</div><div>The ball starts <strong>${startDir}</strong> because face angle controls ${Math.round(physics.startFaceInfluence * 100)}% of initial direction for this club.</div>`
                        : `<div><strong>Face angle:</strong> ${face.toFixed(1)}¬∞</div><div><strong>Club:</strong> ${club} (${Math.round(physics.startFaceInfluence * 100)}% face influence)</div><div>The ball starts <strong>${startDir}</strong> because face angle controls ${Math.round(physics.startFaceInfluence * 100)}% of initial direction for this club.</div>`
                });
                
                // Start position in yards (SPOILER - reveals direction) - Level 5+
                spoilerQuestions.push(generateStartPositionQuestion(face, physics, diffLevel, clubType));
                
                // Advanced questions for level 6+
                // ü•àü™ó SILVER ACCORDION V2: Gate at scenario 10+ (50% of players)
                if (diffLevel >= 6 && state.scenarioNumber >= 10) {
                    spoilerQuestions.push(generatePrimaryCauseQuestion(face, path, gearEffect, windEffect, diffLevel));
                    spoilerQuestions.push(generateNetCurveQuestion(baseFaceToPath, gearEffect, windEffect, diffLevel));
                }
                
                // Level 5: Add gear effect help/hurt question if gear effect exists
                if (diffLevel >= 5 && gearEffect !== 0 && Math.abs(baseFaceToPath) > 1) {
                    basicQuestions.push(generateGearHelpHurtQuestion(gearEffect, baseFaceToPath, impactLocationText, diffLevel));
                }
                
                // Level 5-6: Add face percentage and curve comparison questions
                if (diffLevel >= 5 && diffLevel <= 6) {
                    basicQuestions.push(generateFaceSquareStartQuestion(face, path, physics, diffLevel));
                    if (gearEffect !== 0 && Math.abs(baseFaceToPath) > 1) {
                        basicQuestions.push(generateCurveComparisonQuestion(baseFaceToPath, gearEffect, clubType, diffLevel));
                    }
                }
                
                // Level 7: Add lie angle effect direction question
                if (diffLevel >= 7 && Math.abs(lieAngle) > 0.5) {
                    basicQuestions.push(generateLieEffectDirectionQuestion(lieAngle, diffLevel));
                }
                
                // Advanced questions for level 7-10
                if (diffLevel >= 4) {
                    spoilerQuestions.push(generateLeastImpactQuestion(face, path, gearEffect, windEffect, diffLevel));
                }
                
                if (diffLevel >= 4) {
                    // Will add hypothetical and vertical impact questions after we calculate values below
                }
                
                // Offline distance (Level 5+) - always include
                // Calculate components with club-specific physics
                
                // Club-specific start distance multipliers (realistic TrackMan values)
                const startMultipliers = {
                    driver: 2.5,      // Driver: ~2.5 yards per degree face angle
                    wood: 2.3,        // Wood: ~2.3 yards per degree
                    long_iron: 2.0,   // Long iron: ~2.0 yards per degree
                    mid_iron: 1.8,    // Mid iron: ~1.8 yards per degree
                    wedge: 1.5        // Wedge: ~1.5 yards per degree
                };
                const startMultiplier = startMultipliers[clubType] || 2.5;
                
                const faceContribution = face * startMultiplier; // Keep sign - positive = right, negative = left
                const baseCurveContribution = baseFaceToPath * physics.curveMultiplier * windMultiplier * verticalGearMultiplier; // Wind and vertical impact affect spin/curve
                const gearContribution = gearEffect * physics.curveMultiplier * windMultiplier * verticalGearMultiplier; // Gear effect also affected by wind and vertical impact
                const curveContribution = baseCurveContribution + gearContribution; // Total curve
                
                // Level 7: Add standard lie hypothetical (after curveContribution is calculated)
                if (diffLevel >= 7 && Math.abs(lieAngle) > 0.5) {
                    hypotheticalQuestions.push(generateStandardLieHypotheticalQuestion(face, originalFace, lieAngleAdjustment, path, windEffect, diffLevel, physics.curveMultiplier, windMultiplier, verticalGearMultiplier, gearEffect));
                }
                
                // Add hypothetical question and vertical impact question (Level 8+)
                if (diffLevel >= 4) {
                    // Wind questions only at Level 5+ (wind doesn't exist at Level 4)
                    if (diffLevel >= 5 && windSpeedMPH > 0 && Math.abs(baseFaceToPath) > 1) {
                        basicQuestions.push(generateWindAmplifyDampenQuestion(windDir, baseFaceToPath, diffLevel));
                        basicQuestions.push(generateWorstWindScenarioQuestion(baseFaceToPath, diffLevel));
                    }
                    
                    // Hypothetical question
                    hypotheticalQuestions.push(generateHypotheticalQuestion(face, path, faceContribution, curveContribution, windEffect, diffLevel, physics.curveMultiplier, windMultiplier, verticalGearMultiplier, gearEffect));
                    
                    // Add vertical impact curve question if significant vertical impact
                    if (Math.abs(verticalImpact) > 2 && Math.abs(baseFaceToPath) > 1) {
                        basicQuestions.push(generateVerticalImpactCurveQuestion(verticalImpact, verticalGearMultiplier, baseFaceToPath, diffLevel));
                    }
                }
                
                // Level 9-10: Advanced strategic questions (now at Level 5)
                // ü•àü™ó SILVER ACCORDION V2: Scenario gates for complexity
                if (diffLevel >= 5) {
                    spoilerQuestions.push(generateOpposingForcesQuestion(face, path, gearEffect, windEffect, baseFaceToPath, diffLevel));
                    
                    // BestVariable: Intermediate difficulty - scenario 6+ (80% of players)
                    if (state.scenarioNumber >= 6) {
                        spoilerQuestions.push(generateBestVariableQuestion(face, path, gearEffect, windEffect, diffLevel));
                    }
                    
                    // RankByImpact: Expert only - Level 6 only
                    if (diffLevel === 6) {
                        spoilerQuestions.push(generateRankByImpactQuestion(face, path, gearEffect, windEffect, diffLevel));
                    }
                }
                
                // Net offline is: where it starts (face) + how much it curves (total)
                const netOffline = faceContribution + curveContribution + windEffect;
                const offlineYards = Math.abs(netOffline);
                const roundedYards = Math.round(offlineYards);
                const offlineDir = netOffline > 0 ? "right" : "left";
                
                // üéπüßä GLACIER PIANO: Course management questions (Level 5-6, 12% frequency)
                if (diffLevel >= 5 && Math.random() < 0.12) {
                    spoilerQuestions.push(generateCourseManagementQuestion(offlineYards, offlineDir, baseFaceToPath, windEffect, diffLevel));
                }
                
                // DYNAMIC RANGES based on result magnitude
                let opts, corr;
                let rangeSize, numRanges;
                
                // Level 6: Brutal 2-yard ranges
                if (diffLevel === 6) {
                    rangeSize = 2;
                    numRanges = 6;
                }
                // Determine range size based on result magnitude
                else if (roundedYards <= 15) {
                    rangeSize = 3; // Small results: 3-yard ranges
                    numRanges = 6;
                } else if (roundedYards <= 30) {
                    rangeSize = 5; // Medium results: 5-yard ranges
                    numRanges = 6;
                } else if (roundedYards <= 50) {
                    rangeSize = 8; // Large results: 8-yard ranges
                    numRanges = 6;
                } else {
                    rangeSize = 15; // Extreme results: 15-yard ranges
                    numRanges = 6;
                }
                
                // Generate ranges dynamically to bracket the answer
                opts = [];
                const correctRangeIndex = Math.floor(numRanges / 2); // Put correct answer in middle
                const startValue = Math.max(0, roundedYards - (correctRangeIndex * rangeSize));
                
                for (let i = 0; i < numRanges; i++) {
                    const min = startValue + (i * rangeSize);
                    const max = min + rangeSize - 1;
                    
                    if (i === numRanges - 1) {
                        opts.push(`${min}+ yards ${offlineDir}`);
                    } else {
                        opts.push(`${min}-${max} yards ${offlineDir}`);
                    }
                }
                
                // Find correct range
                for (let i = 0; i < opts.length; i++) {
                    const match = opts[i].match(/^(\d+)-(\d+)/);
                    if (match) {
                        const min = parseInt(match[1]);
                        const max = parseInt(match[2]);
                        if (roundedYards >= min && roundedYards <= max) {
                            corr = opts[i];
                            break;
                        }
                    } else if (opts[i].includes('+')) {
                        // Last option (X+ yards)
                        const min = parseInt(opts[i].match(/^(\d+)/)[1]);
                        if (roundedYards >= min) {
                            corr = opts[i];
                            break;
                        }
                    }
                }
                
                // Fallback if no match found (shouldn't happen, but safety)
                if (!corr) {
                    corr = opts[opts.length - 1];
                }
                
                // Build detailed calculation explanation
                // baseFaceToPath already calculated above
                let calcParts = [];
                
                // Show start position from face with lie angle adjustment if applicable
                const faceDir = faceContribution > 0 ? "right" : "left";
                const faceYards = Math.abs(faceContribution);
                
                if (lieAngleAdjustment !== 0) {
                    // Show lie angle adjustment with club-specific multiplier
                    const lieDir = lieAngle > 0 ? "upright" : "flat";
                    const lieMultipliers = {
                        driver: 0.3,
                        wood: 0.4,
                        long_iron: 0.45,
                        mid_iron: 0.5,
                        wedge: 0.7
                    };
                    const lieMultiplier = lieMultipliers[clubType];
                    const adjustmentText = lieAngleAdjustment > 0 ? "+" + lieAngleAdjustment.toFixed(1) : lieAngleAdjustment.toFixed(1);
                    calcParts.push(`<strong>Lie angle adjustment:</strong> ${Math.abs(lieAngle).toFixed(1)}¬∞ ${lieDir} √ó ${lieMultiplier} = ${adjustmentText}¬∞`);
                    calcParts.push(`<strong>Effective face:</strong> ${originalFace.toFixed(1)}¬∞ ${adjustmentText}¬∞ = ${face.toFixed(1)}¬∞`);
                }
                
                calcParts.push(`<strong>Start direction (face):</strong> ${face.toFixed(1)}¬∞ √ó 3 = ${faceYards.toFixed(1)} yards ${faceDir}`);
                
                // Show vertical impact multiplier if applicable (Level 5+)
                if (diffLevel >= 5 && Math.abs(verticalImpact) > 0.5) {
                    const verticalDir = verticalImpact > 0 ? "high" : "low";
                    const effect = verticalGearMultiplier > 1.0 ? "amplifies" : "dampens";
                    calcParts.push(`<strong>Vertical impact:</strong> ${Math.abs(verticalImpact).toFixed(1)}mm ${verticalDir} √ó ${verticalGearMultiplier.toFixed(2)} multiplier ${effect} curve`);
                }
                
                
                // BUILD 3-BOX EXPLANATION LAYOUT
                let explanationHTML = '';
                
                // Info note at top
                explanationHTML += '<div class="bg-gray-100 border border-gray-300 rounded-lg p-2 mb-4 text-sm text-center text-gray-700">';
                explanationHTML += '‚ÑπÔ∏è Note: Negative (-) = Left, Positive (+) = Right';
                explanationHTML += '</div>';
                
                // Top row: Start Direction (left) and Curve Components (right)
                explanationHTML += '<div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-4">';
                
                // LEFT BOX: Start Direction (Blue)
                explanationHTML += '<div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-4 shadow-md">';
                explanationHTML += '<div class="flex items-center gap-2 mb-3"><span class="text-2xl">üìç</span><strong class="text-lg">START DIRECTION</strong></div>';
                
                // Lie angle if applicable
                if (lieAngleAdjustment !== 0) {
                    const lieMultipliers = { driver: 0.3, wood: 0.4, long_iron: 0.45, mid_iron: 0.5, wedge: 0.7 };
                    const lieMultiplier = lieMultipliers[clubType];
                    explanationHTML += `<div class="text-sm mb-1">Lie: ${Math.abs(lieAngle).toFixed(1)}¬∞ ${lieAngle > 0 ? 'upright' : 'flat'} √ó ${lieMultiplier} = ${lieAngleAdjustment > 0 ? '+' : ''}${lieAngleAdjustment.toFixed(1)}¬∞</div>`;
                    explanationHTML += `<div class="text-sm mb-2">Effective face: ${originalFace.toFixed(1)}¬∞ ${lieAngleAdjustment > 0 ? '+' : ''}${lieAngleAdjustment.toFixed(1)}¬∞ = ${face.toFixed(1)}¬∞</div>`;
                }
                
                explanationHTML += `<div class="font-semibold">${face.toFixed(1)}¬∞ √ó 3 = ${faceContribution > 0 ? '+' : ''}${faceContribution.toFixed(1)} yards</div>`;
                explanationHTML += `<div class="text-sm text-gray-600 mt-1">${faceContribution > 0 ? 'Right' : faceContribution < 0 ? 'Left' : 'Straight'}</div>`;
                explanationHTML += '</div>';
                
                // RIGHT BOX: Curve Components (Purple)
                explanationHTML += '<div class="bg-gradient-to-br from-purple-50 to-pink-50 border-2 border-purple-200 rounded-xl p-4 shadow-md">';
                explanationHTML += '<div class="flex items-center gap-2 mb-3"><span class="text-2xl">üåÄ</span><strong class="text-lg">CURVE COMPONENTS</strong></div>';
                
                // Face-to-path calculation
                explanationHTML += `<div class="mb-2"><strong>Face-to-path:</strong> ${face.toFixed(1)}¬∞ - ${path.toFixed(1)}¬∞ = ${baseFaceToPath.toFixed(1)}¬∞</div>`;
                
                // Modifiers section
                let modifiers = [];
                if (diffLevel >= 5 && Math.abs(verticalImpact) > 0.5) {
                    const verticalDir = verticalImpact > 0 ? "high" : "low";
                    modifiers.push(`Vertical: ${Math.abs(verticalImpact).toFixed(1)}mm ${verticalDir} √ó ${verticalGearMultiplier.toFixed(2)} ${verticalGearMultiplier > 1.0 ? 'amplifies' : 'dampens'}`);
                }
                if (windEffect !== 0) {
                    const windEffectText = windMultiplier > 1.0 ? 'amplifies' : windMultiplier < 1.0 ? 'dampens' : 'minimal effect';
                    modifiers.push(`Wind: ${windDir} √ó ${windMultiplier.toFixed(2)} ${windEffectText}`);
                }
                if (modifiers.length > 0) {
                    modifiers.forEach(mod => {
                        explanationHTML += `<div class="text-sm text-gray-700 mb-1">${mod}</div>`;
                    });
                    explanationHTML += '<div class="mb-2"></div>'; // spacer
                }
                
                // Face-to-path curve calculation - grouped together
                const baseFTPDir = baseFaceToPath < 0 ? "draw" : "fade";
                const baseFTPYards = Math.abs(baseCurveContribution);
                explanationHTML += '<div class="bg-white/50 rounded p-2 mb-3">';
                explanationHTML += `<div class="text-sm font-medium mb-1">Curve from face-to-path:</div>`;
                explanationHTML += `<div class="font-semibold">${baseFaceToPath.toFixed(1)}¬∞ ${baseFTPDir} √ó ${physics.curveMultiplier}${windMultiplier !== 1.0 ? ' √ó ' + windMultiplier.toFixed(2) : ''}${verticalGearMultiplier !== 1.0 ? ' √ó ' + verticalGearMultiplier.toFixed(2) : ''}</div>`;
                explanationHTML += `<div class="font-bold text-lg mt-1">= ${baseCurveContribution > 0 ? '+' : ''}${baseCurveContribution.toFixed(1)} yards ${baseCurveContribution > 0 ? 'right' : baseCurveContribution < 0 ? 'left' : 'straight'}</div>`;
                explanationHTML += '</div>';
                
                // Gear effect if present - grouped together
                if (gearEffect !== 0) {
                    const gearDir = gearEffect > 0 ? "fade" : "draw";
                    const gearYards = Math.abs(gearContribution);
                    const gearRelation = (gearEffect > 0 && baseFaceToPath > 0) || (gearEffect < 0 && baseFaceToPath < 0) ? "additional" : "opposing";
                    const highlightClass = gearRelation === "opposing" ? 'border-red-300 bg-red-50/50' : 'bg-white/50';
                    const warningIcon = gearRelation === "opposing" ? "‚ö†Ô∏è " : "";
                    const textClass = gearRelation === "opposing" ? 'text-red-700' : '';
                    
                    explanationHTML += `<div class="${highlightClass} rounded p-2 border-2">`;
                    explanationHTML += `<div class="text-sm font-medium mb-1 ${textClass}"><strong>${warningIcon}Gear effect (${gearRelation}):</strong> ${impactLocationText}</div>`;
                    explanationHTML += `<div class="font-semibold">${Math.abs(gearEffect).toFixed(1)}¬∞ ${gearDir} √ó ${physics.curveMultiplier}${windMultiplier !== 1.0 ? ' √ó ' + windMultiplier.toFixed(2) : ''}${verticalGearMultiplier !== 1.0 ? ' √ó ' + verticalGearMultiplier.toFixed(2) : ''}</div>`;
                    explanationHTML += `<div class="font-bold text-lg mt-1">= ${gearContribution > 0 ? '+' : ''}${gearContribution.toFixed(1)} yards ${gearContribution > 0 ? 'right' : 'left'}</div>`;
                    explanationHTML += '</div>';
                }
                
                explanationHTML += '</div>';
                explanationHTML += '</div>'; // End top row grid
                
                // BOTTOM BOX: Final Calculation (Green) - Centered
                explanationHTML += '<div class="max-w-2xl mx-auto">';
                explanationHTML += '<div class="bg-gradient-to-br from-green-50 to-emerald-50 border-2 border-green-200 rounded-xl p-4 shadow-md">';
                explanationHTML += '<div class="flex items-center gap-2 mb-3 justify-center"><span class="text-2xl">üéØ</span><strong class="text-lg">FINAL CALCULATION</strong></div>';
                
                // Build calculation string with all components AND labels
                let calcString = `${faceContribution > 0 ? '+' : ''}${faceContribution.toFixed(1)} (start)`;
                calcString += ` ${baseCurveContribution > 0 ? '+' : ''}${baseCurveContribution.toFixed(1)} (curve)`;
                if (gearEffect !== 0) {
                    calcString += ` ${gearContribution > 0 ? '+' : ''}${gearContribution.toFixed(1)} (gear)`;
                }
                if (windEffect !== 0) {
                    calcString += ` ${windEffect > 0 ? '+' : ''}${windEffect.toFixed(1)} (wind)`;
                }
                calcString += ` = ${netOffline > 0 ? '+' : ''}${netOffline.toFixed(1)}`;
                
                explanationHTML += `<div class="text-center font-semibold text-lg mb-2">${calcString}</div>`;
                explanationHTML += `<div class="text-center text-2xl font-bold" style="color: var(--augusta-green);">${roundedYards} yards ${offlineDir}</div>`;
                explanationHTML += '</div>';
                explanationHTML += '</div>';
                
                // Trick scenario notice if applicable
                if (isTrickScenario) {
                    explanationHTML += '<div class="mt-4 bg-yellow-50 border-2 border-yellow-500 rounded-lg p-3">';
                    explanationHTML += '<strong>‚ö° TRICK SCENARIO:</strong> This featured strong gear effect working AGAINST the face-to-path relationship. Watch for opposing forces!';
                    explanationHTML += '</div>';
                }
                
                // Separate the offline distance question (always last to avoid spoilers)
                const offlineQuestion = {
                    question: "How far offline will the ball finish from the target?",
                    options: opts,
                    correct: corr,
                    explanation: explanationHTML
                };
                
                // Level 7+: Filter out obvious questions to increase challenge
                if (diffLevel >= 4) {
                    basicQuestions = basicQuestions.filter(q => {
                        // Skip "start direction" if face angle is too obvious (|face| > 2¬∞)
                        if (q.question.includes("start left or right") && Math.abs(face) > 2) {
                            return false;
                        }
                        
                        // Skip basic "shot shape" if no competing forces (gear effect not opposing face-to-path)
                        if (q.question === "What will be the shot shape?") {
                            const hasCompetingForces = gearEffect !== 0 && 
                                ((gearEffect > 0 && baseFaceToPath < 0) || (gearEffect < 0 && baseFaceToPath > 0));
                            if (!hasCompetingForces && Math.abs(baseFaceToPath) > 3) {
                                return false; // Too obvious - strong face-to-path with no opposition
                            }
                        }
                        
                        return true; // Keep all other questions
                    });
                }
                
                // Select questions from pools in proper order: basic ‚Üí spoiler ‚Üí offline distance ‚Üí hypothetical
                const numCards = difficultyLevels[diffLevel - 1].cards;
                
                // Strategy: Fill cards in priority order
                // - Basic and spoiler questions first
                // - Offline distance second-to-last (reveals where original shot goes)
                // - Hypothetical absolutely last (what-if scenarios after knowing original)
                
                const hasHypothetical = hypotheticalQuestions.length > 0;
                const slotsForBasicSpoiler = hasHypothetical ? numCards - 2 : numCards - 1; // Reserve last 2 for offline + hypothetical, or just last 1 for offline
                
                // Combine basic and spoiler questions, randomize, and take what we need
                const nonHypotheticalQuestions = [...basicQuestions, ...spoilerQuestions];
                const selectedQuestions = nonHypotheticalQuestions.sort(() => Math.random() - 0.5).slice(0, slotsForBasicSpoiler);
                selectedQuestions.forEach(q => cards.push(q));
                
                // Add offline distance question second-to-last (reveals where original shot goes)
                cards.push(offlineQuestion);
                
                // Add hypothetical question last (what-if scenarios come after knowing original result)
                if (hasHypothetical) {
                    cards.push(hypotheticalQuestions[0]);
                }
            }
            
            return { data, cards, isTrickScenario, originalFace, effectiveFace: face, lieAngleAdjustment };
        }

        function getShapeDesc(name) {
            const descs = {
                "Straight": "starts on target, flies straight",
                "Push": "starts right, flies straight",
                "Pull": "starts left, flies straight",
                "Draw": "starts on target, curves left",
                "Fade": "starts on target, curves right",
                "Hook": "starts on target, curves severely left",
                "Slice": "starts on target, curves severely right",
                "Push-draw": "starts right, curves left",
                "Push-fade": "starts right, curves right",
                "Push-hook": "starts right, curves severely left",
                "Push-slice": "starts right, curves severely right",
                "Pull-draw": "starts left, curves left",
                "Pull-fade": "starts left, curves right",
                "Pull-hook": "starts left, curves severely left",
                "Pull-slice": "starts left, curves severely right"
            };
            return descs[name] || "";
        }


        function generateFaceToPathQuestion(face, path, diffLevel, lieAngleAdjustment = 0, originalFace = null) {
            const correctAnswer = face - path;
            const numOptions = diffLevel <= 3 ? 3 : diffLevel <= 6 ? 4 : diffLevel <= 9 ? 5 : 6;
            
            // At Level 4+, if lie angle exists, clarify we're using effective face
            const hasLie = diffLevel >= 4 && lieAngleAdjustment !== 0;
            const questionText = hasLie ? 
                "What is the face-to-path angle? (Use effective face after lie adjustment)" : 
                "What is the face-to-path angle?";
            
            // Generate wrong answers nearby the correct one
            let options = [correctAnswer];
            const possibleWrong = [
                correctAnswer + 1, correctAnswer - 1,
                correctAnswer + 2, correctAnswer - 2,
                correctAnswer + 3, correctAnswer - 3,
                face + path, // Common mistake: adding instead of subtracting
                path - face  // Common mistake: reversing the subtraction
            ].filter(val => val !== correctAnswer);
            
            // Shuffle and take needed number of wrong answers
            const wrongAnswers = possibleWrong.sort(() => Math.random() - 0.5).slice(0, numOptions - 1);
            options.push(...wrongAnswers);
            options = options.sort(() => Math.random() - 0.5);
            
            let explanation = `<div><strong>Calculation:</strong> Face-to-path = Face - Path</div>`;
            if (hasLie && originalFace !== null) {
                explanation += `<div>Original face: ${originalFace.toFixed(1)}¬∞, Lie adjustment: ${lieAngleAdjustment > 0 ? '+' : ''}${lieAngleAdjustment.toFixed(1)}¬∞</div>`;
                explanation += `<div>Effective face: ${face.toFixed(1)}¬∞</div>`;
            }
            explanation += `<div>${face.toFixed(1)}¬∞ - (${path.toFixed(1)}¬∞) = ${correctAnswer.toFixed(1)}¬∞</div>`;
            
            return {
                question: questionText,
                options: options.map(o => o.toFixed(1) + "¬∞"),
                correct: correctAnswer.toFixed(1) + "¬∞",
                explanation: explanation
            };
        }

        function generateEffectiveFaceQuestion(originalFace, lieAngleAdjustment, effectiveFace, diffLevel, lieAngle, clubType) {
            const correctAnswer = effectiveFace;
            const numOptions = diffLevel <= 4 ? 4 : diffLevel <= 5 ? 5 : 6;
            
            // Get multiplier
            const lieMultipliers = { driver: 0.3, wood: 0.4, long_iron: 0.45, mid_iron: 0.5, wedge: 0.7 };
            const lieMultiplier = lieMultipliers[clubType];
            const lieDirection = lieAngle > 0 ? "upright" : "flat";
            
            // Generate wrong answers (use varied increments, not just 0.5)
            let options = [correctAnswer];
            const possibleWrong = [
                correctAnswer + 0.3, correctAnswer - 0.3,
                correctAnswer + 0.7, correctAnswer - 0.7,
                correctAnswer + 1.2, correctAnswer - 1.2,
                correctAnswer + 1.8, correctAnswer - 1.8,
                correctAnswer + 2.4, correctAnswer - 2.4,
                originalFace, // Common mistake: forgetting lie adjustment
                originalFace - lieAngleAdjustment // Wrong sign
            ].filter(val => Math.abs(val - correctAnswer) > 0.1);
            
            const wrongAnswers = possibleWrong.sort(() => Math.random() - 0.5).slice(0, numOptions - 1);
            options.push(...wrongAnswers);
            options = options.sort(() => Math.random() - 0.5);
            
            return {
                question: "What is the effective face angle after applying the lie adjustment?",
                options: options.map(o => o.toFixed(1) + "¬∞"),
                correct: correctAnswer.toFixed(1) + "¬∞",
                explanation: `<div class="space-y-2"><div><strong>Step 1: Calculate lie adjustment</strong></div><div>${Math.abs(lieAngle).toFixed(1)}¬∞ ${lieDirection} √ó ${lieMultiplier} (${clubType} multiplier) √ó -1 = ${lieAngleAdjustment.toFixed(1)}¬∞</div><div class="text-sm text-gray-600">(Upright = negative adjustment, Flat = positive adjustment)</div><div class="mt-3"><strong>Step 2: Apply to original face</strong></div><div>Effective face = ${originalFace.toFixed(1)}¬∞ + (${lieAngleAdjustment > 0 ? '+' : ''}${lieAngleAdjustment.toFixed(1)}¬∞) = <strong>${effectiveFace.toFixed(1)}¬∞</strong></div></div>`
            };
        }

        function generateStartPositionQuestion(face, physics, diffLevel, clubType) {
            // Club-specific start distance multipliers (realistic TrackMan values)
            const startMultipliers = {
                driver: 2.5,
                wood: 2.3,
                long_iron: 2.0,
                mid_iron: 1.8,
                wedge: 1.5
            };
            const startMultiplier = startMultipliers[clubType] || 2.5;
            const startYards = face * startMultiplier;
            const numOptions = diffLevel <= 3 ? 3 : diffLevel <= 6 ? 4 : diffLevel <= 9 ? 5 : 6;
            
            // Create ranges
            let correctRange;
            if (Math.abs(startYards) <= 2) {
                correctRange = "Straight at target";
            } else if (startYards > 0) {
                if (startYards <= 5) correctRange = "0-2 yards right";
                else if (startYards <= 8) correctRange = "3-5 yards right";
                else if (startYards <= 12) correctRange = "6-8 yards right";
                else correctRange = "9+ yards right";
            } else {
                if (startYards >= -5) correctRange = "0-2 yards left";
                else if (startYards >= -8) correctRange = "3-5 yards left";
                else if (startYards >= -12) correctRange = "6-8 yards left";
                else correctRange = "9+ yards left";
            }
            
            const allOptions = [
                "Straight at target",
                "0-2 yards right", "3-5 yards right", "6-8 yards right", "9+ yards right",
                "0-2 yards left", "3-5 yards left", "6-8 yards left", "9+ yards left"
            ];
            
            // Get wrong answers
            const wrongOptions = allOptions.filter(o => o !== correctRange).sort(() => Math.random() - 0.5).slice(0, numOptions - 1);
            const options = [correctRange, ...wrongOptions].sort(() => Math.random() - 0.5);
            
            return {
                question: "Where will the ball start?",
                options: options,
                correct: correctRange,
                explanation: `<div><strong>Face angle:</strong> ${face.toFixed(1)}¬∞</div><div><strong>Start distance:</strong> ${Math.abs(startYards).toFixed(1)} yards ${startYards > 0 ? 'right' : 'left'}</div><div>Face angle controls ${Math.round(physics.startFaceInfluence * 100)}% of start direction (~${startMultiplier} yards per degree for this club)</div>`
            };
        }

        function generatePrimaryCauseQuestion(face, path, gearEffect, windEffect, diffLevel) {
            const baseFaceToPath = face - path;
            const faceContribution = Math.abs(face * 3);
            const pathContribution = Math.abs(baseFaceToPath * 5);
            const gearContribution = Math.abs(gearEffect * 5);
            const windContribution = Math.abs(windEffect);
            
            // Only include variables that actually exist
            const causes = [
                { name: "Face angle", value: faceContribution },
                { name: "Face-to-path", value: pathContribution }
            ];
            
            if (gearEffect !== 0) {
                causes.push({ name: "Gear effect", value: gearContribution });
            }
            
            if (windEffect !== 0) {
                causes.push({ name: "Wind", value: windContribution });
            }
            
            causes.sort((a, b) => b.value - a.value);
            
            const numOptions = Math.min(diffLevel <= 9 ? 5 : 6, causes.length);
            const options = causes.slice(0, numOptions).map(c => c.name).sort(() => Math.random() - 0.5);
            
            // Build ranking explanation (Option 3 - ranking without values)
            const rankingText = causes.map(c => c.name).join(' > ');
            
            return {
                question: "What is the PRIMARY cause of the ball's final position?",
                options: options,
                correct: causes[0].name,
                explanation: `<div><strong>${causes[0].name}</strong> has the biggest impact</div><div class="text-sm text-gray-600 mt-2">Ranking (largest to smallest): ${rankingText}</div>`
            };
        }

        function generateNetCurveQuestion(baseFaceToPath, gearEffect, windEffect, diffLevel) {
            const totalCurve = baseFaceToPath + gearEffect + (windEffect / 5); // Wind has less effect on curve
            
            // Thresholds: Straight ¬±0.5¬∞, Draw/Fade ¬±0.5-3¬∞, Hook/Slice >3¬∞
            let netDirection;
            if (Math.abs(totalCurve) <= 0.5) {
                netDirection = "Straight";
            } else if (totalCurve < -3) {
                netDirection = "Hook (left)";
            } else if (totalCurve < -0.5) {
                netDirection = "Draw (left)";
            } else if (totalCurve > 3) {
                netDirection = "Slice (right)";
            } else {
                netDirection = "Fade (right)";
            }
            
            const numOptions = diffLevel <= 9 ? 5 : 6;
            const allOptions = ["Draw (left)", "Fade (right)", "Straight", "Hook (left)", "Slice (right)"];
            const wrongOptions = allOptions.filter(o => o !== netDirection).sort(() => Math.random() - 0.5).slice(0, numOptions - 1);
            const options = [netDirection, ...wrongOptions].sort(() => Math.random() - 0.5);
            
            // Build explanation
            let explanationHTML = '<div class="space-y-2">';
            explanationHTML += `<div><strong>Base face-to-path:</strong> ${baseFaceToPath.toFixed(1)}¬∞</div>`;
            if (gearEffect !== 0) {
                explanationHTML += `<div><strong>Gear effect:</strong> ${gearEffect > 0 ? '+' : ''}${gearEffect.toFixed(1)}¬∞</div>`;
            }
            if (windEffect !== 0) {
                explanationHTML += `<div><strong>Wind influence:</strong> ${(windEffect / 5).toFixed(1)}¬∞</div>`;
            }
            explanationHTML += `<div class="mt-2 pt-2 border-t"><strong>Net curve:</strong> ${totalCurve.toFixed(1)}¬∞ = ${netDirection}</div>`;
            explanationHTML += `<div class="text-sm text-gray-600 mt-2">Thresholds: Straight (¬±0.5¬∞), Draw/Fade (0.5-3¬∞), Hook/Slice (>3¬∞)</div>`;
            explanationHTML += '</div>';
            
            return {
                question: "After accounting for ALL factors, will the ball curve left or right?",
                options: options,
                correct: netDirection,
                explanation: explanationHTML
            };
        }

        function generateHypotheticalQuestion(face, path, faceContribution, curveContribution, windEffect, diffLevel, curveMultiplier, windMultiplier, verticalGearMultiplier, gearEffect) {
            // What if face was 2¬∞ more closed?
            const newFace = face - 2;
            const newFaceContribution = newFace * 3;
            
            // CRITICAL: Recalculate curve with new face-to-path
            const newFaceToPath = newFace - path;
            const newBaseCurveContribution = newFaceToPath * curveMultiplier * windMultiplier * verticalGearMultiplier;
            const newGearContribution = gearEffect * curveMultiplier * windMultiplier * verticalGearMultiplier; // Gear stays same
            const newCurveContribution = newBaseCurveContribution + newGearContribution;
            
            const newNetOffline = newFaceContribution + newCurveContribution + windEffect;
            const newRoundedYards = Math.round(Math.abs(newNetOffline));
            const newDir = newNetOffline > 0 ? "right" : "left";
            
            const numOptions = diffLevel <= 9 ? 5 : 6;
            let correctRange;
            if (newRoundedYards <= 6) correctRange = `0-6 yards ${newDir}`;
            else if (newRoundedYards <= 13) correctRange = `7-13 yards ${newDir}`;
            else if (newRoundedYards <= 20) correctRange = `14-20 yards ${newDir}`;
            else if (newRoundedYards <= 27) correctRange = `21-27 yards ${newDir}`;
            else correctRange = `28+ yards ${newDir}`;
            
            const allOptions = [
                "0-6 yards left", "7-13 yards left", "14-20 yards left", "21-27 yards left", "28+ yards left",
                "0-6 yards right", "7-13 yards right", "14-20 yards right", "21-27 yards right", "28+ yards right"
            ];
            const wrongOptions = allOptions.filter(o => o !== correctRange).sort(() => Math.random() - 0.5).slice(0, numOptions - 1);
            const options = [correctRange, ...wrongOptions].sort(() => Math.random() - 0.5);
            
            // Build detailed explanation
            const originalFaceToPath = face - path;
            let explanationHTML = '<div class="space-y-2">';
            explanationHTML += '<div class="font-bold text-lg mb-3">Hypothetical Calculation:</div>';
            explanationHTML += `<div><strong>Current face:</strong> ${face.toFixed(1)}¬∞</div>`;
            explanationHTML += `<div><strong>Close face by 2¬∞:</strong> ${face.toFixed(1)}¬∞ - 2¬∞ = ${newFace.toFixed(1)}¬∞</div>`;
            explanationHTML += `<div><strong>Path stays:</strong> ${path.toFixed(1)}¬∞</div>`;
            explanationHTML += '<div class="mt-3 pt-3 border-t border-gray-300">';
            explanationHTML += `<div><strong>New start direction:</strong> ${newFace.toFixed(1)}¬∞ √ó 3 = ${newFaceContribution.toFixed(1)} yards ${newFaceContribution > 0 ? 'right' : newFaceContribution < 0 ? 'left' : 'straight'}</div>`;
            explanationHTML += `<div><strong>New face-to-path:</strong> ${newFace.toFixed(1)}¬∞ - ${path.toFixed(1)}¬∞ = ${newFaceToPath.toFixed(1)}¬∞</div>`;
            explanationHTML += `<div><strong>New curve:</strong> ${newFaceToPath.toFixed(1)}¬∞ √ó ${curveMultiplier} = ${newBaseCurveContribution.toFixed(1)} yards ${newBaseCurveContribution > 0 ? 'right' : newBaseCurveContribution < 0 ? 'left' : 'straight'}</div>`;
            if (gearEffect !== 0) {
                explanationHTML += `<div><strong>Gear effect (unchanged):</strong> ${newGearContribution.toFixed(1)} yards ${newGearContribution > 0 ? 'right' : 'left'}</div>`;
            }
            if (windEffect !== 0) {
                explanationHTML += `<div><strong>Wind (unchanged):</strong> ${windEffect.toFixed(1)} yards ${windEffect > 0 ? 'right' : 'left'}</div>`;
            }
            explanationHTML += '</div>';
            explanationHTML += '<div class="mt-3 pt-3 border-t border-gray-300 font-bold">';
            explanationHTML += `<div><strong>Total:</strong> ${newFaceContribution.toFixed(1)} + ${newCurveContribution.toFixed(1)}${windEffect !== 0 ? ' + ' + windEffect.toFixed(1) : ''} = ${newNetOffline.toFixed(1)} yards</div>`;
            explanationHTML += `<div class="text-lg" style="color: var(--augusta-green);"><strong>Final result:</strong> ${newRoundedYards} yards ${newDir}</div>`;
            explanationHTML += '</div></div>';
            
            return {
                question: "If you CLOSED the face by 2¬∞ (keeping path the same), where would the ball finish?",
                options: options,
                correct: correctRange,
                explanation: explanationHTML
            };
        }

        function generateLeastImpactQuestion(face, path, gearEffect, windEffect, diffLevel) {
            const faceContribution = Math.abs(face * 3);
            const pathContribution = Math.abs((face - path) * 5);
            const gearContribution = Math.abs(gearEffect * 5);
            const windContribution = Math.abs(windEffect);
            
            // Only include variables that actually exist in the scenario
            const causes = [
                { name: "Face angle", value: faceContribution },
                { name: "Face-to-path", value: pathContribution }
            ];
            
            if (gearEffect !== 0) {
                causes.push({ name: "Gear effect", value: gearContribution });
            }
            
            if (windEffect !== 0) {
                causes.push({ name: "Wind", value: windContribution });
            }
            
            causes.sort((a, b) => a.value - b.value); // Sort ascending - least first
            
            const numOptions = Math.min(diffLevel <= 9 ? 5 : 6, causes.length);
            const options = causes.slice(0, numOptions).map(c => c.name).sort(() => Math.random() - 0.5);
            
            // Build ranking explanation (Option 3 - ranking without values)
            const rankingText = causes.map(c => c.name).join(' < ');
            
            return {
                question: "Which variable has the LEAST impact on the ball's final position?",
                options: options,
                correct: causes[0].name,
                explanation: `<div><strong>${causes[0].name}</strong> has the smallest impact</div><div class="text-sm text-gray-600 mt-2">Ranking (smallest to largest): ${rankingText}</div>`
            };
        }

        // Level 2: Will this shot curve? (Yes/No)
        function generateWillCurveQuestion(baseFaceToPath, diffLevel) {
            const willCurve = Math.abs(baseFaceToPath) > 1; // Threshold for "curve" vs "straight"
            const correct = willCurve ? "Yes" : "No";
            
            return {
                question: "Will this shot curve?",
                options: ["Yes", "No"],
                correct: correct,
                explanation: `<div><strong>Face-to-path:</strong> ${baseFaceToPath.toFixed(1)}¬∞</div><div>${Math.abs(baseFaceToPath) > 1 ? 'Face and path differ significantly, creating sidespin that causes curve.' : 'Face and path are nearly aligned, ball flies relatively straight.'}</div>`
            };
        }

        // Level 2: Which direction will it curve?
        function generateCurveDirectionQuestion(baseFaceToPath, diffLevel, clubType) {
            // Club-specific "straight" thresholds - represents ~2-3 yards offline
            const straightThresholds = {
                driver: 0.25,      // ~3 yards offline = acceptable straight
                wood: 0.35,        // ~2.6 yards
                long_iron: 0.45,   // ~2.4 yards
                mid_iron: 0.55,    // ~2.5 yards
                wedge: 0.80        // ~1.0 yards
            };
            
            const threshold = straightThresholds[clubType] || 0.5;
            
            let correct;
            if (Math.abs(baseFaceToPath) <= threshold) {
                correct = "No curve (straight)";
            } else if (baseFaceToPath < 0) {
                correct = "Left";
            } else {
                correct = "Right";
            }
            
            const options = ["Left", "Right", "No curve (straight)"];
            
            return {
                question: "Which direction will the ball curve?",
                options: options,
                correct: correct,
                explanation: `<div><strong>Face-to-path:</strong> ${baseFaceToPath.toFixed(1)}¬∞</div><div>${Math.abs(baseFaceToPath) <= threshold ? `Face and path nearly aligned (within ${threshold}¬∞) ‚Üí flies relatively STRAIGHT` : baseFaceToPath < 0 ? 'Face is LEFT of path ‚Üí draw spin ‚Üí curves LEFT' : 'Face is RIGHT of path ‚Üí fade spin ‚Üí curves RIGHT'}</div>`
            };
        }


        // Level 5-6: Face percentage control question
        function generateFaceSquareStartQuestion(face, path, physics, diffLevel) {
            // Practical question: If face was square, where would ball start?
            // Tests understanding that face controls start direction
            
            const currentStart = face < -0.5 ? "Left of target" : face > 0.5 ? "Right of target" : "Straight at target";
            
            return {
                question: "If you squared your clubface to 0¬∞ (keeping the same path), where would the ball start?",
                options: ["Left of target", "Right of target", "Straight at target", "Cannot determine"],
                correct: "Straight at target",
                explanation: `<div><strong>Current face:</strong> ${face.toFixed(1)}¬∞ ‚Üí starts ${currentStart}</div><div><strong>If face was 0¬∞ (square):</strong> Ball would start straight at target</div><div class="mt-2"><strong>Key principle:</strong> Face angle controls ~${Math.round(physics.startFaceInfluence * 100)}% of start direction. Square face (0¬∞) = straight start, regardless of path.</div><div class="mt-2 text-sm text-gray-600">This is why "aim at your target" means square face, not path!</div>`
            };
        }

        // Level 5-6: Curve comparison question
        function generateCurveComparisonQuestion(baseFaceToPath, gearEffect, clubType, diffLevel) {
            const faceToPathCurve = Math.abs(baseFaceToPath) * 5; // Approximate yards of curve
            const gearCurve = Math.abs(gearEffect) * 5;
            
            const correct = faceToPathCurve > gearCurve ? 
                `${Math.abs(baseFaceToPath).toFixed(1)}¬∞ face-to-path` : 
                `${Math.abs(gearEffect * 20).toFixed(1)}mm impact location`;
            
            const options = [
                `${Math.abs(baseFaceToPath).toFixed(1)}¬∞ face-to-path`,
                `${Math.abs(gearEffect * 20).toFixed(1)}mm impact location`,
                "They produce equal curve"
            ];
            
            return {
                question: "Which will produce MORE curve on this shot?",
                options: options,
                correct: correct,
                explanation: `<div><strong>Face-to-path curve:</strong> ~${faceToPathCurve.toFixed(1)} yards</div><div><strong>Gear effect curve:</strong> ~${gearCurve.toFixed(1)} yards</div><div>Face-to-path is the dominant factor in ball flight curvature.</div>`
            };
        }

        // Level 7: Lie angle effect direction
        function generateLieEffectDirectionQuestion(lieAngle, diffLevel) {
            let correct;
            if (lieAngle > 0.5) {
                correct = "Closes the face (ball goes left)";
            } else if (lieAngle < -0.5) {
                correct = "Opens the face (ball goes right)";
            } else {
                correct = "No significant effect";
            }
            
            const options = [
                "Opens the face (ball goes right)",
                "Closes the face (ball goes left)",
                "No significant effect"
            ];
            
            return {
                question: "How will the lie angle affect the face angle?",
                options: options,
                correct: correct,
                explanation: `<div><strong>Lie angle:</strong> ${Math.abs(lieAngle).toFixed(1)}¬∞ ${lieAngle > 0 ? 'upright' : 'flat'}</div><div>${lieAngle > 0.5 ? 'Upright lie CLOSES the face (aims left)' : lieAngle < -0.5 ? 'Flat lie OPENS the face (aims right)' : 'Standard lie has minimal effect'}</div>`
            };
        }

        // Level 7: Standard lie hypothetical
        function generateStandardLieHypotheticalQuestion(face, originalFace, lieAngleAdjustment, path, windEffect, diffLevel, curveMultiplier, windMultiplier, verticalGearMultiplier, gearEffect) {
            // Calculate what would happen with standard lie (no lie adjustment)
            const standardFace = originalFace; // Original face without lie adjustment
            const standardFaceContribution = standardFace * 3;
            
            // CRITICAL: Recalculate curve with original face (path stays the same)
            const standardBaseFaceToPath = standardFace - path;
            const standardBaseCurve = standardBaseFaceToPath * curveMultiplier * windMultiplier * verticalGearMultiplier;
            const standardGearCurve = (gearEffect || 0) * curveMultiplier * windMultiplier * verticalGearMultiplier;
            const standardCurveContribution = standardBaseCurve + standardGearCurve;
            
            const standardNetOffline = standardFaceContribution + standardCurveContribution + windEffect;
            const standardRoundedYards = Math.round(Math.abs(standardNetOffline));
            const standardDir = standardNetOffline > 0 ? "right" : "left";
            
            const numOptions = diffLevel <= 9 ? 5 : 6;
            let correctRange;
            if (standardRoundedYards <= 6) correctRange = `0-6 yards ${standardDir}`;
            else if (standardRoundedYards <= 13) correctRange = `7-13 yards ${standardDir}`;
            else if (standardRoundedYards <= 20) correctRange = `14-20 yards ${standardDir}`;
            else if (standardRoundedYards <= 27) correctRange = `21-27 yards ${standardDir}`;
            else correctRange = `28+ yards ${standardDir}`;
            
            const allOptions = [
                "0-6 yards left", "7-13 yards left", "14-20 yards left", "21-27 yards left", "28+ yards left",
                "0-6 yards right", "7-13 yards right", "14-20 yards right", "21-27 yards right", "28+ yards right"
            ];
            const wrongOptions = allOptions.filter(o => o !== correctRange).sort(() => Math.random() - 0.5).slice(0, numOptions - 1);
            const options = [correctRange, ...wrongOptions].sort(() => Math.random() - 0.5);
            
            // Build detailed explanation
            let explanationHTML = '<div class="space-y-2">';
            explanationHTML += '<div class="font-bold text-lg mb-3">Standard Lie Calculation:</div>';
            explanationHTML += `<div><strong>Current effective face:</strong> ${face.toFixed(1)}¬∞ (with ${lieAngleAdjustment.toFixed(1)}¬∞ lie adjustment)</div>`;
            explanationHTML += `<div><strong>Original face (no lie adjustment):</strong> ${originalFace.toFixed(1)}¬∞</div>`;
            explanationHTML += `<div><strong>Path (unchanged):</strong> ${path.toFixed(1)}¬∞</div>`;
            explanationHTML += '<div class="mt-3 pt-3 border-t border-gray-300">';
            explanationHTML += `<div><strong>Standard lie start:</strong> ${standardFace.toFixed(1)}¬∞ √ó 3 = ${standardFaceContribution.toFixed(1)} yards ${standardFaceContribution > 0 ? 'right' : standardFaceContribution < 0 ? 'left' : 'straight'}</div>`;
            explanationHTML += `<div><strong>Standard lie face-to-path:</strong> ${standardBaseFaceToPath.toFixed(1)}¬∞</div>`;
            explanationHTML += `<div><strong>Standard lie curve:</strong> ${standardBaseFaceToPath.toFixed(1)}¬∞ √ó ${curveMultiplier.toFixed(1)} = ${standardCurveContribution.toFixed(1)} yards ${standardCurveContribution > 0 ? 'right' : standardCurveContribution < 0 ? 'left' : 'straight'}</div>`;
            if (windEffect !== 0) {
                explanationHTML += `<div><strong>Wind (unchanged):</strong> ${windEffect.toFixed(1)} yards ${windEffect > 0 ? 'right' : 'left'}</div>`;
            }
            explanationHTML += '</div>';
            explanationHTML += '<div class="mt-3 pt-3 border-t border-gray-300 font-bold">';
            explanationHTML += `<div><strong>Total:</strong> ${standardFaceContribution.toFixed(1)} + ${standardCurveContribution.toFixed(1)}${windEffect !== 0 ? ' + ' + windEffect.toFixed(1) : ''} = ${standardNetOffline.toFixed(1)} yards</div>`;
            explanationHTML += `<div class="text-lg" style="color: var(--augusta-green);"><strong>Final result with standard lie:</strong> ${standardRoundedYards} yards ${standardDir}</div>`;
            explanationHTML += '</div></div>';
            
            return {
                question: "If this shot was hit with STANDARD lie angle instead, where would the ball finish?",
                options: options,
                correct: correctRange,
                explanation: explanationHTML
            };
        }

        // Level 8: Wind amplify/dampen question
        function generateWindAmplifyDampenQuestion(windDir, baseFaceToPath, diffLevel) {
            let correct;
            if (windDir === "Headwind") {
                correct = "Amplify the curve";
            } else if (windDir === "Tailwind") {
                correct = "Dampen the curve";
            } else {
                correct = "Not affect the curve significantly";
            }
            
            const options = ["Amplify the curve", "Dampen the curve", "Not affect the curve significantly"];
            
            let explanation;
            if (windDir === "Headwind") {
                explanation = `<div><strong>Wind:</strong> ${windDir}</div><div>Headwind increases spin rate and keeps the ball in the air longer, which AMPLIFIES sidespin and increases curve.</div>`;
            } else if (windDir === "Tailwind") {
                explanation = `<div><strong>Wind:</strong> ${windDir}</div><div>Tailwind reduces spin rate and shortens flight time, which DAMPENS sidespin and reduces curve.</div>`;
            } else {
                explanation = `<div><strong>Wind:</strong> ${windDir}</div><div>Crosswind primarily affects lateral movement but doesn't significantly change the curve from face-to-path.</div>`;
            }
            
            return {
                question: "Will the wind amplify or dampen the curve on this shot?",
                options: options,
                correct: correct,
                explanation: explanation
            };
        }

        // Level 8: Worst-case wind scenario
        function generateWorstWindScenarioQuestion(baseFaceToPath, diffLevel) {
            const curveDirection = baseFaceToPath < 0 ? "left" : "right";
            let correct;
            
            if (curveDirection === "left") {
                correct = "Headwind from the right";
            } else {
                correct = "Headwind from the left";
            }
            
            const options = [
                "Headwind from the left",
                "Headwind from the right",
                "Tailwind from the left",
                "Tailwind from the right"
            ];
            
            return {
                question: "What wind condition would make this shot go FURTHEST offline?",
                options: options,
                correct: correct,
                explanation: `<div><strong>Shot curves:</strong> ${curveDirection}</div><div>The worst case combines: (1) Headwind to AMPLIFY the curve, and (2) Crosswind pushing in the SAME direction as the curve.</div><div>This creates maximum offline distance.</div>`
            };
        }

        // Level 9-10: Opposing forces question
        function generateOpposingForcesQuestion(face, path, gearEffect, windEffect, baseFaceToPath, diffLevel) {
            const forces = [];
            
            // Check face-to-path direction
            const faceToPathDir = baseFaceToPath > 0 ? "right" : "left";
            
            // Check gear effect
            if (gearEffect !== 0) {
                const gearDir = gearEffect > 0 ? "right" : "left";
                if (gearDir !== faceToPathDir) {
                    forces.push(`Face-to-path (${faceToPathDir}) and Gear effect (${gearDir})`);
                }
            }
            
            // Check wind
            if (windEffect !== 0) {
                const windDir = windEffect > 0 ? "right" : "left";
                if (windDir !== faceToPathDir) {
                    forces.push(`Face-to-path (${faceToPathDir}) and Wind (${windDir})`);
                }
            }
            
            if (forces.length === 0) {
                forces.push("No opposing forces - all factors push the same direction");
            }
            
            const correct = forces[0];
            
            // Generate wrong options
            const allPossible = [
                `Face-to-path and Gear effect`,
                `Face-to-path and Wind`,
                `Gear effect and Wind`,
                `No opposing forces - all factors push the same direction`
            ];
            
            const wrongOptions = allPossible.filter(o => o !== correct).sort(() => Math.random() - 0.5).slice(0, 4);
            const options = [correct, ...wrongOptions].sort(() => Math.random() - 0.5);
            
            return {
                question: "Which TWO factors are working AGAINST each other?",
                options: options,
                correct: correct,
                explanation: `<div><strong>Face-to-path:</strong> ${baseFaceToPath.toFixed(1)}¬∞ (${faceToPathDir})</div><div><strong>Gear effect:</strong> ${gearEffect.toFixed(1)}¬∞ (${gearEffect > 0 ? 'right' : 'left'})</div><div><strong>Wind:</strong> ${windEffect.toFixed(1)} yards (${windEffect > 0 ? 'right' : 'left'})</div><div>Opposing forces make shots harder to predict and control.</div>`
            };
        }

        // Level 9-10: Best variable to change
        function generateBestVariableQuestion(face, path, gearEffect, windEffect, diffLevel) {
            // Calculate impact of changing each by 2¬∞
            const faceDelta = Math.abs(2 * 3); // Face √ó 3 = start yards
            const pathDelta = Math.abs(2 * 5); // Face-to-path change √ó 5 = curve yards
            const totalFace = faceDelta;
            const totalPath = pathDelta;
            
            let correct;
            if (totalPath > totalFace * 1.5) {
                correct = "Club path (affects both start and curve)";
            } else {
                correct = "Club face (directly controls start direction)";
            }
            
            const options = [
                "Club face (directly controls start direction)",
                "Club path (affects both start and curve)",
                "Impact location (creates gear effect)",
                "They would all have equal impact"
            ];
            
            return {
                question: "If you could change ONE variable by 2¬∞, which would improve the shot most?",
                options: options,
                correct: correct,
                explanation: `<div><strong>Changing face 2¬∞:</strong> ~${faceDelta} yards start direction</div><div><strong>Changing path 2¬∞:</strong> ~${pathDelta} yards curve change</div><div>Path changes affect BOTH the start (slightly) and curve (significantly), making it often the most impactful adjustment.</div>`
            };
        }

        // Level 9-10: Rank by impact
        function generateRankByImpactQuestion(face, path, gearEffect, windEffect, diffLevel) {
            const faceContribution = Math.abs(face * 3);
            const pathContribution = Math.abs((face - path) * 5);
            const gearContribution = Math.abs(gearEffect * 5);
            const windContribution = Math.abs(windEffect);
            
            // Only include variables that actually exist
            const causes = [
                { name: "Face angle", value: faceContribution },
                { name: "Face-to-path", value: pathContribution }
            ];
            
            if (gearEffect !== 0) {
                causes.push({ name: "Gear effect", value: gearContribution });
            }
            
            if (windEffect !== 0) {
                causes.push({ name: "Wind", value: windContribution });
            }
            
            causes.sort((a, b) => b.value - a.value); // Sort descending - highest first
            
            const correct = causes.map(c => c.name).join(' > ');
            
            // Generate a few wrong orderings
            const wrongOptions = [];
            const shuffled1 = [...causes].sort(() => Math.random() - 0.5);
            wrongOptions.push(shuffled1.map(c => c.name).join(' > '));
            const shuffled2 = [...causes].sort(() => Math.random() - 0.5);
            wrongOptions.push(shuffled2.map(c => c.name).join(' > '));
            
            const options = [correct, ...wrongOptions.filter(o => o !== correct).slice(0, 2)].sort(() => Math.random() - 0.5);
            
            return {
                question: "Rank these factors by their impact on the ball's final position (most to least):",
                options: options,
                correct: correct,
                explanation: `<div class="text-sm text-gray-600">Ranking (largest to smallest impact):</div><div>${causes.map((c, i) => `<div><strong>#${i+1}: ${c.name}</strong></div>`).join('')}</div>`
            };
        }

        function generateGearHelpHurtQuestion(gearEffect, baseFaceToPath, impactLocationText, diffLevel) {
            // Determine if gear effect is helping (opposing the curve) or hurting (adding to curve)
            const sameDirection = (gearEffect > 0 && baseFaceToPath > 0) || (gearEffect < 0 && baseFaceToPath < 0);
            const correct = sameDirection ? "Hurt (amplifies the curve)" : "Help (reduces the curve)";
            const wrong = sameDirection ? "Help (reduces the curve)" : "Hurt (amplifies the curve)";
            
            return {
                question: `Will the gear effect from ${impactLocationText} help or hurt this shot?`,
                options: [correct, wrong],
                correct: correct,
                explanation: `<div><strong>Base face-to-path:</strong> ${baseFaceToPath.toFixed(1)}¬∞ (${baseFaceToPath < 0 ? 'draw bias' : 'fade bias'})</div><div><strong>Gear effect:</strong> ${gearEffect.toFixed(1)}¬∞ (${gearEffect < 0 ? 'draw spin' : 'fade spin'})</div><div class="mt-2">${sameDirection ? 'The gear effect is in the SAME direction as face-to-path, making the curve worse!' : 'The gear effect is in the OPPOSITE direction from face-to-path, helping to straighten the shot.'}</div>`
            };
        }

        // Level 8: Will high/low face contact increase or decrease the curve?
        function generateVerticalImpactCurveQuestion(verticalImpact, verticalGearMultiplier, baseFaceToPath, diffLevel) {
            const isHigh = verticalImpact > 2; // High on face
            const isLow = verticalImpact < -2; // Low on face
            
            if (!isHigh && !isLow) {
                // Center strike - neutral question
                return {
                    question: "Will the center face contact significantly affect the curve?",
                    options: ["Yes", "No"],
                    correct: "No",
                    explanation: `<div><strong>Vertical impact:</strong> ${Math.abs(verticalImpact).toFixed(1)}mm (near center)</div><div>Center strikes produce normal spin rates without amplification or reduction.</div>`
                };
            }
            
            const impactType = isHigh ? "high" : "low";
            const effect = isHigh ? "Increase (amplifies spin)" : "Decrease (dampens spin)";
            const wrongEffect = isHigh ? "Decrease (dampens spin)" : "Increase (amplifies spin)";
            
            return {
                question: `Will the ${impactType} face contact increase or decrease the curve?`,
                options: [effect, wrongEffect],
                correct: effect,
                explanation: `<div><strong>Vertical impact:</strong> ${Math.abs(verticalImpact).toFixed(1)}mm ${impactType}</div><div><strong>Multiplier:</strong> ${verticalGearMultiplier.toFixed(2)}x</div><div class="mt-2">${isHigh ? 'High on the face creates more effective sidespin, amplifying the curve.' : 'Low on the face reduces sidespin effectiveness, dampening the curve.'}</div>`
            };
        }
        
        function generateVerticalAmplifyDampenQuestion(verticalImpact, diffLevel) {
            // üíöüé∑ EMERALD SAXOPHONE - Simple amplify/dampen question
            const isHigh = verticalImpact > 0;
            const isCenter = Math.abs(verticalImpact) < 2;
            
            if (isCenter) {
                return {
                    question: "Does this vertical impact location amplify or dampen the curve?",
                    options: ["Amplifies (increases curve)", "Dampens (decreases curve)", "No effect (center strike)"],
                    correct: "No effect (center strike)",
                    explanation: `<div><strong>Vertical impact:</strong> ${Math.abs(verticalImpact).toFixed(1)}mm (nearly center)</div><div class="mt-2">Center strikes have <strong>no vertical gear effect</strong> - the curve is unmodified (volume knob at normal level)</div>`
                };
            }
            
            return {
                question: "Does this vertical impact location amplify or dampen the curve?",
                options: ["Amplifies (increases curve)", "Dampens (decreases curve)", "No effect"],
                correct: isHigh ? "Amplifies (increases curve)" : "Dampens (decreases curve)",
                explanation: `<div><strong>Vertical impact:</strong> ${Math.abs(verticalImpact).toFixed(1)}mm ${isHigh ? 'HIGH' : 'LOW'} on face</div><div class="mt-2">${isHigh ? '<strong>HIGH</strong> on face ‚Üí <strong>Amplifies</strong> curve (volume turned UP)' : '<strong>LOW</strong> on face ‚Üí <strong>Dampens</strong> curve (volume turned DOWN)'}</div><div class="mt-2">Think of it like a volume knob - doesn't create NEW spin, just turns up or down what's already there!</div>`
            };
        }
        
        function generateStartVsCurveQuestion(face, baseFaceToPath, diffLevel) {
            // üü°üî∫ MUSTARD PYRAMID - Start vs Curve distinction (Level 1, 20% frequency)
            return {
                question: "The ball STARTS based on ___ and CURVES based on ___.",
                options: [
                    "Face angle ... Face-to-path",
                    "Face-to-path ... Face angle",
                    "Path ... Face-to-path",
                    "Face angle ... Path"
                ],
                correct: "Face angle ... Face-to-path",
                explanation: `<div class="mb-3"><strong>This is the golden rule of ball flight!</strong></div><div class="mb-2"><strong>START direction:</strong> Controlled by <strong>face angle</strong> (~85% influence)</div><div class="ml-3 text-sm">Current face: ${face.toFixed(1)}¬∞ ‚Üí ball starts ${face > 0.5 ? 'right' : face < -0.5 ? 'left' : 'straight'}</div><div class="mt-3 mb-2"><strong>CURVE amount & direction:</strong> Controlled by <strong>face-to-path</strong></div><div class="ml-3 text-sm">Current face-to-path: ${baseFaceToPath.toFixed(1)}¬∞ ‚Üí ${Math.abs(baseFaceToPath) < 0.5 ? 'straight (no curve)' : baseFaceToPath < 0 ? 'curves left (draw/hook)' : 'curves right (fade/slice)'}</div><div class="mt-3 p-2 bg-yellow-50 rounded text-sm"><strong>Remember:</strong> Face points where it starts, face-to-path determines how it curves!</div>`
            };
        }
        
        function generateCourseManagementQuestion(offlineYards, offlineDir, baseFaceToPath, windEffect, diffLevel) {
            // üéπüßä GLACIER PIANO - Course management strategic questions (Level 5-6, 10-15%)
            const scenarios = [
                {
                    condition: () => Math.abs(offlineYards) > 20 && Math.abs(baseFaceToPath) > 3,
                    question: "Your shot pattern shows a large curve. What's the BEST course management strategy?",
                    options: [
                        "Aim at the edge of the fairway and let it curve back",
                        "Try to fix your swing mid-round",
                        "Aim at the center and hope for the best",
                        "Play for the short grass regardless of direction"
                    ],
                    correct: "Aim at the edge of the fairway and let it curve back",
                    explanation: `<div><strong>Your shot:</strong> ${Math.abs(offlineYards).toFixed(0)} yards ${offlineDir}</div><div class="mt-2">With a consistent curve pattern, the smartest play is to <strong>aim away from trouble and use your curve</strong>. Trying to fix your swing during a round rarely works - play the shot you have!</div>`
                },
                {
                    condition: () => windEffect !== 0 && Math.abs(windEffect) > 10,
                    question: "Strong wind is pushing your ball significantly. What should you prioritize?",
                    options: [
                        "Club selection and aim adjustment",
                        "Swinging harder to fight the wind",
                        "Perfect contact above all else",
                        "Keeping your normal routine unchanged"
                    ],
                    correct: "Club selection and aim adjustment",
                    explanation: `<div><strong>Wind effect:</strong> ${Math.abs(windEffect).toFixed(0)} yards ${windEffect > 0 ? 'right' : 'left'}</div><div class="mt-2">In strong wind, smart golfers adjust strategy BEFORE swinging. Take more/less club, aim into the wind, and accept that conditions change the game. Fighting wind with swing speed usually adds spin and makes it worse!</div>`
                },
                {
                    condition: () => Math.abs(baseFaceToPath) < 1.5 && Math.abs(offlineYards) < 8,
                    question: "You're hitting relatively straight shots. What's your best strategy?",
                    options: [
                        "Play aggressive - attack pins and aim for birdies",
                        "Still play conservative to every center",
                        "Try to work the ball more for better angles",
                        "Focus only on distance, not direction"
                    ],
                    correct: "Play aggressive - attack pins and aim for birdies",
                    explanation: `<div><strong>Your accuracy:</strong> ${Math.abs(offlineYards).toFixed(0)} yards offline</div><div class="mt-2">When you're striping it, take advantage! This is when you attack pins, go for par 5s in two, and press for birdies. Good golf is about recognizing when you're "on" and capitalizing.</div>`
                },
                {
                    condition: () => Math.abs(baseFaceToPath) > 4 && offlineDir === "right",
                    question: "You're fighting a persistent fade/slice. Best strategy this round?",
                    options: [
                        "Aim left and play for the fade",
                        "Close your stance and try to draw it",
                        "Grip it and rip it down the middle",
                        "Use less club to reduce the curve"
                    ],
                    correct: "Aim left and play for the fade",
                    explanation: `<div><strong>Your pattern:</strong> Consistent fade ${Math.abs(offlineYards).toFixed(0)} yards right</div><div class="mt-2">Fighting your natural shot shape mid-round leads to disaster. Embrace it! Aim left of your target by your curve amount and let your fade bring it back. Tour pros play their misses - you should too.</div>`
                },
                {
                    condition: () => Math.abs(baseFaceToPath) > 4 && offlineDir === "left",
                    question: "You're fighting a persistent draw/hook. Best strategy?",
                    options: [
                        "Aim right and let it draw back to target",
                        "Open the face and try to fade it",
                        "Swing easier to reduce curve",
                        "Tee it higher to launch it straighter"
                    ],
                    correct: "Aim right and let it draw back to target",
                    explanation: `<div><strong>Your pattern:</strong> Consistent draw ${Math.abs(offlineYards).toFixed(0)} yards left</div><div class="mt-2">Go with what you've got! Aim right and trust your draw to work the ball back. The best rounds come from playing YOUR shot, not fighting to hit someone else's.</div>`
                },
                {
                    condition: () => true, // Default fallback
                    question: "With this shot pattern, what's the key to a good score?",
                    options: [
                        "Accept your pattern and manage around it",
                        "Try different techniques each shot",
                        "Always aim at the flag regardless",
                        "Focus on fixing mechanics mid-round"
                    ],
                    correct: "Accept your pattern and manage around it",
                    explanation: `<div><strong>Golf wisdom:</strong> "You have to play the ball where it lies... and you have to play yourself where you are."</div><div class="mt-2">Tour pros know their tendencies and plan accordingly. If you're curving it ${Math.abs(offlineYards).toFixed(0)} yards ${offlineDir}, aim away from trouble by that amount. Course management beats perfect ball-striking.</div>`
                }
            ];
            
            // Find first matching scenario
            for (let scenario of scenarios) {
                if (scenario.condition()) {
                    return {
                        question: scenario.question,
                        options: scenario.options,
                        correct: scenario.correct,
                        explanation: scenario.explanation
                    };
                }
            }
            
            // Fallback (should never hit this)
            return scenarios[scenarios.length - 1];
        }

        // WHAT-IF QUESTION GENERATORS FOR ALL LEVELS
        
        function generateWhatIfPathQuestion(face, path, diffLevel, clubType) {
            // üî¥üî≠ CRIMSON TELESCOPE: Comparative what-if questions
            const hypotheticalPath = Math.floor(Math.random() * 11) - 5;
            
            const currentFaceToPath = face - path;
            const newFaceToPath = face - hypotheticalPath;
            
            const straightThresholds = {
                driver: 0.25, wood: 0.35, long_iron: 0.45, mid_iron: 0.55, wedge: 0.80
            };
            const threshold = straightThresholds[clubType] || 0.5;
            
            // Determine current curve
            const currentCurve = Math.abs(currentFaceToPath) <= threshold ? "straight" :
                                currentFaceToPath < 0 ? "left" : "right";
            
            // Determine new curve
            const newCurve = Math.abs(newFaceToPath) <= threshold ? "straight" :
                            newFaceToPath < 0 ? "left" : "right";
            
            // Build comparative answer
            let correct;
            const options = [];
            
            if (currentCurve === newCurve) {
                if (currentCurve === "straight") {
                    correct = "Still straight";
                } else {
                    const moreCurve = Math.abs(newFaceToPath) > Math.abs(currentFaceToPath);
                    correct = moreCurve ? `More ${currentCurve} curve` : `Less ${currentCurve} curve`;
                }
            } else {
                if (newCurve === "straight") {
                    correct = "Go straight instead";
                } else {
                    correct = `Curve ${newCurve} instead`;
                }
            }
            
            // Generate contextual wrong options
            options.push(correct);
            if (currentCurve !== "straight") {
                options.push(`More ${currentCurve} curve`);
                options.push(`Less ${currentCurve} curve`);
                const oppositeCurve = currentCurve === "left" ? "right" : "left";
                options.push(`Curve ${oppositeCurve} instead`);
                if (newCurve !== "straight") options.push("Go straight instead");
            } else {
                options.push("Curve left");
                options.push("Curve right");
                options.push("Still straight");
            }
            
            const wrongOptions = options.filter(o => o !== correct).sort(() => Math.random() - 0.5).slice(0, 3);
            
            return {
                question: `If the club path was ${hypotheticalPath > 0 ? '+' : ''}${hypotheticalPath}¬∞ (instead of ${path.toFixed(1)}¬∞), what would happen to the curve?`,
                options: [correct, ...wrongOptions].sort(() => Math.random() - 0.5),
                correct: correct,
                explanation: `<div><strong>Current shot:</strong> Face ${face.toFixed(1)}¬∞, Path ${path.toFixed(1)}¬∞</div><div class="ml-3">Face-to-path: ${currentFaceToPath.toFixed(1)}¬∞ ‚Üí ${currentCurve === "straight" ? "straight" : "curves " + currentCurve}</div><div class="mt-2"><strong>If path was ${hypotheticalPath > 0 ? '+' : ''}${hypotheticalPath}¬∞:</strong> Face ${face.toFixed(1)}¬∞, Path ${hypotheticalPath > 0 ? '+' : ''}${hypotheticalPath}¬∞</div><div class="ml-3">Face-to-path: ${newFaceToPath.toFixed(1)}¬∞ ‚Üí ${newCurve === "straight" ? "straight" : "curves " + newCurve}</div><div class="mt-2 font-semibold text-blue-600">Result: ${correct}</div>`
            };
        }
        
        function generateWhatIfFaceQuestion(face, path, diffLevel, clubType) {
            // üî¥üî≠ CRIMSON TELESCOPE: Comparative what-if questions
            const hypotheticalFace = Math.floor(Math.random() * 11) - 5;
            
            const currentFaceToPath = face - path;
            const newFaceToPath = hypotheticalFace - path;
            
            const straightThresholds = {
                driver: 0.25, wood: 0.35, long_iron: 0.45, mid_iron: 0.55, wedge: 0.80
            };
            const threshold = straightThresholds[clubType] || 0.5;
            
            // Determine current curve
            const currentCurve = Math.abs(currentFaceToPath) <= threshold ? "straight" :
                                currentFaceToPath < 0 ? "left" : "right";
            
            // Determine new curve
            const newCurve = Math.abs(newFaceToPath) <= threshold ? "straight" :
                            newFaceToPath < 0 ? "left" : "right";
            
            // Build comparative answer
            let correct;
            const options = [];
            
            if (currentCurve === newCurve) {
                if (currentCurve === "straight") {
                    correct = "Still straight";
                } else {
                    const moreCurve = Math.abs(newFaceToPath) > Math.abs(currentFaceToPath);
                    correct = moreCurve ? `More ${currentCurve} curve` : `Less ${currentCurve} curve`;
                }
            } else {
                if (newCurve === "straight") {
                    correct = "Go straight instead";
                } else {
                    correct = `Curve ${newCurve} instead`;
                }
            }
            
            // Generate contextual wrong options
            options.push(correct);
            if (currentCurve !== "straight") {
                options.push(`More ${currentCurve} curve`);
                options.push(`Less ${currentCurve} curve`);
                const oppositeCurve = currentCurve === "left" ? "right" : "left";
                options.push(`Curve ${oppositeCurve} instead`);
                if (newCurve !== "straight") options.push("Go straight instead");
            } else {
                options.push("Curve left");
                options.push("Curve right");
                options.push("Still straight");
            }
            
            const wrongOptions = options.filter(o => o !== correct).sort(() => Math.random() - 0.5).slice(0, 3);
            
            return {
                question: `If the club face was ${hypotheticalFace > 0 ? '+' : ''}${hypotheticalFace}¬∞ (instead of ${face.toFixed(1)}¬∞), what would happen to the curve?`,
                options: [correct, ...wrongOptions].sort(() => Math.random() - 0.5),
                correct: correct,
                explanation: `<div><strong>Current shot:</strong> Face ${face.toFixed(1)}¬∞, Path ${path.toFixed(1)}¬∞</div><div class="ml-3">Face-to-path: ${currentFaceToPath.toFixed(1)}¬∞ ‚Üí ${currentCurve === "straight" ? "straight" : "curves " + currentCurve}</div><div class="mt-2"><strong>If face was ${hypotheticalFace > 0 ? '+' : ''}${hypotheticalFace}¬∞:</strong> Face ${hypotheticalFace > 0 ? '+' : ''}${hypotheticalFace}¬∞, Path ${path.toFixed(1)}¬∞</div><div class="ml-3">Face-to-path: ${newFaceToPath.toFixed(1)}¬∞ ‚Üí ${newCurve === "straight" ? "straight" : "curves " + newCurve}</div><div class="mt-2 font-semibold text-blue-600">Result: ${correct}</div>`
            };
        }
        
        function generateWhatIfCenterImpactQuestion(face, path, gearEffect, impactLocationText, diffLevel, curveMultiplier) {
            // Level 2+: What if impact was center
            const faceToPath = face - path;
            const currentGearDegrees = Math.abs(gearEffect).toFixed(1);
            
            return {
                question: "If this shot was struck on the CENTER of the face, how much gear effect would there be?",
                options: ["0¬∞", currentGearDegrees + "¬∞", (Math.abs(gearEffect) * 2).toFixed(1) + "¬∞", (Math.abs(gearEffect) * 0.5).toFixed(1) + "¬∞"].sort(() => Math.random() - 0.5),
                correct: "0¬∞",
                explanation: `<div><strong>Current impact:</strong> ${impactLocationText} = ${currentGearDegrees}¬∞ gear effect</div><div><strong>Center impact:</strong> No off-center contact = <strong>0¬∞ gear effect</strong></div><div class="mt-2 text-sm text-gray-600">Gear effect only occurs from off-center hits</div>`
            };
        }
        
        function generateWhatIfFaceSquareQuestion(face, physics, diffLevel) {
            // Level 2+: What if face was square
            const startMultipliers = { driver: 2.5, wood: 2.3, long_iron: 2.0, mid_iron: 1.8, wedge: 1.5 };
            
            return {
                question: "If the face angle was square (0¬∞), where would the ball start?",
                options: ["Straight at target", "Right of target", "Left of target", "Cannot determine"],
                correct: "Straight at target",
                explanation: `<div><strong>Current face:</strong> ${face.toFixed(1)}¬∞</div><div><strong>Hypothetical face:</strong> 0¬∞ (square)</div><div><strong>Result:</strong> Ball starts straight at target</div><div class="mt-2 text-sm text-gray-600">Face angle controls ~${Math.round(physics.startFaceInfluence * 100)}% of start direction</div>`
            };
        }
        
        function generateWhatIfVerticalCenterQuestion(verticalImpact, baseFaceToPath, verticalGearMultiplier, diffLevel) {
            // Level 3+: What if vertical was center
            const currentMultiplier = verticalGearMultiplier;
            const centerMultiplier = 1.0;
            const changePercent = Math.round((1 - currentMultiplier) * 100);
            
            return {
                question: "If this shot was struck CENTER vertically on the face, how would the curve change?",
                options: [
                    "Same curve (no change)",
                    changePercent > 0 ? `${Math.abs(changePercent)}% more curve` : `${Math.abs(changePercent)}% less curve`,
                    "No curve at all",
                    "Opposite curve direction"
                ].sort(() => Math.random() - 0.5),
                correct: "Same curve (no change)",
                explanation: `<div><strong>Current vertical:</strong> ${Math.abs(verticalImpact).toFixed(1)}mm ${verticalImpact > 0 ? 'high' : 'low'} (${currentMultiplier.toFixed(2)}x)</div><div><strong>Center vertical:</strong> 0mm = 1.00x (baseline curve)</div><div class="mt-2">Vertical impact amplifies or dampens existing curve but doesn't create it. Center strike = normal curve amount.</div>`
            };
        }

        // LEVEL 2 IMPACT-FOCUSED QUESTION GENERATORS
        
        function generateImpactSpinTypeQuestion(gearEffect, impactLocation, impactLocationText, diffLevel) {
            const spinType = Math.abs(gearEffect) < 0.2 ? "None (center strike)" : 
                             gearEffect < 0 ? "Draw" : "Fade";
            
            return {
                question: "What kind of spin will the impact location of this shot create?",
                options: ["Draw", "Fade", "None (center strike)"].sort(() => Math.random() - 0.5),
                correct: spinType,
                explanation: `<div><strong>Impact:</strong> ${impactLocationText}</div><div><strong>Gear effect:</strong> ${Math.abs(gearEffect).toFixed(2)}¬∞</div><div class="mt-2">${Math.abs(gearEffect) < 0.2 ? '<strong>Center strike</strong> = No gear effect' : impactLocation > 0 ? '<strong>Toe hit</strong> twists face closed ‚Üí <strong>Draw spin</strong> (curves left)' : '<strong>Heel hit</strong> twists face open ‚Üí <strong>Fade spin</strong> (curves right)'}</div>`
            };
        }
        
        function generateImpactMagnitudeQuestion(gearEffect, impactLocation, clubType, diffLevel) {
            const isToe = impactLocation > 0;
            const magnitude = Math.abs(gearEffect);
            
            const options = [
                magnitude.toFixed(1),
                (magnitude + 0.3).toFixed(1),
                (magnitude - 0.3 > 0 ? magnitude - 0.3 : magnitude + 0.5).toFixed(1),
                (magnitude + 0.6).toFixed(1)
            ].filter((v, i, a) => a.indexOf(v) === i).sort(() => Math.random() - 0.5).slice(0, 4);
            
            return {
                question: "How many degrees of gear effect does this impact location create?",
                options: options.map(o => o + "¬∞"),
                correct: magnitude.toFixed(1) + "¬∞",
                explanation: `<div><strong>Impact:</strong> ${Math.abs(impactLocation).toFixed(1)}mm ${isToe ? 'toe' : 'heel'}</div><div><strong>Calculation:</strong> ${Math.abs(impactLocation).toFixed(1)}mm √ó ${clubType} multiplier = <strong>${magnitude.toFixed(1)}¬∞</strong></div><div class="mt-2">${isToe ? 'Toe creates draw spin (negative)' : 'Heel creates fade spin (positive)'}</div>`
            };
        }
        
        function generateOpposingForcesLevel2Question(gearEffect, baseFaceToPath, diffLevel) {
            const opposing = (gearEffect > 0 && baseFaceToPath < 0) || (gearEffect < 0 && baseFaceToPath > 0);
            
            return {
                question: "Are the face-to-path and gear effect working together or against each other?",
                options: ["Working together (same direction)", "Working against each other (opposite directions)"],
                correct: opposing ? "Working against each other (opposite directions)" : "Working together (same direction)",
                explanation: `<div><strong>Face-to-path:</strong> ${baseFaceToPath.toFixed(1)}¬∞ = ${baseFaceToPath < 0 ? 'draw' : 'fade'} tendency</div><div><strong>Gear effect:</strong> ${gearEffect.toFixed(1)}¬∞ = ${gearEffect < 0 ? 'draw' : 'fade'} spin</div><div class="mt-2"><strong>Result:</strong> ${opposing ? '‚ö†Ô∏è Opposing forces - gear effect <strong>reduces</strong> the curve' : '‚úì Working together - gear effect <strong>amplifies</strong> the curve'}</div>`
            };
        }
        
        function generateCenterStrikeTargetQuestion(gearEffect, baseFaceToPath, diffLevel) {
            const wouldHelp = (gearEffect > 0 && baseFaceToPath < 0) || (gearEffect < 0 && baseFaceToPath > 0);
            
            return {
                question: "If this shot was struck CENTER on the face, would it finish closer to or further from the target line?",
                options: ["Closer to target line", "Further from target line", "Same distance"],
                correct: wouldHelp ? "Further from target line" : "Closer to target line",
                explanation: `<div><strong>Current gear effect:</strong> ${Math.abs(gearEffect).toFixed(1)}¬∞ ${wouldHelp ? 'reducing curve (helping)' : 'adding curve (hurting)'}</div><div><strong>Center strike:</strong> No gear effect (0¬∞)</div><div class="mt-2"><strong>Result:</strong> Without gear, shot would have ${wouldHelp ? '<strong>more</strong> curve ‚Üí further from target' : '<strong>less</strong> curve ‚Üí closer to target'}</div>`
            };
        }
        
        function generateImpactRankingTargetQuestion(impactLocation, diffLevel) {
            const impacts = [5, 10, 15, 20];
            const current = Math.round(Math.abs(impactLocation));
            if (!impacts.includes(current) && current < 25) impacts.push(current);
            impacts.sort((a, b) => a - b);
            const selected = impacts.slice(0, 4);
            
            return {
                question: "Which impact distance would bring the ball CLOSEST to the target line?",
                options: selected.map(i => `${i}mm`),
                correct: `${selected[0]}mm`,
                explanation: `<div><strong>Rule:</strong> Closer to center = less gear effect = closer to target line</div><div class="mt-2"><strong>Ranking (closest to target first):</strong></div>${selected.map((s, i) => `<div>${i + 1}. ${s}mm from center</div>`).join('')}`
            };
        }
        
        function generateGearDirectionThisShotQuestion(impactLocation, gearEffect, diffLevel) {
            const isToe = impactLocation > 0;
            const direction = gearEffect < 0 ? "Left" : "Right";
            
            return {
                question: `For THIS shot (${Math.abs(impactLocation).toFixed(0)}mm ${isToe ? 'toe' : 'heel'}), which direction will gear effect push the ball?`,
                options: ["Left", "Right", "Straight", "Depends on clubface"],
                correct: direction,
                explanation: `<div><strong>This shot:</strong> ${Math.abs(impactLocation).toFixed(0)}mm ${isToe ? 'toe' : 'heel'}</div><div><strong>Gear effect:</strong> ${Math.abs(gearEffect).toFixed(1)}¬∞ ${isToe ? 'draw' : 'fade'} spin</div><div class="mt-2">${isToe ? '<strong>Toe</strong> twists face CLOSED ‚Üí curves LEFT' : '<strong>Heel</strong> twists face OPEN ‚Üí curves RIGHT'}</div>`
            };
        }
        
        function generateGearPercentageQuestion(gearEffect, baseFaceToPath, diffLevel) {
            const totalCurve = Math.abs(baseFaceToPath + gearEffect);
            if (totalCurve < 0.1) return null; // Avoid division by near-zero
            
            const gearPercent = Math.abs(gearEffect / totalCurve * 100);
            
            let correct;
            if (gearPercent < 25) correct = "Less than 25%";
            else if (gearPercent < 50) correct = "25-50%";
            else if (gearPercent < 75) correct = "50-75%";
            else correct = "More than 75%";
            
            return {
                question: "What percentage of the total curve is caused by gear effect?",
                options: ["Less than 25%", "25-50%", "50-75%", "More than 75%"],
                correct: correct,
                explanation: `<div><strong>Face-to-path:</strong> ${Math.abs(baseFaceToPath).toFixed(1)}¬∞</div><div><strong>Gear effect:</strong> ${Math.abs(gearEffect).toFixed(1)}¬∞</div><div><strong>Total curve tendency:</strong> ${totalCurve.toFixed(1)}¬∞</div><div class="mt-2"><strong>Gear percentage:</strong> ${gearPercent.toFixed(0)}%</div>`
            };
        }
        
        function generateClubSensitivityQuestion(diffLevel) {
            return {
                question: "Unrelated to this specific shot above, for the SAME off-center hit, which club creates MORE gear effect?",
                options: ["Driver (0.15 multiplier)", "7-iron (0.07 multiplier)", "Wedge (0.05 multiplier)", "All create the same"],
                correct: "Driver (0.15 multiplier)",
                explanation: `<div><strong>Gear multipliers by club:</strong></div><div>‚Ä¢ Driver: 0.15 (MOST sensitive)</div><div>‚Ä¢ Wood: 0.12</div><div>‚Ä¢ Long iron: 0.09</div><div>‚Ä¢ 7-iron: 0.07</div><div>‚Ä¢ Wedge: 0.05 (least sensitive)</div><div class="mt-2"><strong>Why?</strong> Driver has deeper head = COG farther from face = more twist = more gear effect</div><div class="mt-2">Same 10mm toe hit: Driver creates 3x more spin than wedge!</div>`
            };
        }


        async function saveScore() {
            if (!state.user) return;
            
            const timestamp = new Date().toISOString();
            const scoreData = {
                name: state.user.name,
                level: state.difficulty,
                tokens: state.user.tokens,
                questionsAnswered: state.user.questionsAnswered,
                correctAnswers: state.user.correctAnswers,
                accuracy: state.user.questionsAnswered > 0 ? 
                    Math.round((state.user.correctAnswers / state.user.questionsAnswered) * 100) : 0,
                bestStreak: state.user.bestStreak,
                timestamp: timestamp,
                displayTime: new Date(timestamp).toLocaleString()
            };
            
            // Use consistent key for each player (no timestamp)
            const key = 'score_' + state.user.name.toLowerCase().replace(/\s+/g, '_');
            
            // Try window.storage first (global), fallback to localStorage
            try {
                // Check if player already has a score
                let existingScore = null;
                try {
                    const result = await window.storage.get(key, true);
                    if (result && result.value) {
                        existingScore = JSON.parse(result.value);
                    }
                } catch (e) {
                    // No existing score
                }
                
                // Only save if new score is better OR no existing score
                if (!existingScore || scoreData.tokens > existingScore.tokens) {
                    await window.storage.set(key, JSON.stringify(scoreData), true);
                }
            } catch (error) {
                // Fallback to localStorage
                try {
                    let existingScore = null;
                    const storedValue = localStorage.getItem(key);
                    if (storedValue) {
                        existingScore = JSON.parse(storedValue);
                    }
                    
                    // Only save if new score is better OR no existing score
                    if (!existingScore || scoreData.tokens > existingScore.tokens) {
                        localStorage.setItem(key, JSON.stringify(scoreData));
                    }
                } catch (e) {
                    console.log('Storage not available:', e.message);
                }
            }
        }

        async function loadLeaderboard() {
            let isGlobal = false;
            let scores = [];
            
            // Try window.storage first (global)
            try {
                const result = await window.storage.list('score_', true);
                if (result && result.keys) {
                    isGlobal = true;
                    for (const key of result.keys) {
                        try {
                            const scoreResult = await window.storage.get(key, true);
                            if (scoreResult && scoreResult.value) {
                                scores.push(JSON.parse(scoreResult.value));
                            }
                        } catch (e) {
                            console.error('Failed to load score:', e);
                        }
                    }
                }
            } catch (error) {
                // Fallback to localStorage
                try {
                    for (let i = 0; i < localStorage.length; i++) {
                        const key = localStorage.key(i);
                        if (key && key.startsWith('score_')) {
                            const value = localStorage.getItem(key);
                            if (value) {
                                scores.push(JSON.parse(value));
                            }
                        }
                    }
                } catch (e) {
                    console.error('Failed to load from localStorage:', e);
                }
            }
            
            scores.sort((a, b) => {
                if (b.tokens !== a.tokens) return b.tokens - a.tokens;
                return new Date(b.timestamp) - new Date(a.timestamp);
            });
            
            return { scores: scores.slice(0, 50), isGlobal };
        }

        function openLeaderboard() {
            const leaderboardWindow = window.open('', 'Leaderboard', 'width=1100,height=700');
            
            if (!leaderboardWindow) {
                alert('Please allow popups for this site to view the leaderboard!');
                return;
            }
            
            loadLeaderboard().then(data => {
                const { scores, isGlobal } = data;
                
                let html = `<!DOCTYPE html>
<html>
<head>
    <title>Leaderboard</title>
    <script src="https://cdn.tailwindcss.com"><` + `/script>
    <style>
        th { cursor: pointer; user-select: none; }
        th:hover { background-color: #f3f4f6; }
        .sort-arrow { display: inline-block; margin-left: 4px; }
    </style>
</head>
<body class="bg-gradient-to-br from-yellow-400 via-orange-500 to-red-600 p-8">
    <div class="max-w-6xl mx-auto bg-white rounded-2xl shadow-2xl p-8">
        <h1 class="text-4xl font-bold text-center mb-4 bg-gradient-to-r from-yellow-500 to-orange-500 bg-clip-text text-transparent">
            üèÜ Leaderboard
        </h1>
        <div class="text-center mb-6">
            <span class="inline-block px-4 py-2 rounded-full text-sm font-semibold ${isGlobal ? 'bg-green-100 text-green-800' : 'bg-blue-100 text-blue-800'}">
                ${isGlobal ? 'üåç Global Leaderboard - Compete with players worldwide!' : 'üìä Personal High Scores - Playing in local mode'}
            </span>
        </div>
        
        <div class="mb-4">
            <label class="font-semibold mr-2">Filter by Level:</label>
            <select id="levelFilter" onchange="filterScores()" class="px-4 py-2 border-2 border-gray-300 rounded-lg">
                <option value="all">All Levels</option>`;
                
                for (let i = 1; i <= 6; i++) {
                    html += `<option value="${i}">Level ${i}: ${difficultyLevels[i-1].name}</option>`;
                }
                
                html += `
            </select>
        </div>`;
                
                if (scores.length === 0) {
                    html += '<div class="text-center py-12"><p class="text-xl text-gray-600">No scores yet. Be the first!</p></div>';
                } else {
                    html += `
        <div class="overflow-x-auto">
            <table class="w-full" id="leaderboardTable">
                <thead>
                    <tr class="border-b-2 border-gray-300">
                        <th class="text-left py-3 px-4 font-bold text-gray-700">Rank</th>
                        <th class="text-left py-3 px-4 font-bold text-gray-700">Player</th>
                        <th class="text-left py-3 px-4 font-bold text-gray-700">Level</th>
                        <th class="text-left py-3 px-4 font-bold text-gray-700" onclick="sortBy('tokens')">Tokens <span class="sort-arrow" id="arrow-tokens">‚Üì</span></th>
                        <th class="text-left py-3 px-4 font-bold text-gray-700" onclick="sortBy('accuracy')">Accuracy <span class="sort-arrow" id="arrow-accuracy"></span></th>
                        <th class="text-left py-3 px-4 font-bold text-gray-700" onclick="sortBy('correctAnswers')">Correct <span class="sort-arrow" id="arrow-correctAnswers"></span></th>
                        <th class="text-left py-3 px-4 font-bold text-gray-700" onclick="sortBy('bestStreak')">Best Streak <span class="sort-arrow" id="arrow-bestStreak"></span></th>
                        <th class="text-left py-3 px-4 font-bold text-gray-700" onclick="sortBy('timestamp')">Last Played <span class="sort-arrow" id="arrow-timestamp"></span></th>
                    </tr>
                </thead>
                <tbody id="leaderboardBody">
                </tbody>
            </table>
        </div>`;
                }
                
                html += `
    </div>
    <script>
        let allScores = ${JSON.stringify(scores)};
        let currentSort = { field: 'tokens', ascending: false };
        let currentFilter = 'all';
        
        const difficultyLevels = ${JSON.stringify(difficultyLevels)};
        
        function renderTable(scoresToShow) {
            const tbody = document.getElementById('leaderboardBody');
            if (!tbody) return;
            
            tbody.innerHTML = '';
            scoresToShow.forEach((score, idx) => {
                const medal = idx === 0 ? 'ü•á' : idx === 1 ? 'ü•à' : idx === 2 ? 'ü•â' : (idx + 1);
                const rowClass = idx < 3 ? 'bg-yellow-50' : '';
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 hover:bg-gray-50 ' + rowClass;
                row.innerHTML = \`
                    <td class="py-3 px-4 font-semibold">\${medal}</td>
                    <td class="py-3 px-4 font-medium">\${score.name}</td>
                    <td class="py-3 px-4"><span class="text-sm">\${difficultyLevels[score.level - 1].name}</span></td>
                    <td class="py-3 px-4"><span class="font-bold text-blue-600">\${score.tokens}</span></td>
                    <td class="py-3 px-4"><span class="text-sm">\${score.accuracy}%</span></td>
                    <td class="py-3 px-4"><span class="font-bold text-green-600">\${score.correctAnswers}</span></td>
                    <td class="py-3 px-4"><span class="font-bold text-purple-600">\${score.bestStreak || 0}</span></td>
                    <td class="py-3 px-4 text-sm text-gray-600">\${score.displayTime}</td>
                \`;
                tbody.appendChild(row);
            });
        }
        
        function sortBy(field) {
            if (currentSort.field === field) {
                currentSort.ascending = !currentSort.ascending;
            } else {
                currentSort.field = field;
                currentSort.ascending = field === 'timestamp';
            }
            
            // Clear all arrows
            document.querySelectorAll('.sort-arrow').forEach(el => el.textContent = '');
            
            // Set current arrow
            const arrow = document.getElementById('arrow-' + field);
            if (arrow) arrow.textContent = currentSort.ascending ? '‚Üë' : '‚Üì';
            
            const filtered = filterScores(true);
            const sorted = [...filtered].sort((a, b) => {
                let aVal = a[field];
                let bVal = b[field];
                
                if (field === 'timestamp') {
                    aVal = new Date(aVal);
                    bVal = new Date(bVal);
                }
                
                if (currentSort.ascending) {
                    return aVal > bVal ? 1 : -1;
                } else {
                    return aVal < bVal ? 1 : -1;
                }
            });
            
            renderTable(sorted);
        }
        
        function filterScores(returnOnly = false) {
            currentFilter = document.getElementById('levelFilter').value;
            
            let filtered = allScores;
            if (currentFilter !== 'all') {
                filtered = allScores.filter(s => s.level === parseInt(currentFilter));
            }
            
            if (returnOnly) return filtered;
            
            sortBy(currentSort.field);
        }
        
        // Initial render
        renderTable(allScores);
    <` + `/script>
</body>
</html>`;
                
                leaderboardWindow.document.write(html);
                leaderboardWindow.document.close();
            });
        }

        function selectLevel(level) {
            state.difficulty = level;
            
            // If we're in a game (not at level select), regenerate scenario with new level
            if (!state.showLevelSelect && state.currentScenarioData) {
                state.currentScenarioData = generateScenario(state.difficulty);
                state.currentCard = 1;
                state.selectedAnswer = null;
                state.showExplanation = false;
                state.isCorrect = false;
                
                // Auto-show tutorial if switching to a tutorial level not seen before
                const tutorialLevels = [1, 2, 3, 4, 5, 6];
                if (tutorialLevels.includes(state.difficulty) && !state.tutorialsShown.includes(state.difficulty)) {
                    state.showTutorial = true;
                    state.tutorialLevel = state.difficulty;
                    state.tutorialsShown.push(state.difficulty);
                }
            }
            
            render();
        }

        function startGame() {
            state.showLevelSelect = false;
            state.currentScenarioData = generateScenario(state.difficulty);
            
            // Auto-show tutorial for key levels if not shown before
            const tutorialLevels = [1, 2, 3, 4, 5, 6];
            if (tutorialLevels.includes(state.difficulty) && !state.tutorialsShown.includes(state.difficulty)) {
                state.showTutorial = true;
                state.tutorialLevel = state.difficulty;
                state.tutorialsShown.push(state.difficulty);
            } else {
                maybeShowConfidenceBoost();
            }
            
            render();
        }

        function maybeShowConfidenceBoost() {
            // Random chance (20%) to show confidence boost
            if (Math.random() < 0.2 && !state.showConfidenceBoost) {
                state.showConfidenceBoost = true;
                state.hasUsedBoost = false;
                state.boostCountdown = 20;
                // 50% chance to show before question, 50% after seeing the question
                state.boostTiming = Math.random() < 0.5 ? 'before' : 'after';
                
                // Start countdown timer
                if (state.boostTimer) clearInterval(state.boostTimer);
                state.boostTimer = setInterval(() => {
                    state.boostCountdown--;
                    if (state.boostCountdown <= 0) {
                        clearInterval(state.boostTimer);
                        state.showConfidenceBoost = false;
                        state.confidenceMultiplier = 1;
                    }
                    render();
                }, 1000);
            }
        }

        function getTutorialContent(level) {
            // üåàüé∏ RAINBOW GUITAR: New visual, interactive tutorial system
            const tutorials = {
                1: {
                    title: "Level 1: Face-to-Path Fundamentals",
                    totalSteps: 7,
                    steps: [
                        {
                            title: "Face Angle Controls START Direction",
                            svg: `
                                <svg viewBox="0 0 600 280" class="w-full" style="max-height: 300px;">
                                    <defs>
                                        <marker id="arrow-left" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                            <polygon points="0 0, 10 3, 0 6" fill="#ef4444"/>
                                        </marker>
                                        <marker id="arrow-straight" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                            <polygon points="0 0, 10 3, 0 6" fill="#22c55e"/>
                                        </marker>
                                        <marker id="arrow-right" markerWidth="10" markerHeight="10" refX="9" refY="3" orient="auto">
                                            <polygon points="0 0, 10 3, 0 6" fill="#3b82f6"/>
                                        </marker>
                                    </defs>
                                    
                                    <!-- THREE SCENARIOS SIDE BY SIDE -->
                                    
                                    <!-- LEFT: Face -5¬∞ -->
                                    <g transform="translate(0, 0)">
                                        <rect x="10" y="10" width="180" height="260" fill="#fef2f2" stroke="#ef4444" stroke-width="2" rx="8"/>
                                        <text x="100" y="35" text-anchor="middle" fill="#dc2626" font-size="16" font-weight="bold">Face -5¬∞ LEFT</text>
                                        
                                        <!-- Target line -->
                                        <line x1="100" y1="220" x2="100" y2="80" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <text x="100" y="70" text-anchor="middle" fill="#9ca3af" font-size="11">TARGET</text>
                                        
                                        <!-- Ball and club -->
                                        <circle cx="100" cy="220" r="6" fill="#fff" stroke="#000" stroke-width="1.5"/>
                                        <rect x="85" y="228" width="30" height="8" fill="#8b4513" rx="2"/>
                                        
                                        <!-- Face arrow pointing LEFT -->
                                        <line x1="100" y1="220" x2="60" y2="120" stroke="#ef4444" stroke-width="4" marker-end="url(#arrow-left)"/>
                                        <text x="50" y="160" fill="#ef4444" font-size="14" font-weight="bold">FACE</text>
                                        
                                        <!-- Ball starts LEFT -->
                                        <circle cx="60" cy="90" r="5" fill="#ef4444"/>
                                        <text x="100" y="255" text-anchor="middle" fill="#dc2626" font-size="13" font-weight="bold">Starts LEFT</text>
                                    </g>
                                    
                                    <!-- MIDDLE: Face 0¬∞ -->
                                    <g transform="translate(200, 0)">
                                        <rect x="10" y="10" width="180" height="260" fill="#f0fdf4" stroke="#22c55e" stroke-width="2" rx="8"/>
                                        <text x="100" y="35" text-anchor="middle" fill="#16a34a" font-size="16" font-weight="bold">Face 0¬∞ SQUARE</text>
                                        
                                        <!-- Target line -->
                                        <line x1="100" y1="220" x2="100" y2="80" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <text x="100" y="70" text-anchor="middle" fill="#9ca3af" font-size="11">TARGET</text>
                                        
                                        <!-- Ball and club -->
                                        <circle cx="100" cy="220" r="6" fill="#fff" stroke="#000" stroke-width="1.5"/>
                                        <rect x="85" y="228" width="30" height="8" fill="#8b4513" rx="2"/>
                                        
                                        <!-- Face arrow pointing STRAIGHT -->
                                        <line x1="100" y1="220" x2="100" y2="120" stroke="#22c55e" stroke-width="4" marker-end="url(#arrow-straight)"/>
                                        <text x="110" y="160" fill="#22c55e" font-size="14" font-weight="bold">FACE</text>
                                        
                                        <!-- Ball starts STRAIGHT -->
                                        <circle cx="100" cy="90" r="5" fill="#22c55e"/>
                                        <text x="100" y="255" text-anchor="middle" fill="#16a34a" font-size="13" font-weight="bold">Starts STRAIGHT</text>
                                    </g>
                                    
                                    <!-- RIGHT: Face +5¬∞ -->
                                    <g transform="translate(400, 0)">
                                        <rect x="10" y="10" width="180" height="260" fill="#eff6ff" stroke="#3b82f6" stroke-width="2" rx="8"/>
                                        <text x="100" y="35" text-anchor="middle" fill="#2563eb" font-size="16" font-weight="bold">Face +5¬∞ RIGHT</text>
                                        
                                        <!-- Target line -->
                                        <line x1="100" y1="220" x2="100" y2="80" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <text x="100" y="70" text-anchor="middle" fill="#9ca3af" font-size="11">TARGET</text>
                                        
                                        <!-- Ball and club -->
                                        <circle cx="100" cy="220" r="6" fill="#fff" stroke="#000" stroke-width="1.5"/>
                                        <rect x="85" y="228" width="30" height="8" fill="#8b4513" rx="2"/>
                                        
                                        <!-- Face arrow pointing RIGHT -->
                                        <line x1="100" y1="220" x2="140" y2="120" stroke="#3b82f6" stroke-width="4" marker-end="url(#arrow-right)"/>
                                        <text x="150" y="160" fill="#3b82f6" font-size="14" font-weight="bold">FACE</text>
                                        
                                        <!-- Ball starts RIGHT -->
                                        <circle cx="140" cy="90" r="5" fill="#3b82f6"/>
                                        <text x="100" y="255" text-anchor="middle" fill="#2563eb" font-size="13" font-weight="bold">Starts RIGHT</text>
                                    </g>
                                </svg>
                            `,
                            description: "The clubface angle at impact controls WHERE the ball starts (75-85% influence). This is true regardless of your swing path!",
                            keyPoint: `<div class="bg-green-50 border-2 border-green-500 rounded-lg p-3">
                                <p class="font-bold mb-2">üí° Key Insight:</p>
                                <p class="text-sm">If your face points LEFT, the ball starts LEFT.<br>
                                If your face points RIGHT, the ball starts RIGHT.<br>
                                Square face (0¬∞) = Ball starts at TARGET.</p>
                            </div>`,
                            interactive: false
                        },
                        // STEP 2a: Scenario 1
                        {
                            title: "Scenario 1: In-to-Out Can Still Fade!",
                            svg: `
                                <svg viewBox="0 0 450 320" class="w-full">
                                    <line x1="225" y1="270" x2="225" y2="50" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                    <text x="225" y="40" text-anchor="middle" fill="#9ca3af" font-size="16" font-weight="bold">TARGET</text>
                                    
                                    <!-- Ball -->
                                    <circle cx="225" cy="270" r="9" fill="#fff" stroke="#000" stroke-width="2"/>
                                    
                                    <!-- PATH arrow (blue, dashed) - less rotation -->
                                    <g transform="rotate(9, 225, 270)">
                                        <line x1="225" y1="270" x2="225" y2="160" stroke="#3b82f6" stroke-width="5" stroke-dasharray="8,4"/>
                                        <text x="145" y="200" fill="#3b82f6" font-size="16" font-weight="bold">PATH</text>
                                        <text x="145" y="220" fill="#3b82f6" font-size="14">+3¬∞</text>
                                    </g>
                                    
                                    <!-- FACE arrow (green, solid) - more rotation -->
                                    <g transform="rotate(18, 225, 270)">
                                        <line x1="225" y1="270" x2="225" y2="160" stroke="#10b981" stroke-width="5"/>
                                        <text x="290" y="200" fill="#10b981" font-size="16" font-weight="bold">FACE</text>
                                        <text x="290" y="220" fill="#10b981" font-size="14">+6¬∞</text>
                                    </g>
                                    
                                    <!-- Ball flight curve -->
                                    <path d="M 225 260 Q 270 150, 320 60" stroke="#ef4444" stroke-width="5" fill="none"/>
                                    <circle cx="320" cy="60" r="8" fill="#ef4444"/>
                                    
                                    <text x="225" y="305" text-anchor="middle" font-size="18" font-weight="bold" fill="#ef4444">FADE (starts right, curves more right)</text>
                                </svg>
                            `,
                            description: "Face +6¬∞, Path +3¬∞ (in-to-out swing)",
                            keyPoint: `<div class="bg-red-50 border-2 border-red-400 rounded-lg p-3">
                                <p class="font-bold mb-2">This FADES (starts right, curves more right)!</p>
                                <p class="text-sm">Even though path is in-to-out (+3¬∞), the face is OPEN TO THE PATH (+3¬∞ to path). Ball starts right (face +6¬∞) and curves MORE right (face-to-path = +3¬∞).</p>
                            </div>`,
                            interactive: false
                        },
                        // STEP 2b: Scenario 2
                        {
                            title: "Scenario 2: Face = Path = Straight",
                            svg: `
                                <svg viewBox="0 0 450 320" class="w-full">
                                    <line x1="225" y1="270" x2="225" y2="50" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                    <text x="225" y="40" text-anchor="middle" fill="#9ca3af" font-size="16" font-weight="bold">TARGET</text>
                                    
                                    <!-- Ball -->
                                    <circle cx="225" cy="270" r="9" fill="#fff" stroke="#000" stroke-width="2"/>
                                    
                                    <!-- Both arrows point SAME direction (left) -->
                                    <g transform="rotate(-12, 225, 270)">
                                        <!-- PATH (blue dashed, behind) -->
                                        <line x1="225" y1="270" x2="225" y2="160" stroke="#3b82f6" stroke-width="5" stroke-dasharray="8,4"/>
                                        <text x="290" y="200" fill="#3b82f6" font-size="16" font-weight="bold">PATH</text>
                                        <text x="290" y="220" fill="#3b82f6" font-size="14">-4¬∞</text>
                                        
                                        <!-- FACE (green solid, in front) -->
                                        <line x1="225" y1="270" x2="225" y2="160" stroke="#10b981" stroke-width="5"/>
                                        <text x="140" y="200" fill="#10b981" font-size="16" font-weight="bold">FACE</text>
                                        <text x="140" y="220" fill="#10b981" font-size="14">-4¬∞</text>
                                    </g>
                                    
                                    <!-- Straight ball flight left -->
                                    <line x1="225" y1="260" x2="170" y2="60" stroke="#8b5cf6" stroke-width="5"/>
                                    <circle cx="170" cy="60" r="8" fill="#8b5cf6"/>
                                    
                                    <text x="225" y="305" text-anchor="middle" font-size="18" font-weight="bold" fill="#8b5cf6">PULL (starts left, flies straight)</text>
                                </svg>
                            `,
                            description: "Face -4¬∞, Path -4¬∞ (both left)",
                            keyPoint: `<div class="bg-purple-50 border-2 border-purple-400 rounded-lg p-3">
                                <p class="font-bold mb-2">This is a PULL (starts left, flies straight)!</p>
                                <p class="text-sm">Ball starts left (face -4¬∞) and flies STRAIGHT (face-to-path = 0¬∞ because face equals path). No curve!</p>
                            </div>`,
                            interactive: false
                        },
                        // STEP 2c: Scenario 3
                        {
                            title: "Scenario 3: Over-the-Top Can Hook!",
                            svg: `
                                <svg viewBox="0 0 450 320" class="w-full">
                                    <line x1="225" y1="270" x2="225" y2="50" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                    <text x="225" y="40" text-anchor="middle" fill="#9ca3af" font-size="16" font-weight="bold">TARGET</text>
                                    
                                    <!-- Ball -->
                                    <circle cx="225" cy="270" r="9" fill="#fff" stroke="#000" stroke-width="2"/>
                                    
                                    <!-- FACE arrow (green) - more left (-7¬∞) -->
                                    <g transform="rotate(-21, 225, 270)">
                                        <line x1="225" y1="270" x2="225" y2="160" stroke="#10b981" stroke-width="5"/>
                                        <text x="125" y="200" fill="#10b981" font-size="16" font-weight="bold">FACE</text>
                                        <text x="125" y="220" fill="#10b981" font-size="14">-7¬∞</text>
                                    </g>
                                    
                                    <!-- PATH arrow (blue) - slightly left (-3¬∞, over the top) -->
                                    <g transform="rotate(-9, 225, 270)">
                                        <line x1="225" y1="270" x2="225" y2="160" stroke="#3b82f6" stroke-width="5" stroke-dasharray="8,4"/>
                                        <text x="295" y="200" fill="#3b82f6" font-size="16" font-weight="bold">PATH</text>
                                        <text x="295" y="220" fill="#3b82f6" font-size="14">-3¬∞</text>
                                    </g>
                                    
                                    <!-- Hooking ball flight -->
                                    <path d="M 225 260 Q 165 150, 100 60" stroke="#3b82f6" stroke-width="5" fill="none"/>
                                    <circle cx="100" cy="60" r="8" fill="#3b82f6"/>
                                    
                                    <text x="225" y="305" text-anchor="middle" font-size="18" font-weight="bold" fill="#3b82f6">DRAW/HOOK (starts left, curves MORE left!)</text>
                                </svg>
                            `,
                            description: "Face -7¬∞, Path -3¬∞ (\"over the top\" out-to-in)",
                            keyPoint: `<div class="bg-blue-50 border-2 border-blue-400 rounded-lg p-3">
                                <p class="font-bold mb-2">This HOOKS (starts left, curves MORE left)!</p>
                                <p class="text-sm">Even with an "over the top" out-to-in path (-3¬∞), this WON'T slice! Face is -4¬∞ to path (face -7¬∞ minus path -3¬∞ = -4¬∞), so ball starts left and curves MORE left. This is the anti-slice!</p>
                            </div>`,
                            interactive: false
                        },
                        {
                            title: "Distance Amplifies Errors: +2¬∞ Face-to-Path",
                            svg: `
                                <svg viewBox="0 0 600 180" class="w-full">
                                    <text x="300" y="20" text-anchor="middle" font-size="18" font-weight="bold" fill="#1f2937">+2¬∞ Face-to-Path</text>
                                    
                                    <!-- DRIVER -->
                                    <g transform="translate(50, 40)">
                                        <text x="0" y="0" font-size="16" font-weight="bold" fill="#dc2626">DRIVER (250 yds)</text>
                                        <circle cx="0" cy="40" r="5" fill="#000"/>
                                        <line x1="0" y1="40" x2="0" y2="0" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <path d="M 0 40 Q 10 20, 17 0" stroke="#dc2626" stroke-width="4" fill="none"/>
                                        <circle cx="17" cy="0" r="6" fill="#dc2626"/>
                                        <line x1="0" y1="60" x2="17" y2="60" stroke="#dc2626" stroke-width="2" stroke-dasharray="3,3"/>
                                        <text x="8" y="80" text-anchor="middle" font-size="14" fill="#dc2626" font-weight="bold">17 yards</text>
                                    </g>
                                    
                                    <!-- 7-IRON -->
                                    <g transform="translate(250, 40)">
                                        <text x="0" y="0" font-size="16" font-weight="bold" fill="#f59e0b">7-IRON (150 yds)</text>
                                        <circle cx="0" cy="40" r="5" fill="#000"/>
                                        <line x1="0" y1="40" x2="0" y2="0" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <path d="M 0 40 Q 6 20, 10 0" stroke="#f59e0b" stroke-width="4" fill="none"/>
                                        <circle cx="10" cy="0" r="6" fill="#f59e0b"/>
                                        <line x1="0" y1="60" x2="10" y2="60" stroke="#f59e0b" stroke-width="2" stroke-dasharray="3,3"/>
                                        <text x="5" y="80" text-anchor="middle" font-size="14" fill="#f59e0b" font-weight="bold">10 yards</text>
                                    </g>
                                    
                                    <!-- WEDGE -->
                                    <g transform="translate(450, 40)">
                                        <text x="0" y="0" font-size="16" font-weight="bold" fill="#22c55e">WEDGE (120 yds)</text>
                                        <circle cx="0" cy="40" r="5" fill="#000"/>
                                        <line x1="0" y1="40" x2="0" y2="0" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <path d="M 0 40 Q 4 20, 8 0" stroke="#22c55e" stroke-width="4" fill="none"/>
                                        <circle cx="8" cy="0" r="6" fill="#22c55e"/>
                                        <line x1="0" y1="60" x2="8" y2="60" stroke="#22c55e" stroke-width="2" stroke-dasharray="3,3"/>
                                        <text x="4" y="80" text-anchor="middle" font-size="14" fill="#22c55e" font-weight="bold">8 yards</text>
                                    </g>
                                </svg>
                            `,
                            description: "Small error (+2¬∞) ‚Üí Small amplification",
                            keyPoint: `<div class="bg-green-50 border-2 border-green-400 rounded-lg p-3">
                                <p class="font-bold mb-2">Manageable Miss!</p>
                                <p class="text-sm">Even with driver, 17 yards offline is recoverable. This is why pros can play with small face-to-path errors.</p>
                            </div>`,
                            interactive: false
                        },
                        // STEP 5b: +5¬∞ Face-to-Path
                        {
                            title: "Distance Amplifies Errors: +5¬∞ Face-to-Path",
                            svg: `
                                <svg viewBox="0 0 600 180" class="w-full">
                                    <text x="300" y="20" text-anchor="middle" font-size="18" font-weight="bold" fill="#1f2937">+5¬∞ Face-to-Path</text>
                                    
                                    <!-- DRIVER -->
                                    <g transform="translate(50, 40)">
                                        <text x="0" y="0" font-size="16" font-weight="bold" fill="#dc2626">DRIVER (250 yds)</text>
                                        <circle cx="0" cy="40" r="5" fill="#000"/>
                                        <line x1="0" y1="40" x2="0" y2="0" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <path d="M 0 40 Q 25 20, 42 0" stroke="#dc2626" stroke-width="4" fill="none"/>
                                        <circle cx="42" cy="0" r="6" fill="#dc2626"/>
                                        <line x1="0" y1="60" x2="42" y2="60" stroke="#dc2626" stroke-width="2" stroke-dasharray="3,3"/>
                                        <text x="21" y="80" text-anchor="middle" font-size="14" fill="#dc2626" font-weight="bold">42 yards</text>
                                    </g>
                                    
                                    <!-- 7-IRON -->
                                    <g transform="translate(250, 40)">
                                        <text x="0" y="0" font-size="16" font-weight="bold" fill="#f59e0b">7-IRON (150 yds)</text>
                                        <circle cx="0" cy="40" r="5" fill="#000"/>
                                        <line x1="0" y1="40" x2="0" y2="0" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <path d="M 0 40 Q 15 20, 25 0" stroke="#f59e0b" stroke-width="4" fill="none"/>
                                        <circle cx="25" cy="0" r="6" fill="#f59e0b"/>
                                        <line x1="0" y1="60" x2="25" y2="60" stroke="#f59e0b" stroke-width="2" stroke-dasharray="3,3"/>
                                        <text x="12" y="80" text-anchor="middle" font-size="14" fill="#f59e0b" font-weight="bold">25 yards</text>
                                    </g>
                                    
                                    <!-- WEDGE -->
                                    <g transform="translate(450, 40)">
                                        <text x="0" y="0" font-size="16" font-weight="bold" fill="#22c55e">WEDGE (120 yds)</text>
                                        <circle cx="0" cy="40" r="5" fill="#000"/>
                                        <line x1="0" y1="40" x2="0" y2="0" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <path d="M 0 40 Q 10 20, 20 0" stroke="#22c55e" stroke-width="4" fill="none"/>
                                        <circle cx="20" cy="0" r="6" fill="#22c55e"/>
                                        <line x1="0" y1="60" x2="20" y2="60" stroke="#22c55e" stroke-width="2" stroke-dasharray="3,3"/>
                                        <text x="10" y="80" text-anchor="middle" font-size="14" fill="#22c55e" font-weight="bold">20 yards</text>
                                    </g>
                                </svg>
                            `,
                            description: "Medium error (+5¬∞) ‚Üí Big trouble with driver!",
                            keyPoint: `<div class="bg-orange-50 border-2 border-orange-400 rounded-lg p-3">
                                <p class="font-bold mb-2">Driver in the Trees!</p>
                                <p class="text-sm">42 yards offline with driver = out of bounds. But wedge at 20 yards is still playable. Same swing error, dramatically different outcome!</p>
                            </div>`,
                            interactive: false
                        },
                        // STEP 5c: +8¬∞ Face-to-Path
                        {
                            title: "Distance Amplifies Errors: +8¬∞ Face-to-Path",
                            svg: `
                                <svg viewBox="0 0 600 180" class="w-full">
                                    <text x="300" y="20" text-anchor="middle" font-size="18" font-weight="bold" fill="#1f2937">+8¬∞ Face-to-Path (BIG slice!)</text>
                                    
                                    <!-- DRIVER -->
                                    <g transform="translate(50, 40)">
                                        <text x="0" y="0" font-size="16" font-weight="bold" fill="#dc2626">DRIVER (250 yds)</text>
                                        <circle cx="0" cy="40" r="5" fill="#000"/>
                                        <line x1="0" y1="40" x2="0" y2="0" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <path d="M 0 40 Q 40 20, 67 0" stroke="#dc2626" stroke-width="4" fill="none"/>
                                        <circle cx="67" cy="0" r="6" fill="#dc2626"/>
                                        <line x1="0" y1="60" x2="67" y2="60" stroke="#dc2626" stroke-width="2" stroke-dasharray="3,3"/>
                                        <text x="33" y="80" text-anchor="middle" font-size="14" fill="#dc2626" font-weight="bold">67 yards!</text>
                                    </g>
                                    
                                    <!-- 7-IRON -->
                                    <g transform="translate(250, 40)">
                                        <text x="0" y="0" font-size="16" font-weight="bold" fill="#f59e0b">7-IRON (150 yds)</text>
                                        <circle cx="0" cy="40" r="5" fill="#000"/>
                                        <line x1="0" y1="40" x2="0" y2="0" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <path d="M 0 40 Q 24 20, 40 0" stroke="#f59e0b" stroke-width="4" fill="none"/>
                                        <circle cx="40" cy="0" r="6" fill="#f59e0b"/>
                                        <line x1="0" y1="60" x2="40" y2="60" stroke="#f59e0b" stroke-width="2" stroke-dasharray="3,3"/>
                                        <text x="20" y="80" text-anchor="middle" font-size="14" fill="#f59e0b" font-weight="bold">40 yards</text>
                                    </g>
                                    
                                    <!-- WEDGE -->
                                    <g transform="translate(450, 40)">
                                        <text x="0" y="0" font-size="16" font-weight="bold" fill="#22c55e">WEDGE (120 yds)</text>
                                        <circle cx="0" cy="40" r="5" fill="#000"/>
                                        <line x1="0" y1="40" x2="0" y2="0" stroke="#d1d5db" stroke-width="2" stroke-dasharray="4,4"/>
                                        <path d="M 0 40 Q 16 20, 32 0" stroke="#22c55e" stroke-width="4" fill="none"/>
                                        <circle cx="32" cy="0" r="6" fill="#22c55e"/>
                                        <line x1="0" y1="60" x2="32" y2="60" stroke="#22c55e" stroke-width="2" stroke-dasharray="3,3"/>
                                        <text x="16" y="80" text-anchor="middle" font-size="14" fill="#22c55e" font-weight="bold">32 yards</text>
                                    </g>
                                </svg>
                            `,
                            description: "Big error (+8¬∞) ‚Üí MASSIVE amplification with driver!",
                            keyPoint: `<div class="bg-red-50 border-2 border-red-400 rounded-lg p-3">
                                <p class="font-bold mb-2">Unplayable with Driver!</p>
                                <p class="text-sm">67 yards offline = two fairways over! But even wedge is only 32 yards offline. This is why slicers should practice with short irons first - same swing flaw, but manageable results.</p>
                            </div>`,
                            interactive: false
                        },
                    ],
                    moreInfo: `
                        <div class="space-y-3 text-sm">
                            <div class="bg-gray-50 p-3 rounded">
                                <p class="font-semibold mb-1">üìä Real Examples:</p>
                                <p>‚Ä¢ Face +5¬∞, Path +3¬∞ ‚Üí Face is 2¬∞ RIGHT of path = FADE</p>
                                <p>‚Ä¢ Face -2¬∞, Path +3¬∞ ‚Üí Face is 5¬∞ LEFT of path = DRAW</p>
                                <p>‚Ä¢ Face +4¬∞, Path +4¬∞ ‚Üí Face EQUALS path = PUSH (straight right)</p>
                            </div>
                            <div class="bg-blue-50 p-3 rounded">
                                <p class="font-semibold mb-1">üí° Why Amateurs Struggle:</p>
                                <p>Most golfers trying to "swing from the inside" to fix a slice actually open the face MORE relative to their new path, making the slice worse! Fix the face-to-path relationship, not just the path.</p>
                            </div>
                        </div>
                    `
                },
                2: {
                    title: "Level 2: Horizontal Gear Effect & Start Direction",
                    content: `
                        <h3 class="text-xl font-bold mb-3" style="color: var(--augusta-green);">New Data: Horizontal Impact Location (Toe/Heel)</h3>
                        <p class="mb-4">You've mastered face-to-path! Now learn how <strong>off-center hits</strong> create gear effect that changes your shot.</p>
                        
                        <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">‚öôÔ∏è What is Gear Effect?</h4>
                            <p class="mb-3">Hit the ball off-center and the clubface twists at impact. This twisting adds extra spin that changes where your ball ends up.</p>
                            
                            <div class="bg-white p-3 rounded mb-2">
                                <p class="font-semibold">TOE hit (10mm towards toe):</p>
                                <p class="text-sm">‚Ä¢ Face twists CLOSED at impact</p>
                                <p class="text-sm">‚Ä¢ Adds DRAW spin (ball curves LEFT)</p>
                                <p class="text-sm">‚Ä¢ Driver: adds about 1.5¬∞ of draw = <strong>5 extra yards left</strong></p>
                            </div>
                            
                            <div class="bg-white p-3 rounded mb-2">
                                <p class="font-semibold">HEEL hit (10mm towards heel):</p>
                                <p class="text-sm">‚Ä¢ Face twists OPEN at impact</p>
                                <p class="text-sm">‚Ä¢ Adds FADE spin (ball curves RIGHT)</p>
                                <p class="text-sm">‚Ä¢ Driver: adds about 1.5¬∞ of fade = <strong>5 extra yards right</strong></p>
                            </div>
                            
                            <div class="bg-white p-3 rounded">
                                <p class="font-semibold">CENTER hit (perfect strike):</p>
                                <p class="text-sm">‚Ä¢ No twisting = No gear effect</p>
                                <p class="text-sm">‚Ä¢ Ball curves exactly as face-to-path predicts</p>
                            </div>
                            
                            <p class="text-sm italic mt-3 text-gray-700">üí° The farther off-center you hit it, the more twist, the more extra spin!</p>
                        </div>
                        
                        <div class="bg-amber-50 border-l-4 border-amber-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">‚ö†Ô∏è Gear Effect Can Help OR Hurt!</h4>
                            <p class="mb-3">Here's where it gets interesting - sometimes your mishit actually HELPS your shot:</p>
                            
                            <div class="bg-white p-3 rounded mb-2">
                                <p class="font-semibold text-sm">Scenario: Trying to hit a fade</p>
                                <p class="text-sm">‚Ä¢ Your face-to-path: +3¬∞ (fade tendency)</p>
                                <p class="text-sm">‚Ä¢ You hit the HEEL: adds MORE fade spin</p>
                                <p class="text-sm text-green-600 font-semibold">‚úì Gear effect HELPS - even bigger fade!</p>
                            </div>
                            
                            <div class="bg-white p-3 rounded">
                                <p class="font-semibold text-sm">Scenario: Trying to hit a fade</p>
                                <p class="text-sm">‚Ä¢ Your face-to-path: +3¬∞ (fade tendency)</p>
                                <p class="text-sm">‚Ä¢ You hit the TOE: adds draw spin</p>
                                <p class="text-sm text-red-600 font-semibold">‚úó Gear effect FIGHTS - reduces your fade!</p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üéØ Where Does the Ball Start?</h4>
                            <p class="mb-2">You'll also predict where the ball <strong>starts</strong> before it curves:</p>
                            <p class="text-sm mb-3">Your face angle controls about 85% of where the ball starts. Path has a small influence, but face dominates.</p>
                            
                            <div class="bg-white p-3 rounded">
                                <p class="text-sm"><strong>Example:</strong> Face is 4¬∞ open, path is 1¬∞ out-to-in</p>
                                <p class="text-sm">Ball starts about <strong>3.5¬∞ right</strong> of target (mostly following the face)</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-100 rounded-lg p-4">
                            <h4 class="font-bold mb-2">üìä Real Example - Driver Shot:</h4>
                            <div class="bg-white p-3 rounded">
                                <p class="font-semibold mb-2">Your swing: Face +3¬∞ open | Path 2¬∞ in-to-out | Impact 8mm TOE</p>
                                
                                <p class="text-sm mb-1"><strong>Face-to-path:</strong> 3¬∞ - 2¬∞ = 1¬∞ fade tendency</p>
                                <p class="text-sm mb-1"><strong>Driver at 250 yards:</strong> 1¬∞ fade = about 8 yards right</p>
                                
                                <p class="text-sm mb-1 mt-2"><strong>But you hit the toe!</strong></p>
                                <p class="text-sm mb-1">8mm toe on driver = about 1.2¬∞ DRAW spin (opposite direction!)</p>
                                
                                <p class="text-sm mt-2 font-semibold text-blue-600">Final Result:</p>
                                <p class="text-sm">Ball starts right, but moves only 2 yards right total</p>
                                <p class="text-sm">(The toe hit fought most of your fade and nearly straightened it out!)</p>
                                <p class="text-xs text-gray-500 mt-2 italic">Source: Calculation based on TrackMan PGA Tour curve data</p>
                            </div>
                        </div>
                        
                        <p class="text-sm italic text-gray-600 mt-4">üí° Pro Tip: TrackMan shows horizontal impact location. Now you understand why tour pros obsess over it!</p>
                    `
                },
                3: {
                    title: "Level 3: Vertical Impact & Total Offline Distance",
                    content: `
                        <h3 class="text-xl font-bold mb-3" style="color: var(--augusta-green);">New Data: Vertical Impact Location (High/Low on Face)</h3>
                        <p class="mb-4">You've mastered horizontal impact! Now let's add the <strong>vertical dimension</strong> - hitting high or low on the clubface.</p>
                        
                        <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">‚öôÔ∏è Vertical Impact: The Volume Knob</h4>
                            <p class="mb-3">Think of vertical impact as a volume knob for your curve. It doesn't create NEW spin - it turns up or down the spin you already have.</p>
                            
                            <div class="bg-white p-3 rounded mb-2">
                                <p class="font-semibold">Hit HIGH on the face (8mm above center):</p>
                                <p class="text-sm">‚Ä¢ Your curve gets AMPLIFIED by about 15%</p>
                                <p class="text-sm">‚Ä¢ 10-yard draw? Now it's a 12-yard draw</p>
                                <p class="text-sm">‚Ä¢ 10-yard fade? Now it's a 12-yard fade</p>
                                <p class="text-sm font-semibold text-red-600 mt-1">Volume turned UP - bigger curve!</p>
                            </div>
                            
                            <div class="bg-white p-3 rounded mb-2">
                                <p class="font-semibold">Hit LOW on the face (8mm below center):</p>
                                <p class="text-sm">‚Ä¢ Your curve gets DAMPENED by about 15%</p>
                                <p class="text-sm">‚Ä¢ 10-yard draw? Now it's an 8-yard draw</p>
                                <p class="text-sm">‚Ä¢ 10-yard fade? Now it's an 8-yard fade</p>
                                <p class="text-sm font-semibold text-blue-600 mt-1">Volume turned DOWN - smaller curve!</p>
                            </div>
                            
                            <div class="bg-white p-3 rounded">
                                <p class="font-semibold">Hit CENTER vertically:</p>
                                <p class="text-sm">‚Ä¢ Normal curve - exactly as face-to-path predicts</p>
                                <p class="text-sm">‚Ä¢ No amplification, no dampening</p>
                            </div>
                        </div>
                        
                        <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üéØ Total Offline Distance</h4>
                            <p class="mb-3">At Level 3, you're predicting where the ball finishes - the TOTAL distance offline. Here's what affects it:</p>
                            
                            <div class="bg-white p-3 rounded mb-3">
                                <p class="font-semibold mb-2">Real Example - 7-Iron Shot:</p>
                                <p class="text-sm mb-1">Face: 2¬∞ open, Path: 0¬∞ (neutral)</p>
                                <p class="text-sm mb-1">Impact: 8mm toe, 5mm high</p>
                                
                                <p class="text-sm mt-2"><strong>Step 1 - Where does it start?</strong></p>
                                <p class="text-sm">Face is 2¬∞ open ‚Üí starts about 1.5¬∞ right of target</p>
                                <p class="text-sm">At 150 yards: starts 4 yards right</p>
                                
                                <p class="text-sm mt-2"><strong>Step 2 - How much does it curve?</strong></p>
                                <p class="text-sm">Face-to-path: 2¬∞ fade = 6 yards right normally</p>
                                <p class="text-sm">But 8mm toe adds 0.6¬∞ draw (fights the fade!)</p>
                                <p class="text-sm">Net curve: 1.4¬∞ fade = 4 yards right</p>
                                <p class="text-sm">5mm high amplifies by 8%: 4.3 yards right</p>
                                
                                <p class="text-sm mt-2 font-semibold text-blue-600">Total: Starts 4 yards right + curves 4 yards right = <strong>8 yards right of target</strong></p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üí° Why This Matters on the Course</h4>
                            <p class="text-sm mb-2">Tour pros use vertical impact strategically:</p>
                            <div class="bg-white p-3 rounded space-y-2">
                                <p class="text-sm"><strong>Need a BIG curve?</strong> Tee it high, hit high on face (amplify)</p>
                                <p class="text-sm"><strong>Want a controlled fade?</strong> Hit center or slightly low (normal or dampened)</p>
                                <p class="text-sm"><strong>Fighting a hook?</strong> Hit low on face (dampens the draw)</p>
                            </div>
                        </div>
                        
                        <p class="text-sm italic text-gray-600 mt-4">üí° Pro Tip: TrackMan shows both horizontal AND vertical impact. Now you see why both numbers matter!</p>
                    `
                },
                4: {
                    title: "Level 4: Lie Angle Effects",
                    content: `
                        <h3 class="text-xl font-bold mb-3" style="color: var(--augusta-green);">New Variable: Lie Angle</h3>
                        <p class="mb-4">Welcome to <strong>Championship Level</strong>! Now you'll learn about lie angle - how the club sits at impact, which silently changes your face angle.</p>
                        
                        <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üìê What Is Lie Angle?</h4>
                            <p class="mb-3">Lie angle is whether the club sits upright (toe up) or flat (toe down) at impact. This automatically adjusts where your face points!</p>
                            
                            <div class="bg-white p-3 rounded mb-2">
                                <p class="font-semibold">UPRIGHT Lie (club more vertical):</p>
                                <p class="text-sm">‚Ä¢ Face automatically CLOSES (points left)</p>
                                <p class="text-sm">‚Ä¢ Ball starts and curves LEFT</p>
                                <p class="text-sm">‚Ä¢ 2¬∞ upright on 7-iron? Face closes about 1¬∞ left</p>
                            </div>
                            
                            <div class="bg-white p-3 rounded">
                                <p class="font-semibold">FLAT Lie (club more horizontal):</p>
                                <p class="text-sm">‚Ä¢ Face automatically OPENS (points right)</p>
                                <p class="text-sm">‚Ä¢ Ball starts and curves RIGHT</p>
                                <p class="text-sm">‚Ä¢ 2¬∞ flat on 7-iron? Face opens about 1¬∞ right</p>
                            </div>
                        </div>

                        <div class="bg-gray-100 rounded-lg p-4 mb-4">
                            <h4 class="font-bold mb-3">üìä Real Examples:</h4>
                            
                            <div class="bg-white p-3 rounded mb-3">
                                <p class="font-semibold mb-2">7-Iron with 3¬∞ Upright Lie:</p>
                                <p class="text-sm">Your swing face angle: +2¬∞ open (pointing right)</p>
                                <p class="text-sm">But upright lie CLOSES it about 1.5¬∞</p>
                                <p class="text-sm font-semibold text-blue-600 mt-1">Actual face at impact: Only 0.5¬∞ open!</p>
                                <p class="text-sm text-gray-600 mt-1">(Shot goes much straighter than you thought)</p>
                            </div>
                            
                            <div class="bg-white p-3 rounded mb-3">
                                <p class="font-semibold mb-2">Pitching Wedge with 3¬∞ Flat Lie:</p>
                                <p class="text-sm">Your swing face angle: 1¬∞ closed (pointing left)</p>
                                <p class="text-sm">But flat lie OPENS it about 2¬∞</p>
                                <p class="text-sm font-semibold text-blue-600 mt-1">Actual face at impact: Now 1¬∞ OPEN!</p>
                                <p class="text-sm text-gray-600 mt-1">(Your draw just became a fade!)</p>
                            </div>
                            
                            <div class="bg-white p-3 rounded">
                                <p class="font-semibold mb-2">Driver with 2¬∞ Upright Lie:</p>
                                <p class="text-sm">Your swing face angle: +3¬∞ open</p>
                                <p class="text-sm">Driver barely feels lie changes (only 0.6¬∞ effect)</p>
                                <p class="text-sm font-semibold text-blue-600 mt-1">Actual face: Still about 2.4¬∞ open</p>
                                <p class="text-sm text-gray-600 mt-1">(Driver is less sensitive to lie than irons)</p>
                            </div>
                        </div>

                        <div class="bg-amber-50 border-2 border-amber-500 rounded-lg p-4 mb-4">
                            <h4 class="font-bold mb-2 text-amber-900">‚ö†Ô∏è Important: Use the ADJUSTED Face</h4>
                            <p class="text-sm">Once lie angle adjusts your face, use that NEW face angle for everything - face-to-path, start direction, offline distance. Think of lie angle as changing what face you actually delivered.</p>
                        </div>

                        <div class="bg-green-50 border-l-4 border-green-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üéØ Why This Matters</h4>
                            <p class="text-sm mb-2">This explains common fitting issues:</p>
                            <p class="text-sm">‚Ä¢ Tall player with standard clubs = upright lie = closes face = fights hooks</p>
                            <p class="text-sm">‚Ä¢ Short player with standard clubs = flat lie = opens face = fights slices</p>
                            <p class="text-sm mt-2 font-semibold">Getting fit for proper lie angle is crucial for accuracy!</p>
                        </div>
                        
                        <p class="text-sm italic text-gray-600">üí° Pro Tip: Wind comes next at Level 5. Master lie angle first - it's often overlooked but hugely important!</p>
                    `
                },
                5: {
                    title: "Level 5: Wind Effects & Ultimate Challenge",
                    content: `
                        <h3 class="text-xl font-bold mb-3" style="color: var(--augusta-green);">New Variable: Wind Conditions</h3>
                        <p class="mb-4">The final piece! Wind dramatically changes how your ball flies - sometimes helping, sometimes hurting, always unpredictable.</p>
                        
                        <div class="bg-sky-50 border-l-4 border-sky-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üí® How Wind Affects Your Shot:</h4>
                            
                            <div class="bg-white p-3 rounded mb-2">
                                <p class="font-semibold">HEADWIND (into the wind):</p>
                                <p class="text-sm">‚Ä¢ Ball flies HIGHER (more lift)</p>
                                <p class="text-sm">‚Ä¢ Curve gets AMPLIFIED (ball in air longer)</p>
                                <p class="text-sm">‚Ä¢ Distance SHORTER (drag slows it down)</p>
                                <p class="text-sm font-semibold text-red-600 mt-1">10mph headwind on driver: Lose ~25 yards, curve 10-20% more!</p>
                            </div>
                            
                            <div class="bg-white p-3 rounded mb-2">
                                <p class="font-semibold">TAILWIND (wind from behind):</p>
                                <p class="text-sm">‚Ä¢ Ball flies LOWER (less lift)</p>
                                <p class="text-sm">‚Ä¢ Curve gets DAMPENED (ball falls faster)</p>
                                <p class="text-sm">‚Ä¢ Distance LONGER (wind pushes it)</p>
                                <p class="text-sm font-semibold text-green-600 mt-1">10mph tailwind on driver: Gain ~15 yards, curve 10% less</p>
                                <p class="text-xs text-gray-600 mt-1">Note: Tailwind helps HALF as much as headwind hurts!</p>
                            </div>
                            
                            <div class="bg-white p-3 rounded">
                                <p class="font-semibold">CROSSWIND (left or right):</p>
                                <p class="text-sm">‚Ä¢ Pushes ball sideways during flight</p>
                                <p class="text-sm">‚Ä¢ Doesn't change your curve much</p>
                                <p class="text-sm">‚Ä¢ Just adds lateral push</p>
                                <p class="text-sm font-semibold text-blue-600 mt-1">15mph crosswind on 200-yard shot: ~15 yards sideways push!</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-100 rounded-lg p-4 mb-4">
                            <h4 class="font-bold mb-2">üìä Real Example - 5¬∞ Fade with Driver:</h4>
                            <div class="bg-white p-3 rounded">
                                <p class="text-sm"><strong>Calm conditions:</strong> 5¬∞ fade = about 13 yards right</p>
                                <p class="text-sm mt-1"><strong>15mph headwind:</strong> Same 5¬∞ fade = about 15 yards right</p>
                                <p class="text-sm"><strong>15mph tailwind:</strong> Same 5¬∞ fade = about 11 yards right</p>
                                <p class="text-sm mt-2 text-gray-600">The fade itself doesn't change - but how much time it has to curve does!</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üí° Strategic Thinking:</h4>
                            <p class="text-sm">‚Ä¢ Into headwind: Take MORE club, swing easier (don't create more spin!)</p>
                            <p class="text-sm">‚Ä¢ With tailwind: Take LESS club, expect more roll</p>
                            <p class="text-sm">‚Ä¢ Crosswind: Aim to account for push, or play INTO wind and let it drift</p>
                            <p class="text-sm mt-2 font-semibold">Wind is where course management becomes critical!</p>
                        </div>
                        
                        <p class="text-sm italic text-gray-600 mt-4">üí° Level 5: Master all variables together! Perfect scenarios unlock the secret boss level!</p>
                    `
                },
                6: {
                    title: "Level 6: Grand Slam Winner - SECRET BOSS",
                    content: `
                        <h3 class="text-xl font-bold mb-3" style="color: #9333ea;">üèÜ CONGRATULATIONS! üèÜ</h3>
                        <p class="mb-4">You've unlocked the <strong>SECRET BOSS LEVEL</strong>. This is the ultimate test - synthesizing EVERYTHING you've learned!</p>
                        
                        <div class="bg-indigo-50 border-l-4 border-indigo-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üéØ Level 6 Challenge:</h4>
                            <p class="mb-3">You'll face scenarios with ALL variables active simultaneously:</p>
                            <p class="text-sm">‚Ä¢ Face angle + Path + Face-to-path (Level 1)</p>
                            <p class="text-sm">‚Ä¢ Horizontal impact = Gear effect (Level 2)</p>
                            <p class="text-sm">‚Ä¢ Vertical impact = Amplify/dampen (Level 3)</p>
                            <p class="text-sm">‚Ä¢ Lie angle = Face adjustment (Level 4)</p>
                            <p class="text-sm">‚Ä¢ Wind = Distance & curve changes (Level 5)</p>
                            <p class="text-sm mt-2 font-semibold text-purple-700">Can you predict where the ball finishes when everything happens at once?</p>
                        </div>
                        
                        <div class="bg-gray-100 rounded-lg p-4 mb-4">
                            <h4 class="font-bold mb-2">üìä Boss Level Example:</h4>
                            <div class="bg-white p-3 rounded">
                                <p class="font-semibold mb-2">7-Iron, 15mph Headwind:</p>
                                <p class="text-sm">‚Ä¢ Original face: +2¬∞ open, but 3¬∞ upright lie closes it to +0.5¬∞</p>
                                <p class="text-sm">‚Ä¢ Path: -1¬∞ ‚Üí Face-to-path: 1.5¬∞ fade tendency</p>
                                <p class="text-sm">‚Ä¢ Impact: 6mm toe (adds draw spin, fights the fade)</p>
                                <p class="text-sm">‚Ä¢ Impact: 5mm high (amplifies the curve)</p>
                                <p class="text-sm">‚Ä¢ Headwind: Amplifies everything further</p>
                                <p class="text-sm mt-2 font-semibold text-blue-600">Net result: Slight fade, about 4 yards right... can you see why?</p>
                            </div>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üí° What Makes Level 6 Hard:</h4>
                            <p class="text-sm">‚Ä¢ Multiple forces working together AND against each other</p>
                            <p class="text-sm">‚Ä¢ Strategic questions about which variable matters most</p>
                            <p class="text-sm">‚Ä¢ Course management decisions</p>
                            <p class="text-sm mt-2 font-semibold">This is TrackMan-level analysis. You're thinking like a tour pro!</p>
                        </div>
                        
                        <p class="text-sm italic text-gray-600 mt-4">üèÜ Beat Level 6 and you've mastered golf ball flight physics! Share your victory!</p>
                    `
                },
                7: {
                    title: "Level 7: Lie Angle Effects",
                    content: `
                        <h3 class="text-xl font-bold mb-3" style="color: var(--augusta-green);">New Variable: Lie Angle</h3>
                        <p class="mb-4">Welcome to advanced golf physics! <strong>Lie angle</strong> is how upright or flat the club sits at address - and it <strong>changes your clubface angle</strong> at impact.</p>
                        
                        <div class="bg-red-50 border-l-4 border-red-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üìê What is Lie Angle?</h4>
                            <p class="mb-2">The angle between the club shaft and the ground when addressing the ball.</p>
                            <ul class="list-disc ml-6 space-y-2">
                                <li><strong>UPRIGHT LIE</strong> (positive degrees):
                                    <ul class="list-circle ml-6 text-sm mt-1">
                                        <li>Shaft more vertical at address</li>
                                        <li>Toe UP in the air</li>
                                        <li>Face effectively CLOSES (points left)</li>
                                        <li>Club-specific multipliers (driver ~0.3, wedge ~0.7)</li>
                                    </ul>
                                </li>
                                <li><strong>FLAT LIE</strong> (negative degrees):
                                    <ul class="list-circle ml-6 text-sm mt-1">
                                        <li>Shaft more horizontal at address</li>
                                        <li>Heel UP in the air</li>
                                        <li>Face effectively OPENS (points right)</li>
                                        <li>Club-specific multipliers (driver ~0.3, wedge ~0.7)</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="bg-gray-100 rounded-lg p-4 mb-4">
                            <h4 class="font-bold mb-2">üìä How Lie Angle Changes Everything:</h4>
                            <div class="space-y-3">
                                <div class="bg-white p-3 rounded">
                                    <p class="font-semibold">Example: Face shows -2¬∞, Lie is +3¬∞ upright (Iron)</p>
                                    <p class="text-sm mt-1"><strong>Calculation:</strong> -2¬∞ face + (3¬∞ √ó -0.5) = -3.5¬∞ effective face</p>
                                    <p class="text-sm text-blue-600 font-bold">The upright lie CLOSED the face by 1.5¬∞!</p>
                                </div>
                                <div class="bg-white p-3 rounded">
                                    <p class="font-semibold">Example: Face shows +4¬∞, Lie is -2¬∞ flat (Iron)</p>
                                    <p class="text-sm mt-1"><strong>Calculation:</strong> +4¬∞ face + (-2¬∞ √ó -0.5) = +5¬∞ effective face</p>
                                    <p class="text-sm text-orange-600 font-bold">The flat lie OPENED the face by 1¬∞!</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="bg-purple-50 border-l-4 border-purple-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">‚ö° Complex Interactions</h4>
                            <p class="mb-2">Now you're juggling FOUR variables simultaneously:</p>
                            <ol class="list-decimal ml-6 space-y-1 text-sm">
                                <li>Original face angle (modified by lie)</li>
                                <li>Path direction</li>
                                <li>Horizontal impact (toe/heel gear effect)</li>
                                <li>Vertical impact (high/low amplification)</li>
                            </ol>
                            <p class="mt-3 text-sm font-semibold">You must calculate the EFFECTIVE face after lie adjustment, then proceed with normal analysis!</p>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üéØ Why This Matters</h4>
                            <p class="mb-2 text-sm">Lie angle explains why:</p>
                            <ul class="list-disc ml-6 space-y-1 text-sm">
                                <li>Taller players tend to hook (upright clubs close face)</li>
                                <li>Shorter players tend to slice (flat clubs open face)</li>
                                <li>Getting fit for proper lie angle is crucial</li>
                                <li>Same swing can produce different results with different lies</li>
                            </ul>
                        </div>
                        
                        <p class="text-sm italic text-gray-600">üí° Pro Tip: Always calculate effective face FIRST (original face + lie adjustment), then analyze path relationship!</p>
                        
                        <hr class="my-6 border-t-2 border-gray-300">
                        
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h4 class="font-bold mb-4 text-xl" style="color: var(--augusta-green);">üìñ What We've Already Learned</h4>
                            
                            <div class="bg-white rounded-lg p-4 mb-3">
                                <h5 class="font-bold mb-2 text-green-700">‚úÖ Level 1-2: Ball Flight Fundamentals</h5>
                                <div class="space-y-1 text-sm">
                                    <p><strong>Face-to-Path:</strong> Difference between face and path creates curve.</p>
                                    <p><strong>Start Direction:</strong> Controlled by face angle (75-85%).</p>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 mb-3">
                                <h5 class="font-bold mb-2 text-purple-700">‚úÖ Level 3-4: Horizontal Gear Effect</h5>
                                <div class="space-y-1 text-sm">
                                    <p><strong>Toe Hits:</strong> Create draw spin, fight fades.</p>
                                    <p><strong>Heel Hits:</strong> Create fade spin, fight draws.</p>
                                    <p><strong>Key Insight:</strong> Gear effect can help or hurt depending on your face-to-path relationship.</p>
                                </div>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 mb-3">
                                <h5 class="font-bold mb-2 text-indigo-700">‚úÖ Level 5-6: Vertical Gear Effect</h5>
                                <div class="space-y-1 text-sm">
                                    <p><strong>High on Face:</strong> Amplifies sidespin - curves MORE than expected. Draws become hooks, fades become slices.</p>
                                    <p><strong>Low on Face:</strong> Dampens sidespin - curves LESS than expected. Hooks become draws, slices become fades.</p>
                                    <p><strong>Club-Specific:</strong> Drivers amplify more (1.3x), wedges less (1.05x).</p>
                                </div>
                            </div>
                        </div>
                    `
                },
                8: {
                    title: "Level 8: Wind Effects on Ball Flight",
                    content: `
                        <h3 class="text-xl font-bold mb-3" style="color: var(--augusta-green);">New Variable: Wind</h3>
                        <p class="mb-4">You've mastered club dynamics. Now face <strong>nature's wildcard</strong>: wind conditions that alter distance and curve!</p>
                        
                        <div class="bg-sky-50 border-l-4 border-sky-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üí® Headwind (Against You)</h4>
                            <ul class="list-disc ml-6 space-y-2">
                                <li><strong>Distance:</strong> Loses ~2 yards per mph
                                    <ul class="list-circle ml-6 text-sm mt-1">
                                        <li>10 mph headwind = -20 yards carry</li>
                                        <li>20 mph headwind = -40 yards carry</li>
                                    </ul>
                                </li>
                                <li><strong>Spin Amplification:</strong> Makes ball curve MORE
                                    <ul class="list-circle ml-6 text-sm mt-1">
                                        <li>Draws become hooks in headwind</li>
                                        <li>Fades become slices in headwind</li>
                                        <li>Straight shots stay straighter (no spin to amplify)</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="bg-green-50 border-l-4 border-green-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üçÉ Tailwind (Helping You)</h4>
                            <ul class="list-disc ml-6 space-y-2">
                                <li><strong>Distance:</strong> Gains ~1 yard per mph
                                    <ul class="list-circle ml-6 text-sm mt-1">
                                        <li>10 mph tailwind = +10 yards carry</li>
                                        <li>20 mph tailwind = +20 yards carry</li>
                                        <li>Note: Less impact than headwind!</li>
                                    </ul>
                                </li>
                                <li><strong>Spin Reduction:</strong> Makes ball curve LESS
                                    <ul class="list-circle ml-6 text-sm mt-1">
                                        <li>Hooks become draws in tailwind</li>
                                        <li>Slices become fades in tailwind</li>
                                        <li>Helps straighten out bad shots</li>
                                    </ul>
                                </li>
                            </ul>
                        </div>
                        
                        <div class="bg-orange-50 border-l-4 border-orange-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">‚ÜîÔ∏è Crosswind (Left or Right)</h4>
                            <p class="mb-2">Pushes the ball laterally based on carry distance:</p>
                            <ul class="list-disc ml-6 space-y-1 text-sm">
                                <li><strong>Tier 1 (Weak):</strong> 0.5 yards per 10 yards carry per 10mph wind</li>
                                <li><strong>Tier 2 (Medium):</strong> 0.75 yards per 10 yards carry per 10mph wind</li>
                                <li><strong>Tier 3 (Strong):</strong> 1.0 yards per 10 yards carry per 10mph wind</li>
                            </ul>
                            <div class="bg-white p-3 rounded mt-3">
                                <p class="font-semibold text-sm">Example: 200yd carry, 15mph crosswind (Tier 2)</p>
                                <p class="text-sm">Lateral push = (200 / 10) √ó 0.75 √ó 1.5 = 22.5 yards sideways!</p>
                            </div>
                        </div>
                        
                        <div class="bg-gray-100 rounded-lg p-4 mb-4">
                            <h4 class="font-bold mb-2">üìä Wind Distribution (Bell Curve)</h4>
                            <p class="text-sm mb-2">Wind speed follows a realistic bell curve centered at 7mph:</p>
                            <ul class="list-disc ml-6 space-y-1 text-sm">
                                <li>Most common: 5-9 mph (moderate breeze)</li>
                                <li>Occasional: 0-4 mph (calm) or 10-14 mph (breezy)</li>
                                <li>Rare: 15+ mph (windy conditions)</li>
                                <li>Direction: Random (head/tail/cross left/cross right)</li>
                            </ul>
                        </div>
                        
                        <div class="bg-yellow-50 border-l-4 border-yellow-600 p-4 mb-4">
                            <h4 class="font-bold mb-2">üß† Strategic Questions</h4>
                            <p class="mb-2 text-sm">New challenges at Level 8:</p>
                            <ul class="list-disc ml-6 space-y-1 text-sm">
                                <li>"Will this headwind help or hurt the shot shape?"</li>
                                <li>"How does tailwind change the curve severity?"</li>
                                <li>Hypothetical scenarios with different wind conditions</li>
                                <li>15% trick scenarios (watch out!)</li>
                            </ul>
                        </div>
                        
                        <p class="text-sm italic text-gray-600">üí° Pro Tip: Headwind = more curve. Tailwind = less curve. Crosswind = lateral push. Master these and you're ready for any conditions!</p>
                        
                        <hr class="my-6 border-t-2 border-gray-300">
                        
                        <div class="bg-blue-50 rounded-lg p-6">
                            <h4 class="font-bold mb-4 text-xl" style="color: var(--augusta-green);">üìñ What We've Already Learned</h4>
                            
                            <div class="bg-white rounded-lg p-4 mb-3">
                                <h5 class="font-bold mb-2 text-green-700">‚úÖ Level 1-2: Ball Flight Fundamentals</h5>
                                <p class="text-sm"><strong>Core Rule:</strong> Face-to-path difference creates curve. Face controls start direction.</p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 mb-3">
                                <h5 class="font-bold mb-2 text-purple-700">‚úÖ Level 3-4: Horizontal Gear Effect</h5>
                                <p class="text-sm"><strong>Impact Location:</strong> Toe hits add draw spin, heel hits add fade spin. Can help or hurt your shot.</p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 mb-3">
                                <h5 class="font-bold mb-2 text-indigo-700">‚úÖ Level 5-6: Vertical Gear Effect</h5>
                                <p class="text-sm"><strong>Vertical Position:</strong> High on face amplifies curve (more sidespin), low dampens curve (less sidespin).</p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-4 mb-3">
                                <h5 class="font-bold mb-2 text-red-700">‚úÖ Level 7: Lie Angle Effects</h5>
                                <div class="space-y-1 text-sm">
                                    <p><strong>Upright Lie (positive):</strong> CLOSES the face (ball goes left). Club-specific effect - driver ~0.3¬∞, wedge ~0.7¬∞ per degree of lie.</p>
                                    <p><strong>Flat Lie (negative):</strong> OPENS the face (ball goes right).</p>
                                    <p><strong>Critical Step:</strong> Calculate effective face FIRST (original + lie adjustment), then proceed with normal analysis.</p>
                                </div>
                            </div>
                        </div>
                    `
                }
            };
            
            return tutorials[level] || {
                title: `Level ${level} Tutorial`,
                content: `<p>Tutorial content for this level is coming soon!</p>`
            };
        }

        function showTutorial(level) {
            state.showTutorial = true;
            state.tutorialLevel = level;
            state.tutorialStep = 0; // üåàüé∏ RAINBOW GUITAR: Start at first step
            state.tutorialSliderValues = {}; // üåàüé∏ RAINBOW GUITAR: Reset sliders
            
            // Mark this level's tutorial as shown
            if (!state.tutorialsShown.includes(level)) {
                state.tutorialsShown.push(level);
            }
            
            render();
            
            // üåàüé∏ RAINBOW GUITAR FIX: Initialize slider values after render
            setTimeout(() => {
                const tutorialContent = getTutorialContent(level);
                if (tutorialContent.steps && tutorialContent.steps[0]) {
                    const firstStep = tutorialContent.steps[0];
                    if (firstStep.sliders) {
                        firstStep.sliders.forEach(slider => {
                            state.tutorialSliderValues[slider.id] = slider.default;
                            updateTutorialSlider(slider.id, slider.default, slider.unit);
                        });
                    }
                }
            }, 100);
        }

        function closeTutorial() {
            state.showTutorial = false;
            state.tutorialStep = 0; // üåàüé∏ RAINBOW GUITAR: Reset step
            render();
        }
        
        // üåàüé∏ RAINBOW GUITAR: Tutorial navigation
        function nextTutorialStep() {
            state.tutorialStep++;
            render();
            
            // Initialize sliders for new step
            setTimeout(() => {
                const tutorialContent = getTutorialContent(state.tutorialLevel);
                if (tutorialContent.steps) {
                    const currentStep = tutorialContent.steps[state.tutorialStep];
                    if (currentStep && currentStep.sliders) {
                        currentStep.sliders.forEach(slider => {
                            const value = state.tutorialSliderValues[slider.id] !== undefined ? 
                                state.tutorialSliderValues[slider.id] : slider.default;
                            state.tutorialSliderValues[slider.id] = value;
                            updateTutorialSlider(slider.id, value, slider.unit);
                        });
                    }
                }
            }, 100);
        }
        
        function previousTutorialStep() {
            if (state.tutorialStep > 0) {
                state.tutorialStep--;
                render();
                
                // Initialize sliders for new step
                setTimeout(() => {
                    const tutorialContent = getTutorialContent(state.tutorialLevel);
                    if (tutorialContent.steps) {
                        const currentStep = tutorialContent.steps[state.tutorialStep];
                        if (currentStep && currentStep.sliders) {
                            currentStep.sliders.forEach(slider => {
                                const value = state.tutorialSliderValues[slider.id] !== undefined ? 
                                    state.tutorialSliderValues[slider.id] : slider.default;
                                state.tutorialSliderValues[slider.id] = value;
                                updateTutorialSlider(slider.id, value, slider.unit);
                            });
                        }
                    }
                }, 100);
            }
        }
        
        // üåàüé∏ RAINBOW GUITAR: Interactive slider updates
        function updateTutorialSlider(sliderId, value, unit) {
            // Update display
            const display = document.getElementById(`slider-${sliderId}-display`);
            if (display) {
                display.textContent = value + unit;
            }
            
            // Store value
            state.tutorialSliderValues[sliderId] = parseFloat(value);
            
            const face = state.tutorialSliderValues.face || 0;
            const path = state.tutorialSliderValues.path || 0;
            
            // STEP 1: Update face arrow rotation AND text
            if (sliderId === 'face') {
                const faceArrow = document.getElementById('face-arrow');
                if (faceArrow) {
                    faceArrow.style.transformOrigin = '200px 250px';
                    faceArrow.style.transform = `rotate(${face}deg)`;
                }
                
                // Update face value text in Step 1
                const faceValueText = document.getElementById('face-value');
                if (faceValueText) {
                    faceValueText.textContent = (face >= 0 ? '+' : '') + face + '¬∞';
                }
            }
            
            // STEP 2: Update path arrow rotation AND text
            if (sliderId === 'path') {
                const pathArrow = document.getElementById('path-arrow');
                if (pathArrow) {
                    pathArrow.style.transformOrigin = '200px 250px';
                    pathArrow.style.transform = `rotate(${path}deg)`;
                }
                
                // Update path value text in Step 2
                const pathValueText = document.getElementById('path-value');
                if (pathValueText) {
                    pathValueText.textContent = (path >= 0 ? '+' : '') + path + '¬∞';
                }
            }
            
            // STEP 3: Update both arrows AND ball curve (NEW coordinate system 500x400)
            if (sliderId === 'face' || sliderId === 'path') {
                // Update face arrow with SVG transform attribute (not CSS)
                const faceArrow3 = document.getElementById('face-arrow-step3');
                if (faceArrow3) {
                    faceArrow3.setAttribute('transform', `rotate(${face}, 250, 350)`);
                }
                
                // Update SVG face text in Step 3
                const faceDisplay = document.getElementById('face-display-svg');
                if (faceDisplay) {
                    faceDisplay.textContent = (face >= 0 ? '+' : '') + face + '¬∞';
                }
                
                // Update path arrow with SVG transform attribute (not CSS)
                const pathArrow3 = document.getElementById('path-arrow-step3');
                if (pathArrow3) {
                    pathArrow3.setAttribute('transform', `rotate(${path}, 250, 350)`);
                }
                
                // Update SVG path text in Step 3
                const pathDisplay = document.getElementById('path-display-svg');
                if (pathDisplay) {
                    pathDisplay.textContent = (path >= 0 ? '+' : '') + path + '¬∞';
                }
                
                // Calculate face-to-path and update ball curve
                const faceToPath = face - path;
                const ballCurve = document.getElementById('ball-curve');
                if (ballCurve) {
                    // More dramatic curve: 1¬∞ face-to-path = 20 pixels of curve
                    const curveAmount = faceToPath * 20;
                    const startX = 250;
                    const startY = 350;
                    const endY = 50;
                    const endX = startX + curveAmount;
                    
                    // Control point for smooth curve
                    const controlX = startX + (curveAmount * 0.6);
                    const controlY = (startY + endY) / 2;
                    
                    const pathD = `M ${startX} ${startY} Q ${controlX} ${controlY}, ${endX} ${endY}`;
                    ballCurve.setAttribute('d', pathD);
                    
                    // Update landing ball
                    const landingBall = document.getElementById('landing-ball');
                    if (landingBall) {
                        landingBall.setAttribute('cx', endX);
                    }
                    
                    // Update curve indicator
                    const curveIndicator = document.getElementById('curve-indicator');
                    if (curveIndicator) {
                        // Show/hide based on curve amount
                        if (Math.abs(faceToPath) < 0.5) {
                            curveIndicator.style.opacity = '0';
                        } else {
                            curveIndicator.style.opacity = '0.5';
                            // Position it along the curve
                            const indicatorX = startX + (curveAmount * 0.4);
                            const direction = faceToPath > 0 ? 'right' : 'left';
                            const arrowPath = faceToPath > 0 ? 
                                `M ${startX + 10} 180 Q ${indicatorX - 10} 180, ${indicatorX} 170` :
                                `M ${startX - 10} 180 Q ${indicatorX + 10} 180, ${indicatorX} 170`;
                            
                            const arrowElement = curveIndicator.querySelector('path');
                            if (arrowElement) {
                                arrowElement.setAttribute('d', arrowPath);
                            }
                            
                            const textElement = curveIndicator.querySelector('text');
                            if (textElement) {
                                textElement.setAttribute('x', indicatorX + 10);
                            }
                        }
                    }
                }
                
                // Update result text with color
                const resultElement = document.getElementById('curve-result');
                if (resultElement) {
                    let result = '';
                    let color = '';
                    
                    if (Math.abs(faceToPath) < 0.5) {
                        // No curve - but is it straight to target, push, or pull?
                        if (Math.abs(face) < 0.5 && Math.abs(path) < 0.5) {
                            // Both near zero - straight to target
                            result = 'STRAIGHT (at target)';
                            color = '#22c55e'; // green
                        } else if (face > 0.5) {
                            // Face right, path right, no curve = PUSH
                            result = `PUSH (straight ${Math.abs(face).toFixed(1)}¬∞ right)`;
                            color = '#f59e0b'; // orange
                        } else {
                            // Face left, path left, no curve = PULL
                            result = `PULL (straight ${Math.abs(face).toFixed(1)}¬∞ left)`;
                            color = '#8b5cf6'; // purple
                        }
                    } else if (faceToPath > 0) {
                        result = `FADE (${Math.abs(faceToPath).toFixed(1)}¬∞ right curve)`;
                        color = '#ef4444'; // red
                    } else {
                        result = `DRAW (${Math.abs(faceToPath).toFixed(1)}¬∞ left curve)`;
                        color = '#3b82f6'; // blue
                    }
                    
                    resultElement.textContent = result;
                    resultElement.setAttribute('fill', color);
                }
            }
            
            // STEP 4: Update club distance calculations AND move the ball flight paths
            if (sliderId === 'facetopath') {
                const faceToPathError = parseFloat(value);
                
                // Calculate offline distance for each club (pixels)
                // Use ratio: 1 degree = ~6 pixels per 100 yards of distance
                const driverPixels = (faceToPathError * 250 / 100) * 6;
                const ironPixels = (faceToPathError * 150 / 100) * 6;
                const wedgePixels = (faceToPathError * 120 / 100) * 6;
                
                // Calculate yards offline for display
                const driverOffline = Math.round(faceToPathError * 250 / 30);
                const ironOffline = Math.round(faceToPathError * 150 / 30);
                const wedgeOffline = Math.round(faceToPathError * 120 / 30);
                
                // Update DRIVER path and ball
                const driverPath = document.getElementById('driver-path');
                const driverBall = document.getElementById('driver-ball');
                const driverLine = document.getElementById('driver-line');
                if (driverPath && driverBall && driverLine) {
                    const pathD = `M 0 50 Q ${driverPixels * 0.5} 25, ${driverPixels} 0`;
                    driverPath.setAttribute('d', pathD);
                    driverBall.setAttribute('cx', driverPixels);
                    driverLine.setAttribute('x2', driverPixels);
                }
                
                // Update 7-IRON path and ball
                const ironPath = document.getElementById('iron-path');
                const ironBall = document.getElementById('iron-ball');
                const ironLine = document.getElementById('iron-line');
                if (ironPath && ironBall && ironLine) {
                    const pathD = `M 0 50 Q ${ironPixels * 0.5} 25, ${ironPixels} 0`;
                    ironPath.setAttribute('d', pathD);
                    ironBall.setAttribute('cx', ironPixels);
                    ironLine.setAttribute('x2', ironPixels);
                }
                
                // Update WEDGE path and ball
                const wedgePath = document.getElementById('wedge-path');
                const wedgeBall = document.getElementById('wedge-ball');
                const wedgeLine = document.getElementById('wedge-line');
                if (wedgePath && wedgeBall && wedgeLine) {
                    const pathD = `M 0 50 Q ${wedgePixels * 0.5} 25, ${wedgePixels} 0`;
                    wedgePath.setAttribute('d', pathD);
                    wedgeBall.setAttribute('cx', wedgePixels);
                    wedgeLine.setAttribute('x2', wedgePixels);
                }
                
                // Update text values
                const driverText = document.getElementById('driver-yards');
                if (driverText) {
                    driverText.textContent = `${driverOffline} yards offline`;
                    driverText.setAttribute('x', driverPixels / 2);
                }
                
                const ironText = document.getElementById('iron-yards');
                if (ironText) {
                    ironText.textContent = `${ironOffline} yards offline`;
                    ironText.setAttribute('x', ironPixels / 2);
                }
                
                const wedgeText = document.getElementById('wedge-yards');
                if (wedgeText) {
                    wedgeText.textContent = `${wedgeOffline} yards offline`;
                    wedgeText.setAttribute('x', wedgePixels / 2);
                }
            }
        }

        // Track performance for adaptive level-up
        function trackLevelPerformance(level, correct, total) {
            if (!state.levelPerformance[level]) {
                state.levelPerformance[level] = {
                    scenarios: 0,
                    correct: 0,
                    total: 0,
                    recent: [] // Last 5 scenarios: cards correct out of total
                };
            }
            
            const perf = state.levelPerformance[level];
            perf.scenarios++;
            perf.correct += correct;
            perf.total += total;
            
            // Track recent performance (last 5 scenarios)
            perf.recent.push({ correct, total });
            if (perf.recent.length > 5) {
                perf.recent.shift(); // Keep only last 5
            }
        }

        // Check if player should be promoted to next level
        function checkLevelPromotion(currentLevel) {
            if (currentLevel >= 10) return false; // Already at max level
            
            const perf = state.levelPerformance[currentLevel];
            if (!perf || perf.scenarios < 15) return false; // Need at least 15 scenarios
            
            // Calculate overall accuracy
            const overallAccuracy = perf.correct / perf.total;
            if (overallAccuracy < 0.80) return false; // Need 80%+ overall
            
            // Calculate recent accuracy (last 5 scenarios)
            if (perf.recent.length < 5) return false; // Need 5 recent scenarios
            
            let recentCorrect = 0;
            let recentTotal = 0;
            let hasTerribleRun = false;
            
            for (const scenario of perf.recent) {
                recentCorrect += scenario.correct;
                recentTotal += scenario.total;
                
                // Check for terrible performance (below 50%)
                if (scenario.correct / scenario.total < 0.5) {
                    hasTerribleRun = true;
                }
            }
            
            const recentAccuracy = recentCorrect / recentTotal;
            if (recentAccuracy < 0.75) return false; // Need 75%+ recent average
            if (hasTerribleRun) return false; // No terrible runs in last 5
            
            return true; // Ready to promote!
        }

        function showLevelUpPromotion(targetLevel) {
            state.showLevelUpPromotion = true;
            state.promotionTargetLevel = targetLevel;
            render();
        }

        function acceptPromotion() {
            state.difficulty = state.promotionTargetLevel;
            state.showLevelUpPromotion = false;
            state.scenarioNumber = 1;
            state.currentCard = 1;
            state.currentScenarioData = generateScenario(state.difficulty);
            
            // Auto-show tutorial if applicable
            const tutorialLevels = [1, 2, 3, 4, 5, 6];
            if (tutorialLevels.includes(state.difficulty) && !state.tutorialsShown.includes(state.difficulty)) {
                state.showTutorial = true;
                state.tutorialLevel = state.difficulty;
                state.tutorialsShown.push(state.difficulty);
            }
            
            render();
        }

        function declinePromotion() {
            state.showLevelUpPromotion = false;
            render();
        }

        function closeSecretUnlock() {
            state.showSecretUnlock = false;
            render();
        }
        
        // üëëü¶© FLAMINGO CROWN: Close Level 6 complete modal
        function closeLevel6CompleteModal() {
            state.showLevel6CompleteModal = false;
            render();
        }
        
        // üíéüîî DIAMOND WHISTLE: Share secret unlock achievement
        function shareSecretUnlock(platform) {
            const perfectCount = state.totalPerfectScenarios;
            const bestStreak = state.user.bestStreak || 0;
            const gameUrl = window.location.href;
            
            const message = `üîì SECRET LEVEL UNLOCKED! I just dominated Level 5 and earned access to the ultimate golf physics challenge! üíé

Perfect scenarios: ${perfectCount} | Best streak: ${bestStreak}
Can you unlock it too? Most players never make it this far! üéØ‚õ≥`;

            if (platform === 'native' && navigator.share) {
                navigator.share({
                    title: 'Ball Flight Master - Secret Level Unlocked!',
                    text: message,
                    url: gameUrl
                }).catch(() => {
                    // Fallback if share fails
                    copyToClipboard(message + '\n\n' + gameUrl);
                });
            } else if (platform === 'twitter') {
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(gameUrl)}`;
                window.open(twitterUrl, '_blank', 'width=550,height=420');
            } else if (platform === 'facebook') {
                const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(gameUrl)}&quote=${encodeURIComponent(message)}`;
                window.open(facebookUrl, '_blank', 'width=550,height=420');
            } else if (platform === 'copy') {
                copyToClipboard(message + '\n\n' + gameUrl);
            }
        }
        
        // üëëü¶© FLAMINGO CROWN: Share Level 6 completion
        function shareLevel6Complete(platform) {
            const perfectCount = state.totalPerfectScenarios;
            const bestStreak = state.user.bestStreak || 0;
            const gameUrl = window.location.href;
            
            const message = `üèÜ GRAND SLAM WINNER! I just beat Level 6 and mastered professional-level golf ball flight physics!

My stats:
‚úì ${perfectCount} perfect scenarios
‚úì ${bestStreak}-streak momentum

I'm the Tiger Woods of ball flight! ‚õ≥üéØ
Think you can beat ${perfectCount} perfects and a ${bestStreak}-streak? Prove it! üí™`;

            if (platform === 'native' && navigator.share) {
                navigator.share({
                    title: 'Ball Flight Master - Grand Slam Winner!',
                    text: message,
                    url: gameUrl
                }).catch(() => {
                    copyToClipboard(message + '\n\n' + gameUrl);
                });
            } else if (platform === 'twitter') {
                const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(message)}&url=${encodeURIComponent(gameUrl)}`;
                window.open(twitterUrl, '_blank', 'width=550,height=420');
            } else if (platform === 'facebook') {
                const facebookUrl = `https://www.facebook.com/sharer/sharer.php?u=${encodeURIComponent(gameUrl)}&quote=${encodeURIComponent(message)}`;
                window.open(facebookUrl, '_blank', 'width=550,height=420');
            } else if (platform === 'copy') {
                copyToClipboard(message + '\n\n' + gameUrl);
            }
        }
        
        // Helper: Copy to clipboard with user feedback
        function copyToClipboard(text) {
            navigator.clipboard.writeText(text).then(() => {
                alert('‚úì Copied to clipboard! Now paste it on Instagram or anywhere you like! üìã');
            }).catch(() => {
                // Fallback for older browsers
                const textarea = document.createElement('textarea');
                textarea.value = text;
                document.body.appendChild(textarea);
                textarea.select();
                document.execCommand('copy');
                document.body.removeChild(textarea);
                alert('‚úì Copied to clipboard! Now paste it on Instagram or anywhere you like! üìã');
            });
        }

        function closeOnboarding() {
            state.showOnboarding = false;
            render();
        }

        function acceptSecretLevel() {
            state.difficulty = 6;
            state.showSecretUnlock = false;
            state.scenarioNumber = 1;
            state.currentCard = 1;
            state.currentScenarioData = generateScenario(6);
            
            // Auto-show tutorial
            if (!state.tutorialsShown.includes(6)) {
                state.showTutorial = true;
                state.tutorialLevel = 6;
                state.tutorialsShown.push(6);
            }
            
            render();
        }

        function openShareModal() {
            state.showShareModal = true;
            render();
        }

        function closeShareModal() {
            state.showShareModal = false;
            render();
        }

        function generateShareCard(type = 'standard') {
            const canvas = document.createElement('canvas');
            canvas.width = 800;
            canvas.height = 600;
            const ctx = canvas.getContext('2d');
            
            // Background gradient (Augusta green)
            const gradient = ctx.createLinearGradient(0, 0, 0, 600);
            gradient.addColorStop(0, '#006747');
            gradient.addColorStop(1, '#004d35');
            ctx.fillStyle = gradient;
            ctx.fillRect(0, 0, 800, 600);
            
            // White content box
            ctx.fillStyle = 'white';
            ctx.roundRect(40, 40, 720, 520, 20);
            ctx.fill();
            
            // Title
            ctx.fillStyle = '#006747';
            ctx.font = 'bold 48px Arial';
            ctx.textAlign = 'center';
            ctx.fillText('‚õ≥ BALL FLIGHT MASTER ‚õ≥', 400, 120);
            
            const accuracy = state.user.questionsAnswered > 0 ? 
                Math.round((state.user.correctAnswers / state.user.questionsAnswered) * 100) : 0;
            
            if (type === 'secret_unlock') {
                // Secret Level Unlock Card
                ctx.fillStyle = '#9333ea';
                ctx.font = 'bold 36px Arial';
                ctx.fillText('üèÜ LEGENDARY ACHIEVEMENT! üèÜ', 400, 200);
                
                ctx.fillStyle = '#333';
                ctx.font = 'bold 32px Arial';
                ctx.fillText('Grand Slam Winner Unlocked!', 400, 260);
                
                ctx.font = '24px Arial';
                ctx.fillText(`4 Perfect Scenarios on Level 5`, 400, 320);
                ctx.fillText(`Total Tokens: ${state.user.tokens} ü™ô`, 400, 360);
                ctx.fillText(`Accuracy: ${accuracy}%`, 400, 400);
                
                ctx.font = 'italic 20px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText('"I unlocked the secret level!"', 400, 460);
                
            } else if (type === 'completion') {
                // Grand Slam Winner Completion Card
                ctx.fillStyle = '#9333ea';
                ctx.font = 'bold 40px Arial';
                ctx.fillText('üëë GRAND SLAM WINNER üëë', 400, 200);
                ctx.fillText('CONQUERED!', 400, 250);
                
                ctx.fillStyle = '#333';
                ctx.font = '24px Arial';
                ctx.fillText(`Final Accuracy: ${accuracy}%`, 400, 320);
                ctx.fillText(`Total Tokens: ${state.user.tokens} ü™ô`, 400, 360);
                ctx.fillText(`Perfect Scenarios: ${state.perfectScenariosLevel5}`, 400, 400);
                
                ctx.font = 'italic 20px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText('"I mastered the impossible!"', 400, 460);
                
            } else {
                // Standard Share Card
                const levelName = difficultyLevels[state.difficulty - 1].name;
                ctx.fillStyle = '#333';
                ctx.font = 'bold 32px Arial';
                ctx.fillText(`Level ${state.difficulty}: ${levelName}`, 400, 200);
                
                ctx.font = '24px Arial';
                ctx.fillText(`Accuracy: ${accuracy}%`, 400, 270);
                ctx.fillText(`Total Tokens: ${state.user.tokens} ü™ô`, 400, 320);
                ctx.fillText(`Best Streak: ${state.user.bestStreak} correct`, 400, 370);
                
                ctx.font = 'italic 20px Arial';
                ctx.fillStyle = '#666';
                ctx.fillText('"I\'ve mastered golf physics!"', 400, 440);
            }
            
            // Footer
            ctx.fillStyle = '#999';
            ctx.font = '18px Arial';
            ctx.fillText('Play: ballflightmaster.com', 400, 520);
            
            return canvas.toDataURL('image/png');
        }

        function shareToTwitter(type = 'standard') {
            const imageData = generateShareCard(type);
            
            // Create a download link
            const link = document.createElement('a');
            link.download = `ball-flight-master-${type}.png`;
            link.href = imageData;
            link.click();
            
            // Open Twitter with pre-filled text
            let tweetText = '';
            if (type === 'secret_unlock') {
                tweetText = 'üèÜ I just unlocked the SECRET LEVEL in Ball Flight Master! Grand Slam Winner awaits... Can you master golf physics? ‚õ≥';
            } else if (type === 'completion') {
                tweetText = 'üëë I conquered the Grand Slam Winner level in Ball Flight Master! The ultimate golf physics challenge. Think you can beat it? ‚õ≥';
            } else {
                const accuracy = state.user.questionsAnswered > 0 ? 
                    Math.round((state.user.correctAnswers / state.user.questionsAnswered) * 100) : 0;
                tweetText = `‚õ≥ I'm mastering golf physics in Ball Flight Master! Level ${state.difficulty}, ${accuracy}% accuracy, ${state.user.tokens} tokens earned. Can you do better?`;
            }
            
            const twitterUrl = `https://twitter.com/intent/tweet?text=${encodeURIComponent(tweetText)}&url=ballflightmaster.com`;
            window.open(twitterUrl, '_blank');
            
            closeShareModal();
        }


        function selectConfidence(multiplier) {
            state.confidenceMultiplier = multiplier;
            state.showConfidenceBoost = false;
            state.hasUsedBoost = true;
            state.boostCardResults = [];
            state.boostLost = false;
            if (state.boostTimer) {
                clearInterval(state.boostTimer);
                state.boostTimer = null;
            }
            render();
        }

        function render() {
            const app = document.getElementById('app');
            
            if (state.showAuth) {
                app.innerHTML = `
                    <div class="min-h-screen golf-bg p-6 flex items-center justify-center">
                        <div class="bg-white rounded-lg shadow-2xl max-w-md w-full relative">
                            <div class="p-6 rounded-t-lg text-center" style="background: linear-gradient(135deg, var(--augusta-green), var(--augusta-dark));">
                                <div class="text-6xl mb-3">üèåÔ∏è‚Äç‚ôÇÔ∏è‚õ≥</div>
                                <h1 class="text-4xl font-bold text-white mb-2">Ball Flight Master</h1>
                                <p class="text-sm" style="color: var(--masters-gold); font-weight: 600; letter-spacing: 1px;">EARN THE GREEN JACKET OF GOLF PHYSICS</p>
                            </div>
                            <div class="p-8">
                                <div class="text-center mb-6">
                                    <p class="text-gray-700 text-lg mb-2 font-semibold">Learn the Science Behind Every Shot</p>
                                    <p class="text-gray-500 text-sm">Learn ‚Ä¢ Practice ‚Ä¢ Compete</p>
                                </div>
                                <input type="text" id="username" value="${state.username}" 
                                    placeholder="Enter your username" 
                                    class="w-full p-3 border-2 border-gray-300 rounded-lg mb-4 text-lg focus:border-green-600 focus:outline-none">
                                <button onclick="handleLogin()" 
                                    class="w-full py-3 text-white rounded-lg font-semibold text-lg transition-all hover:opacity-90"
                                    style="background: var(--augusta-green);">
                                    ‚õ≥ Start Playing
                                </button>
                                <button onclick="openLeaderboard()" 
                                    class="w-full mt-3 py-3 text-white rounded-lg font-semibold transition-all hover:opacity-90"
                                    style="background: var(--masters-gold); color: #000;">
                                    üèÜ View Leaderboard
                                </button>
                            </div>
                            <div class="text-center text-xs text-gray-400 py-3 border-t">
                                ${APP_VERSION}
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('username').addEventListener('input', e => {
                    state.username = e.target.value;
                });
                return;
            }

            if (state.showLevelSelect) {
                app.innerHTML = `
                    <div class="min-h-screen golf-bg p-4">
                        <!-- Top navigation bar across entire screen -->
                        <div class="max-w-6xl mx-auto mb-4">
                            <div class="bg-white rounded-lg shadow-lg px-6 py-3">
                                ${state.difficulty ? `
                                    <button onclick="startGame()" 
                                        class="w-full px-6 py-3 text-white rounded-lg font-semibold text-lg hover:shadow-lg transition-all hover:opacity-90"
                                        style="background: var(--augusta-green);">
                                        ‚õ≥ Start Level ${state.difficulty}: ${difficultyLevels[state.difficulty - 1].name}
                                    </button>
                                ` : ''}
                            </div>
                        </div>
                        
                        <div class="max-w-6xl mx-auto">
                            <div class="bg-white rounded-2xl shadow-2xl p-8 mb-4 relative">
                                <div class="text-center mb-2">
                                    <div class="text-5xl mb-3">‚õ≥</div>
                                    <h1 class="text-4xl font-bold mb-2" style="color: var(--augusta-green);">
                                        Welcome, ${state.username}!
                                    </h1>
                                    <p class="text-gray-600 mb-6">Choose Your Path to the Green Jacket</p>
                                </div>
                                
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    ${difficultyLevels.filter(level => !level.isSecret || state.secretLevelUnlocked).map(level => {
                                        const isSecret = level.isSecret;
                                        const secretClass = isSecret ? 'border-purple-600 bg-gradient-to-br from-purple-50 to-red-50' : 'border-gray-300';
                                        const secretIcon = isSecret ? 'üèÜ' : 'üèåÔ∏è';
                                        return `
                                        <div class="border-2 rounded-xl p-6 cursor-pointer hover:shadow-lg transition-all ${state.difficulty === level.level ? 'border-green-600 bg-green-50' : secretClass}"
                                            style="${state.difficulty === level.level ? 'border-color: var(--augusta-green);' : isSecret ? 'border-color: #9333ea; box-shadow: 0 0 20px rgba(147, 51, 234, 0.3);' : ''}"
                                            onclick="selectLevel(${level.level})">
                                            <div class="flex items-start justify-between mb-3">
                                                <div>
                                                    <h3 class="text-xl font-bold ${isSecret ? 'text-purple-900' : 'text-gray-900'}">${secretIcon} Level ${level.level}: ${level.name}</h3>
                                                    <p class="text-sm ${isSecret ? 'text-purple-700' : 'text-gray-600'} mt-1">${level.description}</p>
                                                </div>
                                                <span class="px-3 py-1 rounded-full text-sm font-semibold" style="background: ${isSecret ? '#9333ea' : 'var(--masters-gold)'}; color: ${isSecret ? '#fff' : '#000'};">
                                                    +${level.baseReward}
                                                </span>
                                            </div>
                                            
                                            <div class="bg-gray-50 rounded-lg p-4 mb-3">
                                                <p class="text-sm text-gray-700">${level.details}</p>
                                            </div>
                                            
                                            <div class="flex gap-4 text-sm">
                                                <div class="flex items-center gap-2">
                                                    <span class="text-gray-600">Cards:</span>
                                                    <span class="font-semibold">${level.cards}</span>
                                                </div>
                                                <div class="flex items-center gap-2">
                                                    <span class="text-gray-600">Reward:</span>
                                                    <span class="font-semibold" style="color: var(--augusta-green);">+${level.baseReward}</span>
                                                </div>
                                            </div>
                                        </div>
                                        `;
                                    }).join('')}
                                    
                                    ${!state.secretLevelUnlocked ? `
                                        <div class="border-4 border-dashed border-purple-400 rounded-xl p-6 bg-gradient-to-br from-purple-900/10 to-black/20 relative overflow-hidden">
                                            <div class="absolute inset-0 bg-gradient-to-r from-purple-500/10 to-pink-500/10 animate-pulse"></div>
                                            <div class="relative text-center py-8">
                                                <div class="text-6xl mb-4 animate-bounce">üîí</div>
                                                <h3 class="text-2xl font-bold text-purple-900 mb-2">SECRET BOSS LEVEL</h3>
                                                <p class="text-lg text-purple-700 mb-3">üèÜ Grand Slam Winner üèÜ</p>
                                                <p class="text-sm text-gray-600 italic">Will you discover how to unlock it?</p>
                                                <div class="mt-4 text-xs text-gray-500">
                                                    <p>Hint: Master Level 5...</p>
                                                </div>
                                            </div>
                                        </div>
                                    ` : ''}
                                </div>
                                
                                ${state.difficulty ? `
                                    <div class="mt-6">
                                        <button onclick="startGame()" 
                                            class="w-full px-6 py-3 text-white rounded-lg font-semibold text-lg hover:shadow-lg transition-all hover:opacity-90"
                                            style="background: var(--augusta-green);">
                                            ‚õ≥ Start Level ${state.difficulty}: ${difficultyLevels[state.difficulty - 1].name}
                                        </button>
                                    </div>
                                ` : ''}
                                <div class="text-center text-xs text-gray-400 mt-4 pt-4 border-t">
                                    ${APP_VERSION}
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }

            if (!state.currentScenarioData) return;

            const totalCards = difficultyLevels[state.difficulty - 1].cards;
            const card = state.currentScenarioData.cards[state.currentCard - 1];
            
            // Safety check for undefined card
            if (!card) {
                console.error('CRITICAL: Card is undefined!', {
                    currentCard: state.currentCard,
                    totalCards: totalCards,
                    availableCards: state.currentScenarioData.cards.length
                });
                // Regenerate scenario and reset
                state.currentCard = 1;
                state.currentScenarioData = generateScenario(state.difficulty);
                render();
                return;
            }
            
            const accuracy = state.user.questionsAnswered > 0 ? Math.round((state.user.correctAnswers / state.user.questionsAnswered) * 100) : 0;

            let dataHTML = '';
            const tooltips = getDataTooltips(state.difficulty);
            for (let [key, item] of Object.entries(state.currentScenarioData.data)) {
                const tooltipText = tooltips[item.label] || "Hover for more information";
                
                // Special handling for face card when effective face has been shown
                let displayValue = item.value;
                if (item.label === "Club Face" && state.effectiveFaceShown && state.currentScenarioData.lieAngleAdjustment && state.currentScenarioData.lieAngleAdjustment !== 0) {
                    const orig = state.currentScenarioData.originalFace;
                    const eff = state.currentScenarioData.effectiveFace;
                    const origDir = orig > 0 ? " (right)" : orig < 0 ? " (left)" : "";
                    const effDir = eff > 0 ? " (right)" : eff < 0 ? " (left)" : "";
                    displayValue = `${orig.toFixed(1)}¬∞${origDir}<br><span style="color: var(--augusta-green); font-weight: bold; font-size: 0.9em;">‚ûú ${eff.toFixed(1)}¬∞${effDir} (effective)</span>`;
                }
                
                dataHTML += `
                    <div class="data-card">
                        <div class="bg-gradient-to-br from-blue-50 to-indigo-50 border-2 border-blue-200 rounded-xl p-5 shadow-md hover:shadow-lg transition-all">
                            <div class="flex items-center gap-3 mb-2">
                                <span class="text-3xl">${item.icon}</span>
                                <span class="font-bold text-gray-700 text-sm">${item.label}</span>
                            </div>
                            <div class="text-xl font-bold text-gray-900 mt-2">${displayValue}</div>
                        </div>
                        <div class="tooltip">${tooltipText}</div>
                    </div>
                `;
            }

            let optionsHTML = '';
            card.options.forEach((opt, idx) => {
                // Get description for shot shapes (if it exists in shotShapeDescriptions)
                const description = shotShapeDescriptions[opt] || '';
                let btnClass = "w-full text-left p-5 rounded-xl border-2 transition-all font-semibold shadow-md hover:shadow-lg";
                if (!state.showExplanation) {
                    btnClass += state.selectedAnswer === opt ? " border-purple-600 bg-purple-600 text-white" : " border-gray-300 bg-white hover:border-purple-400 hover:bg-purple-50";
                } else {
                    // Check correctness - now options are plain names
                    const isCorrect = opt === card.correct;
                    if (isCorrect) btnClass += " border-green-600 bg-green-500 text-white";
                    else if (opt === state.selectedAnswer) btnClass += " border-red-600 bg-red-500 text-white";
                    else btnClass += " border-gray-300 bg-gray-200 text-gray-500";
                }
                
                optionsHTML += `
                    <button onclick="handleAnswer('${opt.replace(/'/g, "\\'")}')" 
                        ${state.showExplanation ? 'disabled' : ''}
                        class="${btnClass}">
                        <div class="text-lg font-bold mb-1">${opt}</div>
                        ${description ? `<div class="shot-description">${description}</div>` : ''}
                    </button>
                `;
            });

            app.innerHTML = `
                <div class="min-h-screen golf-bg p-6">
                    <div class="max-w-5xl mx-auto relative">
                        <div class="absolute -top-2 right-2 text-xs text-white/80 bg-black/40 px-3 py-1.5 rounded-lg backdrop-blur-sm shadow-lg" style="z-index: 100;">
                            ${APP_VERSION}
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6">
                            <div class="text-white shadow-lg rounded-lg p-4 text-center relative group" style="background: linear-gradient(135deg, var(--masters-gold), #B8860B);">
                                <p class="text-sm opacity-90">Tokens üí°</p>
                                <p class="text-2xl font-bold text-black">${state.user.tokens}</p>
                                <div class="absolute bottom-full left-1/2 transform -translate-x-1/2 mb-2 px-3 py-2 bg-gray-900 text-white text-xs rounded-lg opacity-0 group-hover:opacity-100 transition-opacity pointer-events-none whitespace-nowrap z-50">
                                    Earn by answering correctly. Lose for wrong answers. Climb the leaderboard!
                                </div>
                            </div>
                            <div class="bg-gradient-to-br from-purple-500 to-pink-500 text-white shadow-lg rounded-lg p-4 text-center">
                                <p class="text-sm opacity-90">Accuracy</p>
                                <p class="text-2xl font-bold">${accuracy}%</p>
                            </div>
                            <div class="bg-gradient-to-br from-green-500 to-teal-500 text-white shadow-lg rounded-lg p-4 text-center">
                                <p class="text-sm opacity-90">Correct</p>
                                <p class="text-2xl font-bold">${state.user.correctAnswers}</p>
                            </div>
                            <div class="bg-gradient-to-br from-blue-500 to-indigo-500 text-white shadow-lg rounded-lg p-4 text-center">
                                <p class="text-sm opacity-90">Streak</p>
                                <p class="text-2xl font-bold">${state.user.currentStreak} üî•</p>
                            </div>
                        </div>

                        ${state.difficulty === 5 && !state.secretLevelUnlocked ? `
                            <div class="mb-6 p-5 rounded-xl shadow-lg bg-gradient-to-r from-purple-600 to-pink-600 text-white">
                                <div class="text-center">
                                    <div class="text-2xl font-bold mb-2">
                                        üèÜ SECRET LEVEL PROGRESS
                                    </div>
                                    <p class="text-sm mb-3 opacity-90">Complete 4 perfect scenarios to unlock Grand Slam Winner!</p>
                                    <div class="flex justify-center items-center gap-2 mb-2">
                                        ${Array.from({length: 4}, (_, i) => {
                                            return i < state.perfectScenariosLevel5 ? '<span class="text-4xl">‚úì</span>' : '<span class="text-4xl text-white/30">‚óã</span>';
                                        }).join('')}
                                    </div>
                                    <p class="text-lg font-bold">${state.perfectScenariosLevel5}/4 Perfect Scenarios</p>
                                </div>
                            </div>
                        ` : ''}

                        ${state.hasUsedBoost ? `
                            <div class="mb-6 p-4 rounded-xl shadow-lg ${state.boostLost ? 'bg-gray-300 opacity-75' : 'bg-gradient-to-r from-yellow-400 to-orange-500'}">
                                <div class="text-center">
                                    <div class="text-2xl font-bold ${state.boostLost ? 'text-gray-700' : 'text-white'} mb-2">
                                        ${state.boostLost ? '‚ùå' : 'üéØ'} ${state.boostLost ? '<span class="line-through">' + state.confidenceMultiplier + 'x</span>' : state.confidenceMultiplier + 'x'} BOOST ${state.boostLost ? 'LOST' : 'ACTIVE'}
                                    </div>
                                    <div class="flex justify-center items-center gap-2 mb-2">
                                        <span class="${state.boostLost ? 'text-gray-700' : 'text-white'} font-semibold">Progress:</span>
                                        ${Array.from({length: difficultyLevels[state.difficulty - 1].cards}, (_, i) => {
                                            if (i < state.boostCardResults.length) {
                                                return state.boostCardResults[i] ? '<span class="text-2xl">‚úì</span>' : '<span class="text-2xl text-red-600">‚úó</span>';
                                            } else {
                                                return '<span class="text-2xl text-white">‚óã</span>';
                                            }
                                        }).join('')}
                                        <span class="${state.boostLost ? 'text-gray-700' : 'text-white'} text-sm">(${state.boostCardResults.length}/${difficultyLevels[state.difficulty - 1].cards} cards)</span>
                                    </div>
                                    ${state.boostLost ? `
                                        <div class="text-sm text-gray-700 font-semibold">Failed Card ${state.boostCardResults.findIndex(r => !r) + 1}</div>
                                    ` : state.boostCardResults.length > 0 && state.boostCardResults.length < difficultyLevels[state.difficulty - 1].cards ? `
                                        <div class="text-sm text-white font-semibold">Still eligible! ${difficultyLevels[state.difficulty - 1].cards - state.boostCardResults.length} card(s) remaining</div>
                                    ` : ''}
                                </div>
                            </div>
                        ` : ''}

                        <div class="bg-white rounded-lg shadow-lg p-4 mb-6">
                            <div class="flex justify-between items-center">
                                <div>
                                    <h3 class="font-bold text-lg">Level ${state.difficulty} - ${difficultyLevels[state.difficulty - 1].name}</h3>
                                    <p class="text-sm text-gray-600">${difficultyLevels[state.difficulty - 1].description}</p>
                                </div>
                                ${[1, 2, 3, 4, 5, 6].includes(state.difficulty) ? `
                                    <button onclick="showTutorial(${state.difficulty})" class="px-4 py-2 text-white rounded-lg mr-2" style="background: var(--masters-gold); color: var(--augusta-dark); font-weight: 600;">
                                        üìö Tutorial
                                    </button>
                                ` : ''}
                                <button onclick="toggleDifficulty()" class="px-4 py-2 bg-blue-600 text-white rounded-lg mr-2">
                                    Change Level
                                </button>
                                <button onclick="openShareModal()" class="px-4 py-2 bg-blue-400 text-white rounded-lg mr-2 hover:bg-blue-500">
                                    üê¶ Share
                                </button>
                                <button onclick="openLeaderboard()" class="px-4 py-2 bg-yellow-500 text-white rounded-lg hover:bg-yellow-600">
                                    üèÜ
                                </button>
                            </div>
                            ${state.showDifficultySelector ? `
                                <div class="mt-4">
                                    <input type="range" min="1" max="10" value="${state.difficulty}" 
                                        oninput="changeDifficulty(this.value)" class="w-full">
                                    <div class="flex justify-between text-xs text-gray-600 mt-2">
                                        ${difficultyLevels.map(d => '<span class="' + (d.level === state.difficulty ? 'font-bold text-blue-600' : '') + '">' + d.level + '</span>').join('')}
                                    </div>
                                </div>
                            ` : ''}
                        </div>

                        <div class="bg-white rounded-lg shadow-2xl">
                            <div class="text-white p-6 rounded-t-lg" style="background: linear-gradient(135deg, var(--augusta-green), var(--augusta-dark));">
                                <div class="flex items-center justify-between">
                                    <div>
                                        <h2 class="text-2xl font-bold">Level ${state.difficulty} ‚Ä¢ Scenario #${state.scenarioNumber} ‚Ä¢ Card ${state.currentCard} of ${totalCards}</h2>
                                        <p class="text-green-100">Base Reward: ${difficultyLevels[state.difficulty - 1].baseReward} tokens</p>
                                    </div>
                                </div>
                            </div>
                            
                            ${state.difficulty < 6 ? `
                                <div class="mx-6 mb-4 p-4 rounded-xl shadow-lg bg-gradient-to-r from-purple-100 to-pink-100 border-2 border-purple-300">
                                    <div class="flex justify-between items-center mb-2">
                                        <span class="font-bold text-gray-800">Progress to Level ${state.difficulty + 1}</span>
                                        <span class="text-sm font-semibold text-gray-700">${state.levelProgress.progressPercent}%</span>
                                    </div>
                                    
                                    <div class="w-full bg-gray-300 rounded-full h-6 overflow-hidden mb-3">
                                        <div class="bg-gradient-to-r from-green-400 to-green-600 h-full transition-all duration-500" 
                                             style="width: ${state.levelProgress.progressPercent}%">
                                        </div>
                                    </div>
                                    
                                    <div class="flex items-center justify-between">
                                        <div class="flex items-center gap-2">
                                            <span class="font-bold text-sm">Momentum:</span>
                                            <span class="text-2xl${state.levelProgress.momentum === 5 ? ' momentum-celebrate' : ''}" id="momentum-display">${'üî•'.repeat(state.levelProgress.momentum)}</span>
                                            <span class="text-xs text-gray-600">(${state.levelProgress.currentStreak}-streak)</span>
                                            ${state.levelProgress.momentum === 5 ? `
                                                <span class="text-2xl momentum-sparkle">‚ú®</span>
                                                <span class="text-xs font-bold text-yellow-600 bg-yellow-100 px-2 py-1 rounded">MAX!</span>
                                            ` : ''}
                                        </div>
                                        <span class="text-xs text-gray-600">
                                            ${state.levelProgress.questionsCorrect}/${state.levelProgress.questionsAnswered} correct
                                        </span>
                                    </div>
                                </div>
                            ` : ''}
                            
                            <div class="p-6">
                                <div class="mb-6">
                                    <div class="grid grid-cols-2 md:grid-cols-3 gap-4">
                                        ${dataHTML}
                                    </div>
                                </div>

                                ${state.showConfidenceBoost && !state.selectedAnswer && state.boostTiming === 'before' ? `
                                    <div class="mb-6 p-6 bg-gradient-to-r from-yellow-400 to-orange-500 border-4 border-yellow-600 rounded-xl shadow-2xl">
                                        <h3 class="text-3xl font-bold text-white mb-3 text-center">üéØ CONFIDENCE BOOSTER! üéØ</h3>
                                        <p class="text-white text-lg mb-4 text-center">We're showing you this BEFORE revealing the question! This is a true test of confidence.</p>
                                        <p class="text-white font-semibold mb-4 text-center">Choose your multiplier now, then answer the question:</p>
                                        
                                        <!-- Bomb Countdown -->
                                        <div class="mb-4 bg-white/30 rounded-lg p-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-white font-bold">Time remaining: ${state.boostCountdown}s</span>
                                                <span class="text-white font-bold">${state.boostCountdown <= 5 ? '‚ö†Ô∏è HURRY!' : ''}</span>
                                            </div>
                                            <div class="relative h-8 bg-white/20 rounded-full overflow-hidden">
                                                <div class="absolute top-0 left-0 h-full bg-red-500/50 transition-all duration-1000" style="width: ${(state.boostCountdown / 20) * 100}%"></div>
                                                <div class="absolute top-1/2 -translate-y-1/2 transition-all duration-1000" style="left: ${((20 - state.boostCountdown) / 20) * 100}%">
                                                    <span class="text-3xl">${state.boostCountdown <= 3 ? 'üí•' : 'üí£'}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-3 gap-4">
                                            <button onclick="selectConfidence(1)" class="bg-white text-gray-900 p-4 rounded-lg font-bold text-xl hover:bg-gray-100 transition-all">
                                                Decline<br><span class="text-sm">No boost</span>
                                            </button>
                                            <button onclick="selectConfidence(2)" class="bg-white text-orange-600 p-4 rounded-lg font-bold text-xl hover:bg-orange-50 transition-all">
                                                2x<br><span class="text-sm">Feeling good!</span>
                                            </button>
                                            <button onclick="selectConfidence(3)" class="bg-white text-red-600 p-4 rounded-lg font-bold text-xl hover:bg-red-50 transition-all">
                                                3x<br><span class="text-sm">All in!</span>
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}

                                ${state.showConfidenceBoost && !state.selectedAnswer && state.boostTiming === 'after' ? `
                                    <div class="mb-6 p-6 bg-gradient-to-r from-blue-400 to-purple-500 border-4 border-blue-600 rounded-xl shadow-2xl">
                                        <h3 class="text-3xl font-bold text-white mb-3 text-center">üéØ CONFIDENCE BOOSTER! üéØ</h3>
                                        <p class="text-white text-lg mb-4 text-center">You've seen the question and data. How confident are you?</p>
                                        <p class="text-white font-semibold mb-4 text-center">Choose your multiplier:</p>
                                        
                                        <!-- Bomb Countdown -->
                                        <div class="mb-4 bg-white/30 rounded-lg p-3">
                                            <div class="flex items-center justify-between mb-2">
                                                <span class="text-white font-bold">Time remaining: ${state.boostCountdown}s</span>
                                                <span class="text-white font-bold">${state.boostCountdown <= 5 ? '‚ö†Ô∏è HURRY!' : ''}</span>
                                            </div>
                                            <div class="relative h-8 bg-white/20 rounded-full overflow-hidden">
                                                <div class="absolute top-0 left-0 h-full bg-red-500/50 transition-all duration-1000" style="width: ${(state.boostCountdown / 20) * 100}%"></div>
                                                <div class="absolute top-1/2 -translate-y-1/2 transition-all duration-1000" style="left: ${((20 - state.boostCountdown) / 20) * 100}%">
                                                    <span class="text-3xl">${state.boostCountdown <= 3 ? 'üí•' : 'üí£'}</span>
                                                </div>
                                            </div>
                                        </div>
                                        
                                        <div class="grid grid-cols-3 gap-4">
                                            <button onclick="selectConfidence(1)" class="bg-white text-gray-900 p-4 rounded-lg font-bold text-xl hover:bg-gray-100 transition-all">
                                                Decline<br><span class="text-sm">No boost</span>
                                            </button>
                                            <button onclick="selectConfidence(2)" class="bg-white text-orange-600 p-4 rounded-lg font-bold text-xl hover:bg-orange-50 transition-all">
                                                2x<br><span class="text-sm">Pretty sure!</span>
                                            </button>
                                            <button onclick="selectConfidence(3)" class="bg-white text-red-600 p-4 rounded-lg font-bold text-xl hover:bg-red-50 transition-all">
                                                3x<br><span class="text-sm">Definitely!</span>
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}

                                <h3 class="font-bold text-2xl mb-4 text-purple-900">${card.question}</h3>

                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4 mb-6">
                                    ${optionsHTML}
                                </div>

                                ${state.showExplanation ? `
                                    <div class="p-4 rounded-lg mb-4 ${state.isCorrect ? 'bg-green-50 border-2 border-green-500' : 'bg-red-50 border-2 border-red-500'}">
                                        ${(() => {
                                            const totalCards = difficultyLevels[state.difficulty - 1].cards;
                                            const baseReward = difficultyLevels[state.difficulty - 1].baseReward;
                                            const isLastCard = state.currentCard >= totalCards;
                                            const allCorrect = state.boostCardResults.every(r => r === true) && state.boostCardResults.length === totalCards;
                                            
                                            if (state.isCorrect) {
                                                if (state.hasUsedBoost && isLastCard) {
                                                    if (allCorrect && !state.boostLost) {
                                                        const multipliedReward = baseReward * state.confidenceMultiplier;
                                                        return `<p class="font-bold text-lg">‚úì Correct! You got ALL ${totalCards} cards correct!</p><p class="text-lg mt-2">üéØ ${state.confidenceMultiplier}x multiplier applied: <span class="text-green-700">+${multipliedReward} tokens</span> (${baseReward} base √ó ${state.confidenceMultiplier})</p>`;
                                                    } else {
                                                        return `<p class="font-bold text-lg">‚úì Correct! +${baseReward} tokens</p><p class="text-sm mt-2 text-red-600">Lost ${state.confidenceMultiplier}x multiplier from earlier incorrect answer</p>`;
                                                    }
                                                } else if (state.hasUsedBoost && !isLastCard) {
                                                    const remaining = totalCards - state.currentCard;
                                                    if (state.boostLost) {
                                                        return `<p class="font-bold text-lg">‚úì Correct! +${baseReward} tokens</p><p class="text-sm mt-2 text-gray-600">Boost already lost from earlier incorrect answer</p>`;
                                                    } else {
                                                        return `<p class="font-bold text-lg">‚úì Correct! Still eligible for ${state.confidenceMultiplier}x boost!</p><p class="text-sm mt-2">${remaining} card(s) remaining - get them all correct to earn the bonus!</p>`;
                                                    }
                                                } else {
                                                    return `<p class="font-bold text-lg">‚úì Correct! +${baseReward} tokens</p>`;
                                                }
                                            } else {
                                                // Wrong answer - show penalty (25% L1 ‚Üí 100% L5)
                                                const penaltyPercent = 0.25 + (state.difficulty - 1) * (0.75 / 4);
                                                const penalty = Math.round(baseReward * penaltyPercent);
                                                
                                                if (state.hasUsedBoost && state.confidenceMultiplier > 1) {
                                                    return `<p class="font-bold text-lg">‚úó Wrong! <span class="text-red-700">-${penalty} tokens</span></p><p class="text-sm mt-2 text-red-600">Lost ${state.confidenceMultiplier}x multiplier AND penalty applied</p>`;
                                                } else {
                                                    return `<p class="font-bold text-lg">‚úó Wrong! <span class="text-red-700">-${penalty} tokens</span></p><p class="text-sm mt-2 text-gray-600">Level ${state.difficulty} penalty: ${Math.round(penaltyPercent * 100)}% of base reward</p>`;
                                                }
                                            }
                                        })()}
                                    </div>
                                    <div class="bg-blue-50 p-4 rounded-lg border-2 border-blue-300 mb-4">
                                        <h4 class="font-bold text-blue-900 mb-3">Explanation:</h4>
                                        <div class="text-gray-800">${card.explanation}</div>
                                    </div>
                                    
                                    <button onclick="handleNext()" 
                                        class="w-full py-3 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg font-semibold text-lg mb-4">
                                        ${state.currentCard < totalCards ? `Next Card (${state.currentCard + 1} of ${totalCards})` : 'Next Scenario'}
                                    </button>
                                    
                                    <div class="p-4 bg-purple-50 border-2 border-purple-300 rounded-lg">
                                        <h4 class="font-bold text-purple-900 mb-3 flex items-center gap-2">
                                            üí¨ Ask AI About This Scenario
                                        </h4>
                                        <div class="flex gap-2 mb-3">
                                            <input type="text" id="aiQuestion" value="This feature is coming soon!" 
                                                placeholder="This feature is coming soon!" 
                                                class="flex-1 p-3 border-2 border-purple-200 rounded-lg"
                                                disabled>
                                            <button disabled
                                                class="px-6 py-3 bg-gray-400 text-white rounded-lg font-semibold cursor-not-allowed">
                                                Coming Soon
                                            </button>
                                        </div>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                    </div>
                </div>
            `;
            
            // Share Modal
            if (state.showShareModal) {
                const canUnlockSecret = state.difficulty === 5 && !state.secretLevelUnlocked;
                const hasSecretLevel = state.secretLevelUnlocked || state.difficulty === 6;
                
                app.innerHTML += `
                    <div class="fixed inset-0 bg-black bg-opacity-75 flex items-center justify-center z-50 p-4" onclick="closeShareModal()">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-8" onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-3xl font-bold" style="color: var(--augusta-green);">
                                    üì∏ Share Your Progress
                                </h2>
                                <button onclick="closeShareModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">√ó</button>
                            </div>
                            
                            <p class="text-gray-600 mb-6">Generate a shareable image and tweet your golf physics mastery!</p>
                            
                            <div class="grid grid-cols-1 gap-4">
                                <button onclick="shareToTwitter('standard')" 
                                    class="p-6 border-2 border-blue-200 rounded-xl hover:border-blue-500 hover:bg-blue-50 transition-all text-left">
                                    <div class="flex items-center gap-4 mb-2">
                                        <span class="text-4xl">üìä</span>
                                        <div>
                                            <h3 class="text-xl font-bold text-gray-900">Standard Progress</h3>
                                            <p class="text-sm text-gray-600">Share your current stats and level</p>
                                        </div>
                                    </div>
                                    <div class="text-sm text-gray-500 mt-2">
                                        Includes: Level, Accuracy, Tokens, Best Streak
                                    </div>
                                </button>
                                
                                ${hasSecretLevel ? `
                                    <button onclick="shareToTwitter('secret_unlock')" 
                                        class="p-6 border-2 border-purple-200 rounded-xl hover:border-purple-500 hover:bg-purple-50 transition-all text-left">
                                        <div class="flex items-center gap-4 mb-2">
                                            <span class="text-4xl">üèÜ</span>
                                            <div>
                                                <h3 class="text-xl font-bold text-purple-900">Secret Level Unlocked!</h3>
                                                <p class="text-sm text-purple-600">Show off your legendary achievement</p>
                                            </div>
                                        </div>
                                        <div class="text-sm text-gray-500 mt-2">
                                            Celebrate unlocking Grand Slam Winner
                                        </div>
                                    </button>
                                ` : ''}
                                
                                ${state.difficulty === 6 ? `
                                    <button onclick="shareToTwitter('completion')" 
                                        class="p-6 border-2 border-yellow-200 rounded-xl hover:border-yellow-500 hover:bg-yellow-50 transition-all text-left">
                                        <div class="flex items-center gap-4 mb-2">
                                            <span class="text-4xl">üëë</span>
                                            <div>
                                                <h3 class="text-xl font-bold text-yellow-900">Grand Slam Champion</h3>
                                                <p class="text-sm text-yellow-600">Prove you conquered the ultimate challenge</p>
                                            </div>
                                        </div>
                                        <div class="text-sm text-gray-500 mt-2">
                                            Show your Grand Slam Winner completion
                                        </div>
                                    </button>
                                ` : ''}
                            </div>
                            
                            <p class="text-xs text-gray-500 mt-6 text-center">
                                Image will download automatically. Upload it to your tweet!
                            </p>
                        </div>
                    </div>
                `;
            }
            
            // Add level modal overlay if open
            if (state.showLevelModal) {
                app.innerHTML += `
                    <div class="fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center z-50 p-4" onclick="closeLevelModal()">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-6xl w-full max-h-[90vh] overflow-y-auto p-8" onclick="event.stopPropagation()">
                            <div class="flex justify-between items-center mb-6">
                                <h2 class="text-3xl font-bold bg-gradient-to-r from-green-600 to-blue-600 bg-clip-text text-transparent">
                                    Select Difficulty Level
                                </h2>
                                <button onclick="closeLevelModal()" class="text-gray-500 hover:text-gray-700 text-3xl font-bold">√ó</button>
                            </div>
                            <p class="text-gray-600 mb-6">Change will apply after completing current scenario</p>
                            
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                ${difficultyLevels.map(level => `
                                    <div class="border-2 ${state.difficulty === level.level ? 'border-blue-500 bg-blue-50' : 'border-gray-300'} rounded-xl p-6 cursor-pointer hover:shadow-lg transition-all"
                                        onclick="selectLevel(${level.level}); closeLevelModal();">
                                        <div class="flex items-start justify-between mb-3">
                                            <div>
                                                <h3 class="text-xl font-bold text-gray-900">Level ${level.level}: ${level.name}</h3>
                                                <p class="text-sm text-gray-600 mt-1">${level.description}</p>
                                            </div>
                                            <span class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-sm font-semibold">
                                                +${level.baseReward} tokens
                                            </span>
                                        </div>
                                        
                                        <div class="bg-gray-50 rounded-lg p-4 mb-3">
                                            <p class="text-sm text-gray-700">${level.details}</p>
                                        </div>
                                        
                                        <div class="flex gap-4 text-sm">
                                            <div class="flex items-center gap-2">
                                                <span class="text-gray-600">Cards:</span>
                                                <span class="font-semibold">${level.cards}</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-gray-600">Reward:</span>
                                                <span class="font-semibold text-green-600">+${level.baseReward}</span>
                                            </div>
                                            <div class="flex items-center gap-2">
                                                <span class="text-gray-600">Penalty:</span>
                                                <span class="font-semibold text-red-600">-${Math.round(level.baseReward * (0.25 + (level.level - 1) * (0.75 / 9)))}</span>
                                            </div>
                                        </div>
                                    </div>
                                `).join('')}
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Tutorial Modal - only show when in game view (not level select or auth)
            if (state.showTutorial && !state.showAuth) {
                const tutorialContent = getTutorialContent(state.tutorialLevel);
                
                // üåàüé∏ RAINBOW GUITAR: Support new visual step system
                if (tutorialContent.steps) {
                    const currentStep = tutorialContent.steps[state.tutorialStep] || tutorialContent.steps[0];
                    const stepNum = state.tutorialStep + 1;
                    const totalSteps = tutorialContent.totalSteps;
                    
                    // Progress dots
                    const progressDots = Array.from({length: totalSteps}, (_, i) => 
                        i === state.tutorialStep ? '‚óè' : '‚óã'
                    ).join(' ');
                    
                    app.innerHTML += `
                        <div class="tutorial-modal" onclick="closeTutorial()">
                            <div class="tutorial-content" onclick="event.stopPropagation()">
                                <div class="flex justify-between items-start mb-4">
                                    <div>
                                        <h2 class="text-2xl font-bold" style="color: var(--augusta-green);">
                                            üìö ${tutorialContent.title}
                                        </h2>
                                        <div class="text-gray-500 text-lg mt-1">${progressDots} Step ${stepNum}/${totalSteps}</div>
                                    </div>
                                    <button onclick="closeTutorial()" class="text-gray-500 hover:text-gray-700 text-4xl font-bold leading-none">√ó</button>
                                </div>
                                
                                <!-- Visual Section -->
                                <div class="bg-white rounded-lg p-4 mb-4">
                                    <h3 class="text-xl font-bold mb-3" style="color: var(--augusta-green);">${currentStep.title}</h3>
                                    ${currentStep.svg}
                                </div>
                                
                                <!-- Description -->
                                <div class="bg-blue-50 border-l-4 border-blue-600 p-4 mb-4">
                                    <p class="mb-2">${currentStep.description}</p>
                                </div>
                                
                                <!-- Interactive Sliders -->
                                ${currentStep.interactive ? `
                                    <div class="bg-gray-50 rounded-lg p-4 mb-4">
                                        <p class="font-bold mb-3">üéÆ Try It Yourself:</p>
                                        ${currentStep.sliders.map(slider => `
                                            <div class="mb-3">
                                                <label class="block text-sm font-semibold mb-1">${slider.label}: <span id="slider-${slider.id}-display">${slider.default}${slider.unit}</span></label>
                                                <input type="range" min="${slider.min}" max="${slider.max}" value="${slider.default}" 
                                                    class="w-full" 
                                                    oninput="updateTutorialSlider('${slider.id}', this.value, '${slider.unit}')">
                                            </div>
                                        `).join('')}
                                    </div>
                                ` : ''}
                                
                                <!-- Key Point (after sliders) -->
                                <div class="mb-4">
                                    ${currentStep.keyPoint}
                                </div>
                                
                                <!-- Navigation -->
                                <div class="flex gap-3">
                                    ${state.tutorialStep > 0 ? `
                                        <button onclick="previousTutorialStep()" class="flex-1 px-6 py-3 rounded-lg font-semibold bg-gray-300 hover:bg-gray-400 transition">
                                            ‚Üê Back
                                        </button>
                                    ` : ''}
                                    ${state.tutorialStep < totalSteps - 1 ? `
                                        <button onclick="nextTutorialStep()" class="flex-1 px-6 py-3 rounded-lg font-semibold text-white hover:opacity-90 transition" style="background: var(--augusta-green);">
                                            Next ‚Üí
                                        </button>
                                    ` : `
                                        <button onclick="closeTutorial()" class="flex-1 px-6 py-3 rounded-lg font-semibold text-white hover:opacity-90 transition" style="background: var(--augusta-green);">
                                            Got it! üëç
                                        </button>
                                    `}
                                </div>
                                
                                <!-- More Info (collapsible) -->
                                ${tutorialContent.moreInfo ? `
                                    <details class="mt-4">
                                        <summary class="cursor-pointer text-blue-600 font-semibold">‚ìò More Details</summary>
                                        <div class="mt-3">${tutorialContent.moreInfo}</div>
                                    </details>
                                ` : ''}
                            </div>
                        </div>
                    `;
                } else {
                    // OLD FORMAT FALLBACK (for levels not yet updated)
                    app.innerHTML += `
                        <div class="tutorial-modal" onclick="closeTutorial()">
                            <div class="tutorial-content" onclick="event.stopPropagation()">
                                <div class="flex justify-between items-start mb-6">
                                    <h2 class="text-3xl font-bold" style="color: var(--augusta-green);">
                                        üìö ${tutorialContent.title}
                                    </h2>
                                    <button onclick="closeTutorial()" class="text-gray-500 hover:text-gray-700 text-4xl font-bold leading-none">√ó</button>
                                </div>
                                <div class="text-gray-700 space-y-4">
                                    ${tutorialContent.content}
                                </div>
                                <div class="mt-6">
                                    <button onclick="closeTutorial()" class="w-full px-6 py-3 rounded-lg font-semibold text-white hover:opacity-90 transition" style="background: var(--augusta-green);">
                                        Got it! üëç
                                    </button>
                                </div>
                            </div>
                        </div>
                    `;
                }
            }
            
            // Onboarding Modal (First-Time Users)
            if (state.showOnboarding) {
                app.innerHTML += `
                    <div class="fixed inset-0 bg-black bg-opacity-80 flex items-center justify-center z-50 p-4 overflow-y-auto">
                        <div class="bg-white rounded-2xl shadow-2xl max-w-2xl w-full p-6 my-8 max-h-[85vh] overflow-y-auto">
                            
                            <!-- TOP BUTTON -->
                            <button onclick="closeOnboarding()" 
                                class="w-full py-3 text-white rounded-lg font-bold text-lg hover:opacity-90 transition mb-6"
                                style="background: linear-gradient(135deg, var(--augusta-green), var(--augusta-dark));">
                                Got it! üëç Start Playing
                            </button>
                            
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">‚õ≥üèåÔ∏è‚Äç‚ôÇÔ∏è</div>
                                <h2 class="text-3xl md:text-4xl font-bold mb-3" style="color: var(--augusta-green);">
                                    Welcome to Ball Flight Master!
                                </h2>
                                <p class="text-lg md:text-xl text-gray-700">
                                    Master the science behind every golf shot
                                </p>
                            </div>
                            
                            <div class="space-y-4 mb-6">
                                <div class="bg-gradient-to-r from-yellow-50 to-orange-50 border-l-4 border-yellow-500 p-3 md:p-4 rounded">
                                    <h3 class="font-bold text-base md:text-lg mb-2">ü™ô Token System</h3>
                                    <p class="text-xs md:text-sm text-gray-700">
                                        <strong>Earn tokens</strong> by answering correctly. <strong>Lose tokens</strong> for wrong answers (penalties increase with difficulty). 
                                        Start with <span class="font-bold text-yellow-600">100 tokens</span>. Use them to climb the leaderboard!
                                    </p>
                                </div>
                                
                                <div class="bg-gradient-to-r from-purple-50 to-pink-50 border-l-4 border-purple-500 p-3 md:p-4 rounded">
                                    <h3 class="font-bold text-base md:text-lg mb-2">üéØ Confidence Boost</h3>
                                    <p class="text-xs md:text-sm text-gray-700">
                                        Before some scenarios, you can bet on yourself with a <strong>2x or 3x multiplier</strong>. 
                                        Get all cards correct = <span class="font-bold text-purple-600">massive rewards</span>! 
                                        Get one wrong = <span class="font-bold text-red-600">boost lost</span> + penalty.
                                    </p>
                                </div>
                                
                                <div class="bg-gradient-to-r from-green-50 to-blue-50 border-l-4 border-green-500 p-3 md:p-4 rounded">
                                    <h3 class="font-bold text-base md:text-lg mb-2">üìä 5 Levels + Secret Boss</h3>
                                    <p class="text-xs md:text-sm text-gray-700">
                                        Progress from <strong>Range Rookie</strong> to <strong>Masters Champion</strong>. 
                                        Each level introduces new physics data. 
                                        Master Level 5 to unlock... <span class="font-bold text-purple-600">something special</span> üëÄ
                                    </p>
                                </div>
                                
                                <div class="bg-gradient-to-r from-blue-50 to-indigo-50 border-l-4 border-blue-500 p-3 md:p-4 rounded">
                                    <h3 class="font-bold text-base md:text-lg mb-2">üéì Learn Real Physics</h3>
                                    <p class="text-xs md:text-sm text-gray-700">
                                        Every question teaches <strong>TrackMan-level ball flight laws</strong>. 
                                        Tutorials explain each concept. Explanations show full calculations.
                                    </p>
                                </div>
                            </div>
                            
                            <!-- BOTTOM BUTTON -->
                            <button onclick="closeOnboarding()" 
                                class="w-full py-3 text-white rounded-lg font-bold text-lg hover:opacity-90 transition"
                                style="background: linear-gradient(135deg, var(--augusta-green), var(--augusta-dark));">
                                Let's Play! ‚õ≥
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Secret Level Unlock Modal
            if (state.showSecretUnlock) {
                app.innerHTML += `
                    <div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4 animate-fade-in">
                        <div class="bg-gradient-to-br from-yellow-100 via-orange-100 to-red-100 rounded-2xl shadow-2xl max-w-2xl w-full p-8 border-4 border-yellow-500 animate-bounce-in">
                            <div class="text-center mb-6">
                                <div class="text-8xl mb-4 animate-pulse">üèÜ</div>
                                <h2 class="text-5xl font-bold mb-4" style="color: var(--augusta-green); text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                                    LEGENDARY ACHIEVEMENT!
                                </h2>
                                <p class="text-2xl font-bold text-gray-800 mb-2">
                                    You've mastered the Masters Champion level!
                                </p>
                                <p class="text-lg text-gray-600">
                                    4 Perfect Scenarios Completed ‚ú®
                                </p>
                            </div>
                            
                            <div class="bg-black/10 rounded-xl p-6 mb-6 border-2 border-yellow-600">
                                <div class="text-center mb-4">
                                    <p class="text-2xl font-bold text-gray-800 mb-3">
                                        A secret challenge awaits...
                                    </p>
                                </div>
                                
                                <div class="bg-gradient-to-r from-purple-900 to-red-900 text-white rounded-lg p-6 shadow-2xl">
                                    <div class="text-4xl font-bold text-center mb-2">
                                        üèÜ GRAND SLAM WINNER üèÜ
                                    </div>
                                    <p class="text-center text-lg mb-4">
                                        The Ultimate Test of Golf Physics Mastery
                                    </p>
                                    <div class="grid grid-cols-2 gap-3 text-sm">
                                        <div class="bg-white/10 rounded p-2">
                                            <div class="font-bold">‚ö° 4 Cards</div>
                                            <div class="text-xs opacity-80">per scenario</div>
                                        </div>
                                        <div class="bg-white/10 rounded p-2">
                                            <div class="font-bold">üå™Ô∏è Extreme</div>
                                            <div class="text-xs opacity-80">25mph winds</div>
                                        </div>
                                        <div class="bg-white/10 rounded p-2">
                                            <div class="font-bold">üí∞ Triple</div>
                                            <div class="text-xs opacity-80">1500 tokens</div>
                                        </div>
                                        <div class="bg-white/10 rounded p-2">
                                            <div class="font-bold">üéØ Brutal</div>
                                            <div class="text-xs opacity-80">2-yard ranges</div>
                                        </div>
                                    </div>
                                </div>
                                
                                <!-- üíéüîî DIAMOND WHISTLE: Share buttons for secret unlock -->
                                <div class="mt-6 p-4 bg-white/50 rounded-lg">
                                    <p class="text-center text-sm font-bold text-gray-700 mb-3">Share Your Achievement:</p>
                                    <div class="flex gap-2 justify-center">
                                        <button onclick="shareSecretUnlock('native')" 
                                            class="px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition flex items-center gap-2">
                                            üì± Share
                                        </button>
                                        <button onclick="shareSecretUnlock('twitter')" 
                                            class="px-4 py-2 bg-black text-white rounded-lg font-bold hover:bg-gray-800 transition flex items-center gap-2">
                                            ùïè Tweet
                                        </button>
                                        <button onclick="shareSecretUnlock('facebook')" 
                                            class="px-4 py-2 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800 transition flex items-center gap-2">
                                            üëç Facebook
                                        </button>
                                        <button onclick="shareSecretUnlock('copy')" 
                                            class="px-4 py-2 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 transition flex items-center gap-2">
                                            üìã Copy
                                        </button>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="flex gap-4">
                                <button onclick="closeSecretUnlock()" 
                                    class="flex-1 py-4 bg-gray-500 text-white rounded-lg font-bold text-lg hover:bg-gray-600 transition">
                                    Not Yet
                                </button>
                                <button onclick="acceptSecretLevel()" 
                                    class="flex-1 py-4 text-white rounded-lg font-bold text-lg hover:opacity-90 transition shadow-lg"
                                    style="background: linear-gradient(135deg, var(--augusta-green), var(--augusta-dark));">
                                    üèÜ Face the Challenge!
                                </button>
                            </div>
                        </div>
                    </div>
                `;
                return;
            }
            
            // üëëü¶© FLAMINGO CROWN: Level 6 Complete Share Modal
            if (state.showLevel6CompleteModal) {
                const perfectCount = state.totalPerfectScenarios;
                const bestStreak = state.user.bestStreak || 0;
                
                app.innerHTML += `
                    <div class="fixed inset-0 bg-black bg-opacity-90 flex items-center justify-center z-50 p-4 animate-fade-in">
                        <div class="bg-gradient-to-br from-yellow-100 via-gold-100 to-orange-100 rounded-2xl shadow-2xl max-w-2xl w-full p-8 border-4 border-yellow-500 animate-bounce-in">
                            <div class="text-center mb-6">
                                <div class="text-8xl mb-4 animate-pulse">üèÜ</div>
                                <h2 class="text-5xl font-bold mb-4" style="color: var(--augusta-green); text-shadow: 2px 2px 4px rgba(0,0,0,0.2);">
                                    GRAND SLAM WINNER!
                                </h2>
                                <p class="text-2xl font-bold text-gray-800 mb-4">
                                    You've mastered professional-level golf ball flight physics!
                                </p>
                            </div>
                            
                            <div class="bg-white/50 rounded-xl p-6 mb-6 border-2 border-yellow-600">
                                <p class="text-center text-xl font-bold text-gray-800 mb-4">
                                    Your Final Stats:
                                </p>
                                <div class="grid grid-cols-2 gap-4 mb-4">
                                    <div class="bg-green-100 rounded-lg p-4 text-center border-2 border-green-500">
                                        <div class="text-4xl font-bold text-green-700">${perfectCount}</div>
                                        <div class="text-sm text-gray-700">Perfect Scenarios</div>
                                    </div>
                                    <div class="bg-purple-100 rounded-lg p-4 text-center border-2 border-purple-500">
                                        <div class="text-4xl font-bold text-purple-700">${bestStreak}</div>
                                        <div class="text-sm text-gray-700">Best Streak</div>
                                    </div>
                                </div>
                                <p class="text-center text-lg font-bold text-gray-700">
                                    üéØ You're the Tiger Woods of ball flight! ‚õ≥
                                </p>
                            </div>
                            
                            <div class="bg-blue-50 rounded-lg p-4 mb-6 border-2 border-blue-400">
                                <p class="text-center text-sm font-bold text-gray-700 mb-3">Challenge Your Friends:</p>
                                <div class="flex flex-wrap gap-2 justify-center">
                                    <button onclick="shareLevel6Complete('native')" 
                                        class="px-4 py-2 bg-blue-500 text-white rounded-lg font-bold hover:bg-blue-600 transition flex items-center gap-2">
                                        üì± Share
                                    </button>
                                    <button onclick="shareLevel6Complete('twitter')" 
                                        class="px-4 py-2 bg-black text-white rounded-lg font-bold hover:bg-gray-800 transition flex items-center gap-2">
                                        ùïè Tweet
                                    </button>
                                    <button onclick="shareLevel6Complete('facebook')" 
                                        class="px-4 py-2 bg-blue-700 text-white rounded-lg font-bold hover:bg-blue-800 transition flex items-center gap-2">
                                        üëç Facebook
                                    </button>
                                    <button onclick="shareLevel6Complete('copy')" 
                                        class="px-4 py-2 bg-gray-600 text-white rounded-lg font-bold hover:bg-gray-700 transition flex items-center gap-2">
                                        üìã Copy
                                    </button>
                                </div>
                            </div>
                            
                            <button onclick="closeLevel6CompleteModal()" 
                                class="w-full py-4 text-white rounded-lg font-bold text-lg hover:opacity-90 transition shadow-lg"
                                style="background: linear-gradient(135deg, var(--augusta-green), var(--augusta-dark));">
                                Continue Playing! üéÆ
                            </button>
                        </div>
                    </div>
                `;
                return;
            }
            
            // Level-Up Promotion Modal
            if (state.showLevelUpPromotion) {
                const nextLevel = state.promotionTargetLevel;
                const levelInfo = difficultyLevels[nextLevel - 1];
                const currentPerf = state.levelPerformance[state.difficulty];
                const overallAcc = Math.round((currentPerf.correct / currentPerf.total) * 100);
                
                app.innerHTML += `
                    <div class="fixed inset-0 bg-black bg-opacity-70 flex items-center justify-center z-50 p-4">
                        <div class="bg-gradient-to-br from-yellow-50 to-orange-50 rounded-2xl shadow-2xl max-w-lg w-full p-8 border-4 border-yellow-400">
                            <div class="text-center mb-6">
                                <div class="text-6xl mb-4">üéØ</div>
                                <h2 class="text-3xl font-bold mb-2" style="color: var(--augusta-green);">
                                    You're Ready to Level Up!
                                </h2>
                                <p class="text-gray-600 text-lg">
                                    You're crushing Level ${state.difficulty}!
                                </p>
                            </div>
                            
                            <div class="bg-white rounded-lg p-5 mb-6 shadow-inner">
                                <h3 class="font-bold text-lg mb-3 text-center text-gray-800">Your Performance:</h3>
                                <div class="grid grid-cols-2 gap-4 text-center">
                                    <div class="bg-green-50 rounded-lg p-3">
                                        <div class="text-3xl font-bold text-green-600">${currentPerf.scenarios}</div>
                                        <div class="text-sm text-gray-600">Scenarios</div>
                                    </div>
                                    <div class="bg-blue-50 rounded-lg p-3">
                                        <div class="text-3xl font-bold text-blue-600">${overallAcc}%</div>
                                        <div class="text-sm text-gray-600">Accuracy</div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="bg-gradient-to-r from-green-50 to-blue-50 rounded-lg p-5 mb-6 border-2 border-green-200">
                                <h3 class="font-bold text-lg mb-2 text-center">Ready for Level ${nextLevel}:</h3>
                                <p class="text-center font-bold text-xl mb-2" style="color: var(--augusta-green);">${levelInfo.name}</p>
                                <p class="text-center text-gray-600 text-sm">${levelInfo.description}</p>
                                <p class="text-center text-sm mt-3 text-gray-500">${levelInfo.details}</p>
                            </div>
                            
                            <div class="flex gap-3">
                                <button onclick="declinePromotion()" class="flex-1 py-3 px-4 bg-gray-300 text-gray-700 rounded-lg font-semibold hover:bg-gray-400 transition">
                                    Not Yet
                                </button>
                                <button onclick="acceptPromotion()" class="flex-1 py-3 px-4 bg-gradient-to-r from-green-600 to-blue-600 text-white rounded-lg font-semibold hover:from-green-700 hover:to-blue-700 transition">
                                    Level Up! üöÄ
                                </button>
                            </div>
                        </div>
                    </div>
                `;
            }
            
            // Add event listener for AI question input
            if (state.showExplanation) {
                const aiInput = document.getElementById('aiQuestion');
                if (aiInput) {
                    aiInput.addEventListener('input', e => {
                        state.aiQuestion = e.target.value;
                    });
                }
            }
        }

        function handleLogin() {
            if (state.username.trim()) {
                state.user = {
                    name: state.username,
                    tokens: 100,
                    questionsAnswered: 0,
                    correctAnswers: 0,
                    currentStreak: 0,
                    bestStreak: 0
                };
                state.showAuth = false;
                state.showLevelSelect = true;
                
                // Show onboarding for first-time users
                if (state.isFirstTime) {
                    state.showOnboarding = true;
                    state.isFirstTime = false;
                }
                
                render();
            }
        }

        function handleAnswer(answer) {
            // Hide confidence boost countdown once answer is selected
            if (state.showConfidenceBoost) {
                state.showConfidenceBoost = false;
                if (state.boostTimer) {
                    clearInterval(state.boostTimer);
                    state.boostTimer = null;
                }
            }
            
            state.selectedAnswer = answer;
            const card = state.currentScenarioData.cards[state.currentCard - 1];
            state.isCorrect = answer === card.correct;
            state.showExplanation = true;
            
            // If this is the effective face question, set flag to show effective face in subsequent cards
            if (card.question && card.question.includes("effective face angle after applying the lie adjustment")) {
                state.effectiveFaceShown = true;
            }
            
            // Track boost progress if active
            if (state.hasUsedBoost && !state.boostLost) {
                state.boostCardResults.push(state.isCorrect);
                if (!state.isCorrect) {
                    state.boostLost = true;
                }
            }
            
            // UPDATE MOMENTUM SYSTEM
            state.levelProgress.questionsAnswered++;
            
            if (state.isCorrect) {
                state.levelProgress.questionsCorrect++;
                state.levelProgress.currentStreak++;
                
                // Update longest streak
                if (state.levelProgress.currentStreak > state.levelProgress.longestStreak) {
                    state.levelProgress.longestStreak = state.levelProgress.currentStreak;
                }
                
                // Update momentum (1-5 flames based on streak)
                state.levelProgress.momentum = Math.min(5, state.levelProgress.currentStreak);
                
                // Calculate progress gain
                const baseGain = 4; // 4% base per correct answer
                const momentumBonus = state.levelProgress.momentum - 1; // 0-4% bonus
                const totalGain = baseGain + momentumBonus;
                
                // Add to progress (cap at 100)
                state.levelProgress.progressPercent = Math.min(100, 
                    state.levelProgress.progressPercent + totalGain);
                
                // Check if ready to level up
                if (state.levelProgress.progressPercent >= 100 && !state.levelProgress.readyForNextLevel) {
                    state.levelProgress.readyForNextLevel = true;
                    // Level-up modal will show after this scenario completes
                }
                
            } else {
                // Wrong answer: reset streak but momentum stays at 1 (never 0)
                state.levelProgress.currentStreak = 0;
                state.levelProgress.momentum = 1;
            }
            
            render();
        }

        function handleNext() {
            const totalCards = difficultyLevels[state.difficulty - 1].cards;
            const baseReward = difficultyLevels[state.difficulty - 1].baseReward;
            
            // Determine if boost applies (only on last card of scenario)
            let multiplier = 1;
            let allCardsCorrect = false;
            
            if (state.currentCard >= totalCards && state.hasUsedBoost) {
                // Check if ALL cards were correct
                allCardsCorrect = state.boostCardResults.every(result => result === true) && state.boostCardResults.length === totalCards;
                if (allCardsCorrect && !state.boostLost) {
                    multiplier = state.confidenceMultiplier;
                }
            }
            
            // Calculate reward or penalty
            let reward = 0;
            if (state.isCorrect) {
                reward = baseReward * multiplier;
            } else {
                // Progressive penalty: 25% at level 1, scaling to 100% at level 5
                const penaltyPercent = 0.25 + (state.difficulty - 1) * (0.75 / 4);
                reward = -Math.round(baseReward * penaltyPercent);
            }
            
            state.user.tokens = Math.max(0, state.user.tokens + reward);
            state.user.questionsAnswered++;
            state.user.correctAnswers += state.isCorrect ? 1 : 0;
            state.user.currentStreak = state.isCorrect ? state.user.currentStreak + 1 : 0;
            
            // Update best streak
            if (state.user.currentStreak > state.user.bestStreak) {
                state.user.bestStreak = state.user.currentStreak;
            }
            
            if (state.isCorrect) {
                saveScore();
            }
            
            // CRITICAL: Check if we're on the last card
            const isLastCard = (state.currentCard >= totalCards);
            
            if (!isLastCard) {
                // Move to next card in same scenario
                state.currentCard++;
            } else {
                // Scenario complete - track performance
                const scenarioCorrect = state.boostCardResults.filter(r => r).length;
                const scenarioTotal = state.boostCardResults.length;
                trackLevelPerformance(state.difficulty, scenarioCorrect, scenarioTotal);
                
                // ü•ú PEANUT BUTTER: Track ALL perfect scenarios for sharing stats
                if (scenarioCorrect === scenarioTotal && scenarioTotal > 0) {
                    state.totalPerfectScenarios++;
                }
                
                // Track perfect scenarios on Level 5 for secret unlock
                if (state.difficulty === 5 && scenarioCorrect === scenarioTotal && scenarioTotal > 0) {
                    state.perfectScenariosLevel5++;
                    
                    // Check for secret level unlock (4 perfect scenarios)
                    if (state.perfectScenariosLevel5 >= 4 && !state.secretLevelUnlocked) {
                        state.secretLevelUnlocked = true;
                        state.showSecretUnlock = true;
                    }
                }
                
                // ü•ú PEANUT BUTTER: Check for Level 6 completion (show share modal)
                if (state.difficulty === 6 && scenarioCorrect === scenarioTotal && scenarioTotal > 0) {
                    state.showLevel6CompleteModal = true;
                }
                
                // Check for level-up promotion
                if (checkLevelPromotion(state.difficulty)) {
                    showLevelUpPromotion(state.difficulty + 1);
                }
                
                // START NEW SCENARIO
                state.scenarioNumber++;
                state.currentCard = 1;
                state.currentScenarioData = generateScenario(state.difficulty);
                // Reset boost tracking for new scenario
                state.confidenceMultiplier = 1;
                state.hasUsedBoost = false;
                state.boostCardResults = [];
                state.boostLost = false;
                state.effectiveFaceShown = false; // Reset for new scenario
                // Potentially show confidence boost for next scenario
                maybeShowConfidenceBoost();
            }
            
            state.selectedAnswer = null;
            state.showExplanation = false;
            state.isCorrect = null;
            render();
        }

        async function handleAskAI() {
            if (!state.aiQuestion || !state.aiQuestion.trim() || !state.currentScenarioData) return;
            
            state.isAskingAI = true;
            render();
            
            try {
                const card = state.currentScenarioData.cards[state.currentCard - 1];
                const dataStr = Object.entries(state.currentScenarioData.data)
                    .map(([key, value]) => key + ": " + value)
                    .join('\n');
                
                const response = await fetch("https://api.anthropic.com/v1/messages", {
                    method: "POST",
                    headers: {
                        "Content-Type": "application/json",
                    },
                    body: JSON.stringify({
                        model: "claude-sonnet-4-20250514",
                        max_tokens: 1000,
                        messages: [{
                            role: "user",
                            content: `You are a golf physics expert helping a student understand ball flight. Here is the current scenario data:\n\n${dataStr}\n\nCurrent Question: ${card.question}\n\nStudent's Question: ${state.aiQuestion}\n\nProvide a helpful, educational response that explains the physics concepts without directly giving away the answer. Help them understand how to think about the problem.`
                        }],
                    })
                });

                const data = await response.json();
                const aiText = data.content?.find(item => item.type === "text")?.text || "I couldn't generate a response. Please try again.";
                state.aiResponse = aiText;
            } catch (error) {
                state.aiResponse = "Sorry, I encountered an error. The AI feature requires an API key to work when self-hosted.";
            } finally {
                state.isAskingAI = false;
                render();
            }
        }

        function toggleDifficulty() {
            state.showLevelModal = !state.showLevelModal;
            render();
        }

        function closeLevelModal() {
            state.showLevelModal = false;
            render();
        }

        function changeDifficulty(level) {
            state.difficulty = parseInt(level);
            state.currentScenarioData = generateScenario(state.difficulty);
            state.currentCard = 1;
            state.scenarioNumber = 1;
            state.selectedAnswer = null;
            state.showExplanation = false;
            render();
        }

        // Initial render
        render();
    </script>
</body>
</html>
